---
title: "CPMG_preprocessing_DiabOb"
author: "nminaee"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("~/Desktop/Diabetes_Obesity")
```



```{r}
# remotes::install_github("jwist/fusion")
# install.packages("devtools")
library(fusion)
#remotes::install_github("tkimhofer/metabom8")
library(metabom8)  
devtools::load_all("~/nmr-spectra-processing/")
library(ropls)
library(dplyr)
```

## Load CPMG Diabetes & Obesity Data
```{r}
cpmg <- local(get(load("~/Desktop/Diabetes_Obesity/DiaObesity_CPMG.daE")))

```

## Load Annotation Data 
```{r}
anno <- local(get(load("~/Desktop/Diabetes_Obesity/DiaObesity_ANNO.daE")))

# trying to see how many samples in the annotation data initially to compare with ann_final.csv from Sam later on. 
# ANNO <-  anno@obsDescr[[1]]
# idx.LTR2=which(ANNO$`NEW Randomised Number` %in% c('QC 1','QC2','QC3','QC4'))
# ANNO_noLTR=ANNO[-idx.LTR2,]
# write.csv(ANNO_noLTR, file = 'orig_anno_noLTR_CPMG_24052023.csv')

```


```{r}
X = cpmg@.Data
meta=cpmg@obsDescr[[1]]
ppm<-as.numeric(colnames(X))

eretic<- meta$eretic

ann = anno@obsDescr[[1]]

#matching the annotation file fo the meta file
ann$sampleID
meta$sampleID

# checking which samples in meta that are in anno file
idx=which(meta$sampleID %in% ann$sampleID)
# reduce dimension of meta to match anno 
meta_red=meta[idx,]
X_red=X[idx,]

dim(X_red)
#[1]    301 131072


# check if X_red and meta_red rownames matched. X and meta should match. Now the task is to match them with anno file
table(rownames(X_red) == rownames(meta_red))
# TRUE 
#  301 
# GOOD THEY MATCHED. 


# checking which sampels in anno that are in meta_red 
idx2=which(ann$sampleID %in% meta_red$sampleID)
# reduce dimension of anno to match meta
ann_red=ann[idx2,]

# match meta_red and anno
idx_match=match(meta_red$sampleID, ann_red$sampleID)
ann_final=ann_red[idx_match,]

table(ann_final$sampleID==meta_red$sampleID)
# TRUE 
#  301

table(rownames(meta_red) == rownames(X_red))
# TRUE 
#  301

### NOTE TO SELF: REMEMBER X_red and meta_red are MATCHED on rownames; meta_red and ann_final are MATCHED on sampleID. 


#remove sample ID SAUD_185 from dataset, removed due to poor water suppression
idx.SAUD185=which(ann_final$sampleID %in% c('SAUD_185'))
#idx2.SAUD185=which(meta_red$sampleID == 'SAUD_185') # good they are the same index
ann_final=ann_final[-idx.SAUD185,]
X_red=X_red[-idx.SAUD185,]
meta_red=meta_red[-idx.SAUD185,]

dim(X_red)
#[1]    300 131072

#making sure SAUD_185 has been removed from the spectra 
#matspec(X_red, ppm, shift = c(4, 5), interactive=F)

save(ann_final, meta_red, X_red ,ppm, file='Matched_CPMG_17082023.Rdata')

#load('Matched_CPMG_17082023.Rdata')

#scaling by eretic factor

meta_red$eretic<- as.numeric(meta_red$eretic)

cpmg_eretic = X_red/meta_red$eretic

dim(cpmg_eretic)
#[1]    300 131072

rm(ann, ann_red, meta)

#Processing the data

#calibration to glucose
cpmg_eretic[is.na(cpmg_eretic)]=0
Xc=calibrate(cpmg_eretic,ppm, type='glucose' )

#matspec(Xc, ppm, shift=c(5.0, 6.0), interactive=F)
dim(Xc)
#[1]    300 131072
rownames(Xc)=rownames(cpmg_eretic)
#rownames(Xc)
colnames(Xc)=colnames(cpmg_eretic)
#colnames(Xc)


#### trying Andres' code ####
# xc2 <- calibrateSpectra(rev(ppm), apply(cpmg_eretic,1,rev), rOref = c(5.3, 5.2))
# matspec(xc2,rev(ppm),shift=c(5.2,5.3))
# save(cpmg_eretic, file="cpmg_eretic.rda") # for Andres to test 
# save(ppm, file="ppm.rda")  # for Andres
############################


#remove water
#matspec(Xc,ppm, shift = c(4.0, 5.5))

idx.water=get_idx(range=c(4.3,5.0), ppm)

Xs=Xc[,-idx.water]
dim(Xs)
#[1]    300 126485

ppms=ppm[-idx.water]
length(ppms)
#[1] 126485
rm(idx.water)

#spec(Xs[1,],ppms)

#matspec(Xs,ppms, shift = c(10.0, 14.0))

#remove TSP
min(ppm)
max(ppm)

idx.tsp=get_idx(range=c(min(ppms),0.4),ppms)
head(idx.tsp)
Xs1=Xs[,-idx.tsp]
ppms1=ppms[-idx.tsp]

dim(Xs1)
#[1]   300 89215

length(ppms1)
#[1] 89215

rm(idx.tsp)

#remove ends of spectrum 
idx.end=get_idx(range=c(9.0,max(ppms1)),ppms1)

Xs2=Xs1[,-idx.end]
ppms2=ppms1[-idx.end]
dim(Xs2)
#[1]   300 51767
length(ppms2)
#[1] 51767

rm(idx.end)
```

```{r}
#Baseline correction

Xbl=bcor(Xs2)


rm(Xs, Xs1, Xs2)

```


```{r}
#add in a column to join sample time point and group :)

#ann_final$week.diet = gsub("\\s","", paste(ann_final$sampleTimePoint,"_", ann_final$BioMood.group))


#PCA with all samples

# mod=pca(Xbl)
# 
# plotscores(mod)
# plotscores(mod, an =list(Patient=factor(ann_final$sampleID)))
# plotscores(mod, an =list(Patient=factor(ann_final$`Sample Class`),'',Label=factor(ann_final$sampleID)))
# plotscores(mod, an =list(Patient=factor(ann_final$sampleTimePoint),Label=factor(ann_final$BioMood.group),Patient=factor(ann_final$BMIprepreg)))
# 
# plotload(mod, pc = 1)
# plotload(mod, pc = 2)




#remove the 4 QC samples
idx.LTR=which(ann_final$`NEW Randomised Number` %in% c('QC 1','QC2','QC3','QC4'))
ann_finalorig = ann_final
ann_final=ann_finalorig[-idx.LTR,]
Xbl=Xbl[-idx.LTR,]

rm(idx.LTR)

#make the extra columns to easily distinguish groups
ann_final$DM1 = "FALSE"
ann_final$DM1[which(ann_final$`Sample Class` %in% c('1'))] = "TRUE"


ann_final$DM2 = "FALSE"
ann_final$DM2[which(ann_final$`Sample Class` %in% c('2'))] = "TRUE"


ann_final$diabetes = "FALSE"
ann_final$diabetes[which(ann_final$DM1 %in% c('TRUE'))] = "TRUE"
ann_final$diabetes[which(ann_final$DM2 %in% c('TRUE'))] = "TRUE"


ann_final$BMIcut = ""
ann_final$BMIcut[which(ann_final$BMI>18.49 &ann_final$BMI <25 )] = "Healthy weight"
ann_final$BMIcut[which(ann_final$BMI>25 &ann_final$BMI <30 )] = "Overweight"
ann_final$BMIcut[which(ann_final$BMI>30)] = "Obese"

ann_final$BMIcut1 = ""
ann_final$BMIcut1[which(ann_final$BMIcut %in% c('Healthy weight'))] = "Healthy weight"
ann_final$BMIcut1[which(ann_final$BMIcut %in% c('Overweight'))] = "Overweight to severly obese"
ann_final$BMIcut1[which(ann_final$BMIcut %in% c('Obese'))] = "Overweight to severly obese"

ann_final$comb = ""
ann_final$comb[which(ann_final$diabetes %in% c('FALSE'))] = "NO DM"
ann_final$comb[which(ann_final$DM1 %in% c('TRUE'))] = "DM1"
ann_final$comb[which(ann_final$DM2 %in% c('TRUE'))] = "DM2"

ann_final$Groupmeta = gsub("\\s","", paste(ann_final$comb,"_", ann_final$BMIcut1))

ann_final$WHO_BMI = ""
ann_final$WHO_BMI[which(ann_final$BMI>18.49 &ann_final$BMI <25 )] = "Normal weight"
ann_final$WHO_BMI[which(ann_final$BMI>24.99 &ann_final$BMI <30 )] = "Pre-Obesity"
ann_final$WHO_BMI[which(ann_final$BMI>30 &ann_final$BMI <35 )] = "Obesity Class I"
ann_final$WHO_BMI[which(ann_final$BMI>34.99 &ann_final$BMI <40 )] = "Obesity Class II"
ann_final$WHO_BMI[which(ann_final$BMI>39.99 )] = "Obesity Class III"

#remove SAUD_257 as BMI is underweight

idx.SAUD257=which(ann_final$sampleID %in% c('SAUD_257'))
ann_final=ann_final[-idx.SAUD257,]
Xbl=Xbl[-idx.SAUD257,]

rm(idx.SAUD257)

ann_final$Weight_diabetes = gsub("\\s","", paste(ann_final$WHO_BMI,"_", ann_final$diabetes))

table(ann_final$Weight_diabetes)
# Normalweight_FALSE     Normalweight_TRUE   ObesityClassI_FALSE    ObesityClassI_TRUE  ObesityClassII_FALSE   ObesityClassII_TRUE 
#                    59                    57                    19                    43                    18                    18 
# ObesityClassIII_FALSE  ObesityClassIII_TRUE     Pre-Obesity_FALSE      Pre-Obesity_TRUE 
#                    20                    14                    20                    27 


#remove the six high glucose no DM people - SAM's 
# idx.out=which(ann_final$sampleID %in% c('SAUD_44','SAUD_155','SAUD_156','SAUD_170','SAUD_175','SAUD_187','SAUD_218','SAUD_290'))
# ann_final=ann_final[-idx.out,]
# Xbl=Xbl[-idx.out,]

#Glucose concentration cut off has been increased from 6.8 to 7mmol/L 
#from 8 people now only has to remove the 6 high glucose no DM people - Novia's 
idx.out=which(ann_final$sampleID %in% c("SAUD_44",  "SAUD_156", "SAUD_170", "SAUD_187", "SAUD_218", "SAUD_290"))
ann_final=ann_final[-idx.out,]
Xbl=Xbl[-idx.out,]


dim(ann_final)
#[1] 289  54

dim(Xbl) 
#[1]   289 51767

ann_finalCPMG <- ann_final
Xbl_CPMG <- Xbl

rm(ann_final, Xbl)

write.csv(ann_finalCPMG, file = 'ann_final_CPMG_30082023.csv')
save(Xbl_CPMG, file = "CPMG_final_30082023.rda")
save(ann_finalCPMG, Xbl_CPMG, ppms2, file = 'Matched_CPMG_ANNO_FINAL_3008082023.rda')

```


# working out unknown compound 
```{r}
idx <- which(rownames(meta_red) %in% rownames(Xbl))
meta_final <- meta_red[idx, ]

table(meta_final$sampleID == ann_final$sampleID)
#TRUE 
# 289 

table(rownames(meta_final) == rownames(Xbl)) 
#TRUE 
# 289

ann_final$comb = ""
ann_final$comb[which(ann_final$diabetes %in% c('FALSE'))] = "NO DM"
ann_final$comb[which(ann_final$DM1 %in% c('TRUE'))] = "DM1"
ann_final$comb[which(ann_final$DM2 %in% c('TRUE'))] = "DM2"

ann_final$BMIcut = ""
ann_final$BMIcut[which(ann_final$BMI>18.49 &ann_final$BMI <25 )] = "Healthy weight"
ann_final$BMIcut[which(ann_final$BMI>25 &ann_final$BMI <30 )] = "Overweight"
ann_final$BMIcut[which(ann_final$BMI>30)] = "Obese"

ann_final$BMI_fig1 = ""
ann_final$BMI_fig1[which(ann_final$BMI>18.49 &ann_final$BMI <25 )] = "Normal weight"
ann_final$BMI_fig1[which(ann_final$BMI>24.99 &ann_final$BMI <30 )] = "Overweight"
ann_final$BMI_fig1[which(ann_final$BMI>30 &ann_final$BMI <40 )] = "Obese"
ann_final$BMI_fig1[which(ann_final$BMI>39.99 )] = "Severely obese"

ann_final$fig1 = gsub("\\s","", paste(ann_final$BMIcut,"_", ann_final$comb))


idx.ObNODM <- which(ann_final$fig1 =='Obese_NODM')
length(idx.ObNODM)
#[1] 53

ann_ObNODM=ann_final[idx.ObNODM,]
Xbl_ObNODM=Xbl[idx.ObNODM,]
meta_ObNODM=meta_final[idx.ObNODM, ]

metabom8::matspec(Xbl_ObNODM[1:5, ], ppms2, shift = c(1.15, 1.2))
metabom8::spec(Xbl[81, ], ppms2, shift = c(1.15, 1.2)) # "SAUD_8"
metabom8::spec(Xbl[31, ], ppms2, shift = c(1.15, 1.2)) # "SAUD_3"

Xbl_831 <- rbind(Xbl[81, ], Xbl[31, ])
metabom8::matspec(Xbl_831, ppms2)

metabom8::matspec(Xbl[1:5, ], ppms2, shift = c(1.95, 2.15))

driver = 2.03429
stocsy_model = metabom8::stocsy(Xbl, ppms2, driver)
metabom8::plotStocsy(stocsy_model, shift =c(4.5, 3.3))

```


# SOM 

```{r}
load('Matched_CPMG_ANNO_FINAL_30082023.rda')

```


```{r}
# Selecting just 0.5-2.95ppm
# ppm=as.numeric(colnames(Xbl))
# idx=get_idx(range=c(0.5, 2.95), ppm)
# Xbl_cut=Xbl[,idx]
# dim(Xbl_cut)
# #[1]   287 16054
# 
# ppms=ppm[idx]
# rm(idx)


# Doing SOM with Full CPMG Spectra (23/08/2023)
# using ppms2 (the excised one)
dim(Xbl_CPMG)
#[1]   287 51767
```


## 4x3 SOM
```{r}
# Unsupervised SOM 
library(kohonen)
library(janitor)
set.seed(7)

# 4x3 SOM
load("Matched_CPMG_ANNO_FINAL_30082023.rda")

cpmg.som <- som(Xbl_CPMG, grid = somgrid(4, 3, "hexagonal"))
ann_finalCPMG$classif <- cpmg.som$unit.classif

# the proportion of diabetes vs BMI vs node classification
table(ann_finalCPMG$classif, ann_finalCPMG$comb, ann_finalCPMG$BMIcut1)
```


```{r}
# Setting colour palettes
bgcols1 = c("red", "black", "cyan") 

bgcols2 = c("red", "cyan", "purple", "green3", "orange", "black") 

c2 = c("black", "red") 

c16 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "orchid1", "blue1"
)
```


```{r}
# spectra loading plot 
plot(cpmg.som, type = "codes", main="CPMG SOM 4x3 Full Spectra Loadings")


#BMI - black = Healthy weight; red = overweight/obese
plot(cpmg.som, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], pch=19, main="CPMG SOM 4x3 Full Spectra Coloured by BMI")


# doing 2-way cross-tab between BMI status vs. SOM (Node) classification
data <- table(ann_finalCPMG$BMIcut1, ann_finalCPMG$classif)

data %>%
  as.data.frame.matrix() %>%
  tibble::rownames_to_column() %>%
  adorn_totals(name = 'TOTAL') %>%
  adorn_totals(name = 'TOTAL', where = 'col')



#DM Status - blue=NoDM, red=DM1, black=DM2
plot(cpmg.som, type = "mapping", col = bgcols1[factor(ann_finalCPMG$comb)], pch=19, main="CPMG SOM 4x3 Full Spectra Coloured by Diabetes Status")


# doing 2-way cross-tab between Diabetes status and SOM (Node) classification
data <- table(ann_finalCPMG$comb, ann_finalCPMG$classif)

data %>%
  as.data.frame.matrix() %>%
  tibble::rownames_to_column() %>%
  adorn_totals(name = 'TOTAL') %>%
  adorn_totals(name = 'TOTAL', where = 'col')



#Combination of BMI and DM Status 
#red=DM1_healthyweight, blue=DM1_Overweighttoseverlyobese, purple=DM2_healthyweight
#green=DM2_overweighttoseverlyobese, orange=NODM_healthyweight, black=NODM_overweighttoseverlyobese
plot(cpmg.som, type = "mapping", col = bgcols2[factor(ann_finalCPMG$Groupmeta)], pch=19, main="CPMG SOM 4x3 Full Spectra Coloured by the Combination of BMI and Diabetes Status")


# doing 2-way cross-tab between Diabetes status and SOM (Node) classification
data <- table(ann_finalCPMG$Groupmeta, ann_finalCPMG$classif)

data %>%
  as.data.frame.matrix() %>%
  tibble::rownames_to_column() %>%
  adorn_totals(name = 'TOTAL') %>%
  adorn_totals(name = 'TOTAL', where = 'col')


```

# mva-plots & nmr-spectra-processing
```{r}
functionDir <- "~/git/mva-plots/R/"
functionList <- list.files(path = functionDir)
for(i in functionList){
  source(paste0(functionDir,i))
}

devtools::load_all("~/nmr-spectra-processing/")
```

```{r}
loadPackages(myPackages = c("ggplot2",
                            "stats",
                            "ggpmisc",
                            "ggplotly",
                            "plotly",
                            "prcomp", 
                            "tidyverse", 
                            "ggpubr",
                            "GGally",
                            "cowplot",
                            "gridExtra",
                            #"rlist",
                            "ggrepel",
                            "ellipse",
                            "HotellingEllipse",
                            "sp"))
```

```{r}
# Andres' nmrLoadingsPlot function

library(colorRamps)

nmrLoadingsPlot <- function(model,ppm,X,roi,pc=1,breaks = 10){
  if (missing(roi)){
    roi <- TRUE
  } else{
    if (is.numeric(roi)) 
      roi <- ppm >= roi[1] & ppm <= roi[2]
  } 
  if ("prcomp" %in% is(model)){ 
    scaling <- model$scale  
    loading <- model$rotation[,pc]
  } else{   
    if ("opls" %in% is(model)){   
      if (missing(X)){
        cat(crayon::red("nmrLoadingsPlot >>","opls needs original data X" 
                        ,"to backscale"))
        stop()  
      }
      #Need to check actual scaling of opls to backsacle accordingly  
      scaling <- apply(X,2,sd)#[roi]
      loading <- ropls::getLoadingMN(model)[,pc]#[roi]
      #loading <- ropls::getWeightMN(model)
    }
    else{
      cat(crayon::red("nmrLoadingsPlot >>", "Unsupported model"))
      stop()
    }
  }
  backscaledLoading <- loading * scaling  
  normLoading <- abs(loading)
  mn <- min(normLoading)  
  mx <- max(normLoading)
  normLoading <- (normLoading - mn) / (mx - mn)   
  #weights <- getWeightMN(oPLS)[roi]
  ppm <- ppm[roi]
  backscaledLoading <- backscaledLoading[roi]
  normLoading <- normLoading[roi] 
  df <- data.frame(ppm=ppm,backscaledLoading=backscaledLoading,normLoading=normLoading)
  ggplot(df,aes(x=ppm,y=backscaledLoading,colour=normLoading)) + geom_line() + 
  scale_x_reverse(n.breaks=breaks) + 
  scale_colour_gradientn(colors = matlab.like2(10), limits=c(0,1), name="|Loading|") +
  theme_bw()#+
  #scale_color_continuous_sequential(palette,name="Loading norm")
}
```

node 6 vs node 9 by CPMG DM status 
```{r}
library(dplyr)

node6 <- ann_finalCPMG%>%filter(classif == 6)%>%select(sampleID, classif)

node9 <- ann_finalCPMG%>%filter(classif == 9)%>%select(sampleID, classif)

save(node6, file = "node6_SOM_CPMG_30082023.rda")
#load("nod64_SOM_CPMG_17082023.rda")
save(node9, file="node9_SOM_CPMG_30082023.rda")
#load("node9_SOM_CPMG_17082023.rda")

idx_node6 <- which(ann_finalCPMG$sampleID %in% node6$sampleID) 
XblCPMG_node6 <- Xbl_CPMG[idx_node6, ]

idx_node9 <- which(ann_finalCPMG$sampleID %in% node9$sampleID) 
XblCPMG_node9 <- Xbl_CPMG[idx_node9, ]

annoCPMG_node69 <- rbind(node6, node9)
annoCPMG_node69$group <- ifelse(annoCPMG_node69$classif == 6, "node6", "node9")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node69$sampleID)
length(idx)
# 80 spectra
ann_finalCPMG_node69 <- ann_finalCPMG[idx, ]


Xbl_CPMG_69 <- rbind(XblCPMG_node6, XblCPMG_node9)

#node69CPMG_opls <- ropls::opls(Xbl_CPMG_69, annoCPMG_node69$group, predI = 1, orthoI = 1) # set ropls to 1 ortho component
node69CPMG_opls2 <- oplsda(Xbl_CPMG_69, annoCPMG_node69$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function
#NOTE: the two models are identical. 

save(node69CPMG_opls2, file="SOM_CPMG_node69_OPLSDA_30082023.rda")


#plotScores(model=node69CPMG_opls2, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

nmrLoadingsPlot(model=node69CPMG_opls2,pc=1, ppm = ppms2, X=Xbl_CPMG_69) # Andres'

PlotLoadSpec(node69CPMG_opls2) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf69=data.frame(x=node69CPMG_opls2@scoreMN, y=node69CPMG_opls2@orthoScoreMN, ann_finalCPMG_node69)

g1=ggplot()+
   geom_point(data=ddf69, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf69)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf69$p1) * hotFisN),
                           ry = sqrt(var(ddf69$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```


# node1 v node 6 - Comb
```{r}
idx_node6 <- which(ann_finalCPMG$sampleID %in% node6$sampleID) 
XblCPMG_node6 <- Xbl_CPMG[idx_node6, ]

idx_node9 <- which(ann_finalCPMG$sampleID %in% node9$sampleID) 
XblCPMG_node9 <- Xbl_CPMG[idx_node9, ]

annoCPMG_node69 <- rbind(node6, node9)
annoCPMG_node69$group <- ifelse(annoCPMG_node69$classif == 6, "node6", "node9")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node69$sampleID)
length(idx)
# 80 spectra
ann_finalCPMG_node69 <- ann_finalCPMG[idx, ]


Xbl_CPMG_69 <- rbind(XblCPMG_node6, XblCPMG_node9)

#node69CPMG_opls <- ropls::opls(Xbl_CPMG_69, annoCPMG_node69$group, predI = 1, orthoI = 1) # set ropls to 1 ortho component
node69CPMG_opls2 <- oplsda(Xbl_CPMG_69, annoCPMG_node69$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function
#NOTE: the two models are identical. 

save(node69CPMG_opls2, file="SOM_CPMG_node69_OPLSDA_30082023.rda")


#plotScores(model=node69CPMG_opls2, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

nmrLoadingsPlot(model=node69CPMG_opls2,pc=1, ppm = ppms2, X=Xbl_CPMG_69) # Andres'

PlotLoadSpec(node69CPMG_opls2) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf69=data.frame(x=node69CPMG_opls2@scoreMN, y=node69CPMG_opls2@orthoScoreMN, ann_finalCPMG_node69)

g1=ggplot()+
   geom_point(data=ddf69, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf69)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf69$p1) * hotFisN),
                           ry = sqrt(var(ddf69$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```


# node5 v node8 - CPMG DM status
```{r}
node5 <- ann_finalCPMG%>%filter(classif == 5)%>%select(sampleID, classif)

node8 <- ann_finalCPMG%>%filter(classif == 8)%>%select(sampleID, classif)

save(node5, file = "node5_SOM_CPMG_14092023.rda")
#load("node5_SOM_CPMG_14092023.rda")
save(node8, file = "node8_SOM_CPMG_14092023.rda")
#load("node8_SOM_CPMG_14092023.rda")

idx_node5 <- which(ann_finalCPMG$sampleID %in% node5$sampleID) 
XblCPMG_node5 <- Xbl_CPMG[idx_node5, ]

idx_node8 <- which(ann_finalCPMG$sampleID %in% node8$sampleID) 
XblCPMG_node8 <- Xbl_CPMG[idx_node8, ]

annoCPMG_node58 <- rbind(node5, node8)
annoCPMG_node58$group <- ifelse(annoCPMG_node58$classif == 5, "node5", "node8")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node58$sampleID)
length(idx)
# 74 spectra
ann_finalCPMG_node58 <- ann_finalCPMG[idx, ]
ann_finalCPMG_node58$classiflabel <- ifelse(ann_finalCPMG_node58$classif == 5, "node5", "node8")


Xbl_CPMG_58 <- rbind(XblCPMG_node5, XblCPMG_node8)

#node58CPMG_opls <- ropls::opls(Xbl_CPMG_58, annoCPMG_node58$group, predI = 1, orthoI = 1) # set ropls to 1 ortho component
node58CPMG_opls2 <- oplsda(Xbl_CPMG_58, annoCPMG_node58$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function
#NOTE: the two models are identical. 
# OPLS-DA
# 74 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum)  RMSEE pre ort pR2Y  pQ2
# Total     0.22    0.964   0.918 0.0857   1   1 0.05 0.05

save(node58CPMG_opls2, file="SOM_CPMG_node58_OPLSDA_14092023.rda")


#plotScores(model=node69CPMG_opls2, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

#nmrLoadingsPlot(model=node58CPMG_opls2,pc=1, ppm = ppms2, X=Xbl_CPMG_58) # Andres'

PlotLoadSpec(node58CPMG_opls2) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf58=data.frame(x=node58CPMG_opls2@scoreMN, y=node58CPMG_opls2@orthoScoreMN, ann_finalCPMG_node58)

g1=ggplot()+
   geom_point(data=ddf58, aes(p1, o1, colour=classiflabel), size=3)+
   scale_color_manual(values=c('node5'='orange', 'node8'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf58)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf58$p1) * hotFisN),
                           ry = sqrt(var(ddf58$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```


node 1 vs node 9 CPMG
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node9 <- ann_finalCPMG%>%filter(classif == 9)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")
#load("nod64_SOM_CPMG_17082023.rda")
save(node9, file="node9_SOM_CPMG_30082023.rda")
#load("node9_SOM_CPMG_17082023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node9 <- which(ann_finalCPMG$sampleID %in% node9$sampleID) 
XblCPMG_node9 <- Xbl_CPMG[idx_node9, ]

annoCPMG_node19 <- rbind(node1, node9)
annoCPMG_node19$group <- ifelse(annoCPMG_node19$classif == 1, "node1", "node9")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node19$sampleID)
length(idx)
# 74 spectra
ann_finalCPMG_node19 <- ann_finalCPMG[idx, ]


Xbl_CPMG_19 <- rbind(XblCPMG_node1, XblCPMG_node9)

node19CPMG_opls <- oplsda(Xbl_CPMG_19, annoCPMG_node19$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function
# OPLS-DA
# 74 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total     0.14    0.838   0.461 0.198   1   1 0.65 0.05

save(node19CPMG_opls, file="SOM_CPMG_node19_OPLSDA_11102023.rda")


plotScores(model=node19CPMG_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

#nmrLoadingsPlot(model=node19CPMG_opls,pc=1, ppm = ppms2, X=Xbl_CPMG_19) # Andres'

PlotLoadSpec(node19CPMG_opls) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf19=data.frame(x=node19CPMG_opls@scoreMN, y=node19CPMG_opls@orthoScoreMN, ann_finalCPMG_node19)

g1=ggplot()+
   geom_point(data=ddf19, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf19)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf19$p1) * hotFisN),
                           ry = sqrt(var(ddf19$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2

table(ann_finalCPMG_node110$classif, ann_finalCPMG_node110$comb, ann_finalCPMG_node110$BMIcut1)
# , ,  = Healthy weight
# 
#     
#      DM1 DM2 NO DM
#   1   10   0    16
#   10   1   0     1
# 
# , ,  = Overweight to severly obese
# 
#     
#      DM1 DM2 NO DM
#   1    6   3    12
#   10   1   2     8
```



# node 1 vs node 5 CPMG - 11/10/2023
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node5 <- ann_finalCPMG%>%filter(classif == 5)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")

save(node5, file="node5_SOM_CPMG_11102023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node5 <- which(ann_finalCPMG$sampleID %in% node5$sampleID) 
XblCPMG_node5 <- Xbl_CPMG[idx_node5, ]

annoCPMG_node15 <- rbind(node1, node5)
annoCPMG_node15$group <- ifelse(annoCPMG_node15$classif == 1, "node1", "node5")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node15$sampleID)
length(idx)
# 101 spectra
ann_finalCPMG_node15 <- ann_finalCPMG[idx, ]

Xbl_CPMG_15 <- rbind(XblCPMG_node1, XblCPMG_node5)

node15CPMG_opls <- oplsda(Xbl_CPMG_15, annoCPMG_node15$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 101 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.145    0.808   0.628 0.222   1   1 0.85 0.05

save(node15CPMG_opls, file="SOM_CPMG_node15_OPLSDA_11102023.rda")


plotScores(model=node15CPMG_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

#nmrLoadingsPlot(model=node19CPMG_opls,pc=1, ppm = ppms2, X=Xbl_CPMG_19) # Andres'

PlotLoadSpec(node15CPMG_opls) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf15=data.frame(x=node15CPMG_opls@scoreMN, y=node15CPMG_opls@orthoScoreMN, ann_finalCPMG_node15)

g1=ggplot()+
   geom_point(data=ddf15, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf15)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf15$p1) * hotFisN),
                           ry = sqrt(var(ddf15$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```



# node 1 vs node 6 CPMG - 11/10/2023
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node6 <- ann_finalCPMG%>%filter(classif == 6)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")

save(node6, file="node6_SOM_CPMG_11102023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node6 <- which(ann_finalCPMG$sampleID %in% node6$sampleID) 
XblCPMG_node6 <- Xbl_CPMG[idx_node6, ]

annoCPMG_node16 <- rbind(node1, node6)
annoCPMG_node16$group <- ifelse(annoCPMG_node16$classif == 1, "node1", "node6")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node16$sampleID)
length(idx)
# 100 spectra
ann_finalCPMG_node16 <- ann_finalCPMG[idx, ]

Xbl_CPMG_16 <- rbind(XblCPMG_node1, XblCPMG_node6)

node16CPMG_opls <- oplsda(Xbl_CPMG_16, annoCPMG_node16$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 100 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.147    0.811   0.613 0.221   1   1  0.4 0.05

save(node16CPMG_opls, file="SOM_CPMG_node16_OPLSDA_11102023.rda")


plotScores(model=node16CPMG_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

#nmrLoadingsPlot(model=node19CPMG_opls,pc=1, ppm = ppms2, X=Xbl_CPMG_19) # Andres'

PlotLoadSpec(node16CPMG_opls) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf16=data.frame(x=node16CPMG_opls@scoreMN, y=node16CPMG_opls@orthoScoreMN, ann_finalCPMG_node16)

g1=ggplot()+
   geom_point(data=ddf16, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf16)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf16$p1) * hotFisN),
                           ry = sqrt(var(ddf16$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```

# node 1 vs node 10 CPMG - 11/10/2023 
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node10 <- ann_finalCPMG%>%filter(classif == 10)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")

save(node10, file="node10_SOM_CPMG_11102023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node10 <- which(ann_finalCPMG$sampleID %in% node10$sampleID) 
XblCPMG_node10 <- Xbl_CPMG[idx_node10, ]

annoCPMG_node110 <- rbind(node1, node10)
annoCPMG_node110$group <- ifelse(annoCPMG_node110$classif == 1, "node1", "node10")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node110$sampleID)
length(idx)
# 60 spectra
ann_finalCPMG_node110 <- ann_finalCPMG[idx, ]

Xbl_CPMG_110 <- rbind(XblCPMG_node1, XblCPMG_node10)

node110CPMG_opls <- oplsda(Xbl_CPMG_110, annoCPMG_node110$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 60 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.187    0.914   0.712 0.124   1   1  0.2 0.05

save(node110CPMG_opls, file="SOM_CPMG_node110_OPLSDA_11102023.rda")


plotScores(model=node110CPMG_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

#nmrLoadingsPlot(model=node19CPMG_opls,pc=1, ppm = ppms2, X=Xbl_CPMG_19) # Andres'

PlotLoadSpec(node110CPMG_opls) # Reika's

#NOTE: the two plots are identical. 


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf110=data.frame(x=node110CPMG_opls@scoreMN, y=node110CPMG_opls@orthoScoreMN, ann_finalCPMG_node110)

g1=ggplot()+
   geom_point(data=ddf15, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf110)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf110$p1) * hotFisN),
                           ry = sqrt(var(ddf110$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```


# node 1 vs node 10 CPMG NO DM SAMPLES ONLY + SOLVENTS REMOVED - 11/10/2023
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node10 <- ann_finalCPMG%>%filter(classif == 10)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")

save(node10, file="node10_SOM_CPMG_11102023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node10 <- which(ann_finalCPMG$sampleID %in% node10$sampleID) 
XblCPMG_node10 <- Xbl_CPMG[idx_node10, ]

annoCPMG_node110 <- rbind(node1, node10)
annoCPMG_node110$group <- ifelse(annoCPMG_node110$classif == 1, "node1", "node10")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node110$sampleID)
length(idx)
# 60 spectra
ann_finalCPMG_node110 <- ann_finalCPMG[idx, ]
Xbl_CPMG_110 <- rbind(XblCPMG_node1, XblCPMG_node10)

idx.nodm.110=which(ann_finalCPMG_node110$comb%in% c('NO DM'))
length(idx.nodm.110)
#37 samples/spectra
ann_nodm.110=ann_finalCPMG_node110[idx.nodm.110,]
Xbl_nodm.110=Xbl_CPMG_110[idx.nodm.110,]

# removing solvents from CPMG spectra before redoing node comparison
idx.solvent1=get_idx(range=c(1.155,1.175), ppms2)
idx.solvent2=get_idx(range=c(2.06,2.07), ppms2)
idx.solvent3=get_idx(range=c(3.35,3.36), ppms2)
idx.solvent4=get_idx(range=c(3.985,4.04), ppms2)
idx.rm=c(idx.solvent1, idx.solvent2, idx.solvent3, idx.solvent4)

Xbl_nodm.110.nosolvent <- Xbl_nodm.110[, -idx.rm]
dim(Xbl_nodm.110.nosolvent)
#[1]   37 51144

ppms_nosolvent=ppms2[-idx.rm]
length(ppms_nosolvent)
#[1] 51144

node110CPMG_nodm_opls <- oplsda(Xbl_nodm.110.nosolvent, as.factor(ann_nodm.110$classif), type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 37 samples x 51144 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.178    0.895  0.0184 0.145   1   1 0.85 0.15

save(node110CPMG_nodm_opls, file="SOM_CPMG_node110_nodm_OPLSDA_11102023.rda")

# Novia's node110CPMG_nodm_opls_m8 via metabom8 to get R2X and CV-AUROC
node110CPMG_nodm_opls_m8 <- metabom8::opls(Xbl_nodm.110.nosolvent, as.factor(ann_nodm.110$classif), center = TRUE)

node110CPMG_nodm_opls_m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.05     1     0.66
# 2       1       2   NA     1     0.67


plotScores(model=node110CPMG_nodm_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

PlotLoadSpec(node110CPMG_nodm_opls) # Reika's
PlotLoadSpec(node110CPMG_nodm_opls, roi = c(0.5, 4.5))


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf110=data.frame(x=node110CPMG_opls@scoreMN, y=node110CPMG_opls@orthoScoreMN, ann_finalCPMG_node110)

g1=ggplot()+
   geom_point(data=ddf15, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf110)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf110$p1) * hotFisN),
                           ry = sqrt(var(ddf110$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2

table(ann_finalCPMG_node110$classif, ann_finalCPMG_node110$comb, ann_finalCPMG_node110$BMIcut1)
# , ,  = Healthy weight
# 
#     
#      DM1 DM2 NO DM
#   1   10   0    16
#   10   1   0     1
# 
# , ,  = Overweight to severly obese
# 
#     
#      DM1 DM2 NO DM
#   1    6   3    12
#   10   1   2     8

```



node 1 vs node 6 CPMG NO DM SAMPLES ONLY + SOLVENTS REMOVED
```{r}
library(dplyr)

node1 <- ann_finalCPMG%>%filter(classif == 1)%>%select(sampleID, classif)

node6 <- ann_finalCPMG%>%filter(classif == 6)%>%select(sampleID, classif)

save(node1, file = "node1_SOM_CPMG_11102023.rda")

save(node6, file="node6_SOM_CPMG_11102023.rda")

idx_node1 <- which(ann_finalCPMG$sampleID %in% node1$sampleID) 
XblCPMG_node1 <- Xbl_CPMG[idx_node1, ]

idx_node6 <- which(ann_finalCPMG$sampleID %in% node6$sampleID) 
XblCPMG_node6 <- Xbl_CPMG[idx_node6, ]

annoCPMG_node16 <- rbind(node1, node6)
annoCPMG_node16$group <- ifelse(annoCPMG_node16$classif == 1, "node1", "node10")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node16$sampleID)
length(idx)
# 60 spectra
ann_finalCPMG_node16 <- ann_finalCPMG[idx, ]
Xbl_CPMG_16 <- rbind(XblCPMG_node1, XblCPMG_node6)

idx.nodm.16=which(ann_finalCPMG_node16$comb%in% c('NO DM'))
length(idx.nodm.16)
#61 samples/spectra
ann_nodm.16=ann_finalCPMG_node16[idx.nodm.16,]
Xbl_nodm.16=Xbl_CPMG_16[idx.nodm.16,]

# removing solvents from CPMG spectra before redoing node comparison
idx.solvent1=get_idx(range=c(1.155,1.175), ppms2)
idx.solvent2=get_idx(range=c(2.06,2.07), ppms2)
idx.solvent3=get_idx(range=c(3.35,3.36), ppms2)
idx.solvent4=get_idx(range=c(3.985,4.04), ppms2)
idx.rm=c(idx.solvent1, idx.solvent2, idx.solvent3, idx.solvent4)

Xbl_nodm.16.nosolvent <- Xbl_nodm.16[, -idx.rm]
dim(Xbl_nodm.16.nosolvent)
#[1]   61 51144

ppms_nosolvent=ppms2[-idx.rm]
length(ppms_nosolvent)
#[1] 51144

node16CPMG_nodm_opls <- oplsda(Xbl_nodm.16.nosolvent, as.factor(ann_nodm.16$classif), type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 61 samples x 51144 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.126     0.87  0.0609 0.184   1   1 0.85 0.05

save(node16CPMG_nodm_opls, file="SOM_CPMG_node16_nodm_OPLSDA_11102023.rda")

# Novia's node16CPMG_nodm_opls_m8 via metabom8 to get R2X and CV-AUROC
node16CPMG_nodm_opls_m8 <- metabom8::opls(Xbl_nodm.16.nosolvent, as.factor(ann_nodm.16$classif), center = TRUE)

node16CPMG_nodm_opls_m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.03     1     0.67
# 2       1       2   NA     1     0.69

plotScores(model=node16CPMG_nodm_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

PlotLoadSpec(node16CPMG_nodm_opls) # Reika's
PlotLoadSpec(node16CPMG_nodm_opls, roi = c(0.5, 4.5))


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf16=data.frame(x=node16CPMG_opls@scoreMN, y=node16CPMG_opls@orthoScoreMN, ann_finalCPMG_node16)

g1=ggplot()+
   geom_point(data=ddf16, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf16)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf16$p1) * hotFisN),
                           ry = sqrt(var(ddf16$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2


table(ann_finalCPMG_node16$classif, ann_finalCPMG_node16$comb, ann_finalCPMG_node16$BMIcut1)


```



#node 2 vs node 12 CPMG DM1 SAMPLES ONLY + SOLVENTS REMOVED
```{r}
library(dplyr)

node2 <- ann_finalCPMG%>%filter(classif == 2)%>%select(sampleID, classif)

node12 <- ann_finalCPMG%>%filter(classif == 12)%>%select(sampleID, classif)

save(node2, file = "node2_SOM_CPMG_11102023.rda")

save(node12, file="node12_SOM_CPMG_11102023.rda")

idx_node2 <- which(ann_finalCPMG$sampleID %in% node2$sampleID) 
XblCPMG_node2 <- Xbl_CPMG[idx_node2, ]

idx_node12 <- which(ann_finalCPMG$sampleID %in% node12$sampleID) 
XblCPMG_node12 <- Xbl_CPMG[idx_node12, ]

annoCPMG_node212 <- rbind(node2, node12)
annoCPMG_node212$group <- ifelse(annoCPMG_node212$classif == 2, "node2", "node12")

idx <- which(ann_finalCPMG$sampleID %in% annoCPMG_node212$sampleID)
length(idx)
# 31 spectra
ann_finalCPMG_node212 <- ann_finalCPMG[idx, ]
Xbl_CPMG_212 <- rbind(XblCPMG_node2, XblCPMG_node12)

idx.dm1.212=which(ann_finalCPMG_node212$comb%in% c('DM1'))
length(idx.dm1.212)
#22 samples/spectra
ann_dm1.212=ann_finalCPMG_node212[idx.dm1.212,]
Xbl_dm1.212=Xbl_CPMG_212[idx.dm1.212,]

# removing solvents from CPMG spectra before redoing node comparison
idx.solvent1=get_idx(range=c(1.155,1.175), ppms2)
idx.solvent2=get_idx(range=c(2.06,2.07), ppms2)
idx.solvent3=get_idx(range=c(3.35,3.36), ppms2)
idx.solvent4=get_idx(range=c(3.985,4.04), ppms2)
idx.rm=c(idx.solvent1, idx.solvent2, idx.solvent3, idx.solvent4)

Xbl_dm1.212.nosolvent <- Xbl_dm1.212[, -idx.rm]
dim(Xbl_dm1.212.nosolvent)
#[1]   22 51144

ann_dm1.212$group <- ifelse(ann_dm1.212$classif == 2, "node2", "node12")

ppms_nosolvent=ppms2[-idx.rm]
length(ppms_nosolvent)
#[1] 51144

node212_CPMG_dm1_opls <- oplsda(Xbl_dm1.212.nosolvent, ann_dm1.212$group, type = "OPLS", optns = list(orthoI=1)) # Lucy's wrapper function

# OPLS-DA
# 22 samples x 51144 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum)  RMSEE pre ort pR2Y pQ2
# Total    0.172    0.976   0.128 0.0833   1   1 0.45 0.2

save(node212_CPMG_dm1_opls, file="SOM_CPMG_node212_dm1_OPLSDA_11102023.rda")

# Novia's node212_CPMG_dm1_opls_m8 via metabom8 to get R2X and CV-AUROC
node212_CPMG_dm1_opls_m8 <- metabom8::opls(Xbl_dm1.212.nosolvent, ann_dm1.212$group, center = TRUE)

node212_CPMG_dm1_opls_m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.07     1     0.62
# 2       1       2   NA     1     0.65


plotScores(model=node212_CPMG_dm1_opls, optns=list(ellipse = "hotellings")) #Lucy's 

## Loading plot 

PlotLoadSpec(node212_CPMG_dm1_opls) # Reika's
PlotLoadSpec(node212_CPMG_dm1_opls, roi = c(0.5, 4.5))


#final figure format
#plot scores
# df_ellipse = plotScores(model=smod2, optns=list(ellipse = "hotellings"))
# 
# df_ellipse

ddf212=data.frame(x=node212_CPMG_dm1_opls@scoreMN, y=node212_CPMG_dm1_opls@orthoScoreMN, ann_dm1.212)

g1=ggplot()+
   geom_point(data=ddf212, aes(p1, o1, colour=comb, shape=comb), size=3)+
   scale_shape_manual(values=c('NO DM'=16, 'DM1'=17, 'DM2'=15))+
   scale_color_manual(values=c('NO DM' = 'grey','DM1'='orange', 'DM2'='firebrick')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))

g1

n <- nrow(ddf212)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf212$p1) * hotFisN),
                           ry = sqrt(var(ddf212$o1) * hotFisN),
                           xc = 0,
                           yc = 0)


g1_2 <- g1 + ellipse

g1_2
```






# specOverlay for red sample in node 2 vs red sample in node 11 in SOM CPMG4x3 by Diab Status
```{r}
node2 <- ann_finalCPMG%>%filter(classif == 2 & comb == "DM1")%>%select(sampleID, classif)

node11 <- ann_finalCPMG%>%filter(classif == 11 & comb == "DM1")%>%select(sampleID, classif)

save(node2, file = "node2_SOM_CPMG_14092023.rda")
#load("node2_SOM_CPMG_14092023.rda")
save(node11, file = "node11_SOM_CPMG_14092023.rda")
#load("node11_SOM_CPMG_14092023.rda")

idx_node2 <- which(ann_finalCPMG$sampleID == "SAUD_200") # choosing one of the 12 samples in node2
XblCPMG_node2 <- Xbl_CPMG[idx_node2, ]

idx_node11 <- which(ann_finalCPMG$sampleID %in% node11$sampleID) 
XblCPMG_node11 <- Xbl_CPMG[idx_node11, ]

Xbl_CPMG_211 <- rbind(XblCPMG_node2, XblCPMG_node11)
dim(Xbl_CPMG_211)

node2_SAUD200 <- ann_finalCPMG%>%filter(classif == 2 & comb == "DM1" & sampleID == "SAUD_200")%>%select(sampleID, classif)

annoCPMG_node211 <- rbind(node2_SAUD200, node11)
annoCPMG_node211$group <- ifelse(annoCPMG_node211$classif == 2, "node2", "node11")

metabom8::specOverlay(Xbl_CPMG_211, ppms2, shift = c(0.5, 5), an=list('Facet'= annoCPMG_node211$group, 'Node' = annoCPMG_node211$group))

metabom8::specOverlay(Xbl_CPMG_211, ppms2, shift = c(6, 9), an=list('Facet'= annoCPMG_node211$group, 'Node' = annoCPMG_node211$group))

```




```{r}
# ggplotting 
medCPMG_node6 <- apply(Xbl_CPMG_node6, 2, median)
minCPMG_node6 <- apply(Xbl_CPMG_node6, 2, min)
maxCPMG_node6 <- apply(Xbl_CPMG_node6, 2, max)

medCPMG_node9 <- apply(Xbl_CPMG_node9, 2, median)
minCPMG_node9 <- apply(Xbl_CPMG_node9, 2, min)
maxCPMG_node9 <- apply(Xbl_CPMG_node9, 2, max)


medCPMG_overall <- apply(Xbl_CPMG, 2, median)

med_node69CPMG_df <- data.frame(cbind(medCPMG_node6, medCPMG_node9, ppms2))

ggplot(node69CPMG_df, aes(x=ppms2, y=medCPMG_node4)) + 
  geom_line(color = 'blue') +
  geom_line(aes(y = node69CPMG_df$medCPMG_node9), color = "lightcoral", linetype=c("solid")) + 
  theme_bw() + 
  scale_x_reverse(breaks=seq(0,10,1)) +
  ylab("Intensity Value") + 
  ggtitle("Median spectra for 4x3 SOM Node 6 vs Node 9 CPMG")

colors_69 <- c("node4" = "blue", "node9" = "lightcoral", "all" = "darkorange")
```


```{r}
#zooming in 
ggplot(node49_df, aes(x=ppms2)) + 
  geom_line(aes(y = med_node4, color = 'node4'), linetype = "solid") +
  geom_line(aes(y = med_node9, color = 'node9'), linetype = "solid") + 
  #geom_line(aes(y = med_overall, color = 'all'), linetype = "dotted") +   
  theme_bw() + 
  scale_color_manual(values = colors_49) + 
  coord_cartesian(xlim = c(7.5, 6.5), ylim = c(0, 20)) +
  scale_x_reverse() +
  ylab("Intensity Value") + 
  ggtitle("Median spectra for 4x3 SOM Node 4 vs Node 9 CPMG") 
  

ggplot(node49_df, aes(x=ppms2)) + 
  geom_line(aes(y = med_node4, color = 'node4'), linetype = "solid") +
  geom_line(aes(y = med_node11, color = 'node11'), linetype = "solid") + 
  theme_bw() + 
  scale_color_manual(values = colors_49) + 
  coord_cartesian(xlim = c(1.4, 1.2), ylim = c(0, 500)) +
  scale_x_reverse() +
  ylab("Intensity Value") + 
  ggtitle("Median spectra for 4x3 SOM Node 4 vs Node 11 CPMG") 


p4 <- ggplot(node49_df, aes(x=ppms2)) + 
  geom_line(aes(y = med_node4, color = 'node4')) +
  theme_bw() + 
  scale_color_manual(values = colors_49) + 
  scale_x_reverse(breaks=seq(0,10,1)) +
  ylab("Intensity Value") + 
  ggtitle("Median spectra for 4x3 SOM Node 4 CPMG")

p9 <- ggplot(node49_df, aes(x=ppms2)) + 
  geom_line(aes(y = med_node9, color = 'node9')) +
  theme_bw() + 
  scale_color_manual(values = colors_49) + 
  scale_x_reverse(breaks=seq(0,10,1)) +
  ylab("Intensity Value") + 
  ggtitle("Median spectra for 4x3 SOM Node 9 CPMG")

ggarrange(p4, p9, nrow=2, ncol=1)


node49_df <- data.frame(cbind(min_node4, med_node4,max_node4,min_node9, med_node9, max_node9,ppms2))

p4 <- ggplot(node49_df, aes(x=ppms2, y=max_node4)) + 
  geom_line(color = 'grey') +
  geom_line(aes(y = min_node4), color = "grey", linetype=c("solid")) + 
  geom_line(aes(y = med_node4), color = "lightcoral", linetype=c("solid")) + 
  geom_ribbon(data=node49_df, 
              aes(ymin=min_node4, ymax=max_node4), fill="grey", alpha=0.5) + 
  theme_bw() + 
  scale_x_reverse(breaks=seq(0,10,1)) +
  ylab("Intensity Value") + 
  ggtitle("Node4 CPMG")




p9 <- ggplot(node49_df, aes(x=ppms2, y=max_node9)) + 
  geom_line(color = 'grey') +
  geom_line(aes(y = min_node9), color = "grey", linetype=c("solid")) + 
  geom_line(aes(y = med_node9), color = "blue", linetype=c("solid")) + 
  geom_ribbon(data=node49_df, 
              aes(ymin=min_node9, ymax=max_node9), fill="grey", alpha=0.5) + 
  theme_bw() + 
  scale_x_reverse(breaks=seq(0,10,1)) +
  ylab("Intensity Value") + 
  ggtitle("Node9 CPMG")


ggarrange(p4, p9, nrow=2, ncol=1)


specOverlay(Xbl, ppms2, shift=c(0.5, 1.1), an=list(factor(ann_finalCPMG$classif), BMI=factor(ann_finalCPMG$BMIcut1)))

```

```{r}
orig_node49 <- rbind(node4, node9)
orig_node49$group <- ifelse(orig_node49$classif == 4, "node4", "node9") 
# node4 = 1, node9 = 2

idx <- which(orig_node49$sampleID %in% ann_finalCPMG$sampleID)
length(idx)
# only 76 spectra

Xbl_49 <- rbind(Xbl_node4, Xbl_node9)

#node49_cpmg_opls <- opls(Xbl_49, orig_node49$group) # error using ropls package
# No model was built because the first predictive component was already not significant.
# PLS-DA
# 76 samples x 51767 variables and 1 response
# standard scaling of predictors and response(s)
# Empty 'opls' object

node49_cpmg_opls <- metabom8::opls(Xbl_49, orig_node49$group)

outlier.idx <- which(node49_cpmg_opls@t_pred_cv >75 & orig_node49$group =='node4')

outliers<-rep('', nrow(orig_node49))
outliers[outlier.idx] <- orig_node49$sampleID[outlier.idx]


outliers.info <- ann_finalCPMG%>%filter(sampleID %in% orig_node49$sampleID[outlier.idx])%>%select(sampleID, BMIcut1, comb, Groupmeta)


plotscores(node49_cpmg_opls, Node=orig_node49$group, ID=orig_node49$sampleID)
plotload(node49_cpmg_opls, shift=c(2, 2.5))
plotload(node49_cpmg_opls, shift=c(2.5, 2.8))
plotload(node49_cpmg_opls, shift=c(0.5, 1.2))
plotload(node49_cpmg_opls, shift=c(6.5,7.5))
plotload(node49_cpmg_opls, shift=c(1.1, 1.3))
plotload(node49_cpmg_opls, shift=c(1.15, 1.2))

driver = 1.175
stocsy_model = stocsy(Xbl_49, ppms2, driver)
plotStocsy(stocsy_model, shift =c(1.1, 1.4))
plotStocsy(stocsy_model, shift =c(3.3,3.7))


driver = 1.1685
stocsy_model = stocsy(Xbl_49, ppms2, driver)
plotStocsy(stocsy_model, shift =c(1.1, 1.2))
plotStocsy(stocsy_model, shift =c(4,4.05))


driver = 2.66
stocsy_model = stocsy(Xbl_49, ppms2, driver)
plotStocsy(stocsy_model, shift =c(1.1, 1.2))
plotStocsy(stocsy_model, shift =c(4,4.05))


orig_node411 <- rbind(node4, node11)
orig_node411$group <- ifelse(orig_node411$classif == 4, 1, 2) 
# node4 = 1, node11 = 2

idx <- which(orig_node411$sampleID %in% ann_finalCPMG$sampleID)
length(idx)
# only 96 spectra

Xbl_411 <- rbind(Xbl_node4, Xbl_node11)

node411_cpmg_opls <- opls(Xbl_411, orig_node411$group)




```


## 4x4 SOM 
```{r}

#cpmg2.som <- som(Xbl_cut, grid = somgrid(4, 4, "hexagonal"))
# ann_finalCPMG$classif2 <- cpmg2.som$unit.classif
# length(cpmg2.som$unit.classif)
#[1] 287

#Mapping PLOTS
#red=NoDM, red=DM1, black=DM2
plot(cpmg2.som, type = "mapping", col = bgcols1[factor(ann_finalCPMG$comb)], main = "CPMG SOM Plot Node Coloured by Diabetes Status") 

# doing 2-way cross-tab between Ob status vs. SOM (Node) classification
data <- table(ann_finalCPMG$BMIcut1, ann_finalCPMG$classif2)

data %>%
  as.data.frame.matrix() %>%
  tibble::rownames_to_column() %>%
  adorn_totals(name = 'TOTAL') %>%
  adorn_totals(name = 'TOTAL', where = 'col')


# Mapping PLOTS
#black = Healthy weight; red = overweight/obese
plot(cpmg2.som, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], main = "CPMG SOM Plot Node Coloured By Obesity Status") 



# doing 2-way cross-tab between comb of DM and Ob status vs. SOM (Node) classification
data <- table(ann_finalCPMG$Groupmeta, ann_finalCPMG$classif2)

data %>%
  as.data.frame.matrix() %>%
  tibble::rownames_to_column() %>%
  adorn_totals(name = 'TOTAL') %>%
  adorn_totals(name = 'TOTAL', where = 'col')

# Mapping PLOTS
#red=DM1_healthyweight, blue=DM1_Overweighttoseverlyobese, purple=DM2_healthyweight
#green=DM2_overweighttoseverlyobese, orange=NODM_healthyweight, black=NODM_overweighttoseverlyobese
plot(cpmg2.som, type = "mapping", col = bgcols2[factor(ann_finalCPMG$Groupmeta)], main = "CPMG SOM Plot Node Coloured By the Combination of Diabetes & Obesity Status")
```



# SOM Optimisation attempt
## 3x3, 100 iteration
```{r}
library(kohonen)
library(janitor)

load("Matched_CPMG_ANNO_FINAL_30082023.rda")

set.seed(7)

cpmg.33.100 <- som(Xbl_CPMG, grid = somgrid(3, 3, "hexagonal"), rlen=100)
#ann_finalCPMG$classif <- cpmg.33.100$unit.classif

#BMI - black = Healthy weight; red = overweight/obese
plot(cpmg.33.100, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], pch=19, main="CPMG SOM 3x3, 100 iteration, Full Spectra Coloured by BMI")

```


## 3x3, 500 iteration
```{r}
set.seed(7)

cpmg.33.500 <- som(Xbl_CPMG, grid = somgrid(3, 3, "hexagonal"), rlen=500)

#BMI - black = Healthy weight; red = overweight/obese
plot(cpmg.33.500, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], pch=19, main="CPMG SOM 3x3, 500 iteration, Full Spectra Coloured by BMI")
```

## 3x3, 1000 iteration
```{r}
set.seed(7)

cpmg.33.1000 <- som(Xbl_CPMG, grid = somgrid(3, 3, "hexagonal"), rlen=1000)

#BMI - black = Healthy weight; red = overweight/obese
plot(cpmg.33.1000, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], pch=19, main="CPMG SOM 3x3, 1000 iteration, Full Spectra Coloured by BMI")
```

## 3x3, 10000 iteration
```{r}
set.seed(7)

cpmg.33.1e4 <- som(Xbl_CPMG, grid = somgrid(3, 3, "hexagonal"), rlen=1e4)

#BMI - black = Healthy weight; red = overweight/obese
plot(cpmg.33.1e4, type = "mapping", col = c2[factor(ann_finalCPMG$BMIcut1)], pch=19, main="CPMG SOM 3x3, 10000 iteration, Full Spectra Coloured by BMI")
```







```{r}
# SPEC OVERLAY
## LIPOPROTEIN
# How Lipo looks at each node coloured by Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(0.7,1.0), an=list(factor(ann_finalCPMG$classif2), Obesity=factor(ann_finalCPMG$BMIcut1)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(1.129,1.360), an=list(factor(ann_finalCPMG$classif2), Obesity=factor(ann_finalCPMG$BMIcut1)))
# How Lipo looks at each node coloured by DM status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(0.7, 1.0), an=list(factor(ann_finalCPMG$classif2), Diabetes=factor(ann_finalCPMG$comb)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(1.129,1.360), an=list(factor(ann_finalCPMG$classif2), Diabetes=factor(ann_finalCPMG$comb)))
# How Lipo looks at each node coloured by comb of DM and Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(0.7, 1.0), an=list(factor(ann_finalCPMG$classif2), DM_OB=factor(ann_finalCPMG$Groupmeta)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(1.129,1.360), an=list(factor(ann_finalCPMG$classif2), DM_OB=factor(ann_finalCPMG$Groupmeta)))
```


```{r}
## Triglycerides and GlycA and GlycB
# How Triglycerides looks at each node coloured by Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(2.0,2.50), an=list(factor(ann_finalCPMG$classif2), Obesity=factor(ann_finalCPMG$BMIcut1)))

# How Triglycerides looks at each node coloured by DM status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(2, 2.5), an=list(factor(ann_finalCPMG$classif2), Diabetes=factor(ann_finalCPMG$comb)))

# How Triglycerides looks at each node coloured by comb of DM and Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(2, 2.5), an=list(factor(ann_finalCPMG$classif2), DM_OB=factor(ann_finalCPMG$Groupmeta)))
```


```{r}
## GLUCOSE -- only for Full CPMG Spectra, not for the BCAA and GlycA region (0.5-2.95ppm)
# How Glucose looks at each node coloured by Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(5.22,5.25), an=list(factor(ann_finalCPMG$classif), Obesity=factor(ann_finalCPMG$BMIcut1)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(4.0625,4.13), an=list(factor(ann_finalCPMG$classif), Obesity=factor(ann_finalCPMG$BMIcut1)))
# How Glucose looks at each node coloured by DM status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(5.22,5.25), an=list(factor(ann_finalCPMG$classif), Diabetes=factor(ann_finalCPMG$comb)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(4.0625,4.13), an=list(factor(ann_finalCPMG$classif), Diabetes=factor(ann_finalCPMG$comb)))
# How Glucose looks at each node coloured by comb of DM and Obesity status
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(5.22,5.25), an=list(factor(ann_finalCPMG$classif), DM_OB=factor(ann_finalCPMG$Groupmeta)))
specOverlay(Xbl_cut, ppm = as.numeric(colnames(Xbl_cut)), shift=c(4.0625,4.13), an=list(factor(ann_finalCPMG$classif), DM_OB=factor(ann_finalCPMG$Groupmeta)))


```



