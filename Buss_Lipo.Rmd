---
title: "Busselton_Lipo"
author: "nminaee"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


```

# Loading packages 
```{r setup, include=FALSE}
devtools::load_all("~/nmr-spectra-processing/")
#devtools::install_github("phenological/mva-plots")

library(fusion)
library(dplyr)
library(readr)
library(reshape2)
library(ggplot2)
library(ggrepel)
library(tibble)
library(ggpubr)
library(mva.plots)
library(ca)
library(tidyr)
```

# Loading Saudi Lipo data 
```{r}
load("/Users/novia/Desktop/Diabetes_Obesity/Lipo_ann_19102023.rda")
dim(Lipo_ann)
#[1] 284 289

write.csv(Lipo_ann, file="/Users/novia/Desktop/Diabetes_Obesity/SAU_lipo_ann_23112023.csv", row.names=FALSE)

load("~/Desktop/Diabetes_Obesity/LipoGluGlyc_01092023.rda")
write.csv(Lipo_Glu_Glyc, file="/Users/novia/Desktop/Diabetes_Obesity/SAU_LipoGluGlyc_01092023.csv", row.names = FALSE)
```


NOTE SL & NM 23/11/2023 
- BUSSELTON cohort: only select the  + DM2 only from t1 only. 
- SAUDI cohort: select all (as is) - 284 samples
- Both cohorts will be collated manually to make sure the columns are consistent among both.
- Both cohorts need to be corrected for Age, Gender and Cohort prior to any analysis.


```{r}
options(ggrepel.max.overlaps = Inf) # do this at the beginning of plotting so it's set for the entire session
```

# Loading BUS-t1 simplified LIPO & ANNO data
```{r}
# Loading Busselton Simplified Annotation data
# Simplified data has been updated (28/11/2023)
ann_buss <- read.csv("BUS_anno_t1_simplified_NM_23112023.csv", header=TRUE)
ann_buss <- ann_buss[, -1] #removing Excel's auto-id column 
dim(ann_buss)
#[1] 1976  21


# Loading Busselton Lipo data (from SL 14/11/2023)
#buss = read.csv(file='BUS_ann_Integrals_SLL_141123.csv')
#dim(buss)
#[1] 3945 1130

# Loading Busselton Lipo data from Reika 
buss = read.csv(file='Busselton_Lipo_290523.csv') 
dim(buss)
#[1] 4292  114


# Matching Anno and Lipo Data 
idx<-which(ann_buss$sampleID %in% buss$Lipo_Ann.sampleID) # 1976
ann_buss<-ann_buss[which(ann_buss$sampleID %in% buss$Lipo_Ann.sampleID),]
idx<-which(buss$Lipo_Ann.sampleID %in% ann_buss$sampleID)  #1976
buss<-buss[idx,]

ann_buss<-ann_buss[match(buss$Lipo_Ann.sampleID, ann_buss$sampleID),]
lipo_buss <- buss[, 3:114]

buss2 <- cbind(lipo_buss, ann_buss)
dim(buss2)
#[1] 1976  133

# Selecting only those with Diabetes status not blank or NA.
idx2 <- which(buss2$Summary_Type2_Diabetes_idx %in% c(0, 1)) #1976
### NOTE: Diabetes_ and Summary_Type2_Diabetes give roughly the same number of overall NO DM vs DM. 
### BUT Diabetes_ = 1 includes uncertain DM1 diagnosis. So here onwards it's safer to use Summary_Type2_Diabetes_idx. 

buss2 <- buss2[idx2, ]
dim(buss2)
#[1] 1976  133

table(buss2$Diabetes_, buss2$BMI.weight) 
   
#   Healthy Obese Overweight Underweight
# 0     513   498        855           6
# 1       7    63         33           0

# 0 = No DM, 1 = DM

table(buss2$Summary_Type2_Diabetes_idx, buss2$BMI.weight) 
#   Healthy Obese Overweight Underweight
# 0     502   480        834           6
# 1      18    81         55           0

# 0 = Not DM2, 1 = DM2

### To proceed with NO DM = Summary_Type2_Diabetes_idx == 0 for now until Elaine says otherwise (SL, NM 28/11/2023)

# BUS - diabesity category 
# Creating the same diabetes and obesity categories for Bus as in Sau's

buss2$DM = ""
buss2$DM[which(buss2$Summary_Type2_Diabetes_idx == 0)] = "NO DM"
buss2$DM[which(buss2$Summary_Type2_Diabetes_idx == 1)] = "DM2"

buss2$comb = gsub("\\s","", paste(buss2$BMI.weight,"_", buss2$DM))

# drop unnecessary columns - streamlining with Saudi's dataset
library(data.table)
buss3 <- buss2
setDT(buss3)[, c("bloodno0", "bloodno6", "Healthy_all", "COMBINED", "Healthy_bus", "Diabetes_", "Summary_Healthy", "Summary_Type2_Diabetes_idx", "Diabetes_Age_First_Diagnosed", "Diabetes_Type") := NULL]

dim(buss3)
#[1] 1976 125

# reorder columns to match Saudi's
buss_final <- buss3 %>% select(TPTG:sampleID, glucose, age, sex, height, weight, bmi, waist, sbp, dbp, BMI.weight, DM, comb)

write.csv(buss_final, file = "BUS_t1_Healthy_or_DM2_28112023.csv", row.names = FALSE)
```

# Loading SAU simplified data 
Column names have been streamlined to BUS_t1_Healthy_or_DM2_23112023.csv
```{r}
sau <- read.csv("/Users/novia/Desktop/Diabetes_Obesity/SAU_lipo_ann_simplified_23112023.csv", header=TRUE)

# Selecting only DM2 from SAU to match BUS
idx <- which(sau$DM %in% c("NO DM", "DM2")) #182
sau2 <- sau[idx, ]

# drop unnecessary columns - streamlining with Busselton's dataset
sau_final <- sau2
setDT(sau_final)[, c("BMIcut1", "Groupmeta") := NULL]
dim(sau_final)
#[1] 182 124

# renaming Healthy weight = Healthy to be consistent with Busselton
sau_final$BMI.weight[which(sau_final$BMI.weight == "Healthy weight")] = "Healthy"
sau_final$sex[which(sau_final$sex == "Male")] = "M"
sau_final$sex[which(sau_final$sex == "Female")] = "F"

# creating Diabesity category
sau_final$comb = gsub("\\s","", paste(sau_final$BMI.weight,"_", sau_final$DM))
dim(sau_final)
#[1] 182 125

#write.csv(sau_final, file = "/Users/novia/Desktop/Diabetes_Obesity/SAU_lipo_ann_simplified_28112023.csv", row.names = FALSE)


```


# Combine BUS + SAU 
```{r}
bus_sau <- rbind(buss_final, sau_final)
write.csv(bus_sau, file = "BusT1_Sau_Healthy_DM2_28112023.csv", row.names = FALSE)
# a cohort column has been MANUALLY added.
bus_sau <- read.csv("Bust1_Sau_Healthy_DM2_28112023.csv", header=TRUE)
dim(bus_sau)
#[1] 2158 126


```

# Correcting for age, sex, cohort
```{r}
# running linear model for each of the 112 lipoprotein 
# we want to get the residuals because the residuals are the remaining of lipoprotein's effect after the gender effect is removed. 
# steps: 
# 1. linear model with gender as predictor is fitted 
# 2. extract the residuals 
# 3. use the residuals as the new lipoprotein matrix 

lipoList <- colnames(bus_sau[, 1:112])
ann <- bus_sau[, 113:ncol(bus_sau)]

# converting sex from Male/Female to 0 (Female) and 1 (Male).
bus_sau$sex01 <- ifelse(bus_sau$sex == "F", 0, 1)

# converting cohort from Busselton/Saudi to 0 (Busselton), 1 (Saudi)
bus_sau$co01 <- ifelse(bus_sau$cohort== "BUSSELTON", 0, 1)

# running lm
out <- vector('list', length(lipoList))
resid <- vector('list', length(lipoList))

for (i in seq_along(lipoList)){
  out[[i]] <- lm(paste(lipoList[i],  '~', 'sex01', '+', 'age', '+', 'co01'),
               data = bus_sau)
  resid[[i]] <- out[[i]]$residuals
}

# bind all the residuals together to form a matrix 
resid <- do.call("cbind", resid)
colnames(resid) <- colnames(bus_sau[, 1:112])
class(resid)
#[1] "matrix" "array"
dim(resid)
#[1] 2158 112

# adding grand(overall) median for each lipo back to the residual to recover the scale of the value
grandMedian <- as.list(apply(bus_sau[, 1:112],2,median))
grandMedian <- apply(bus_sau[, 1:112],2,median)
length(grandMedian)
#[1] 112
class(grandMedian)
#[1] "numeric"


# making grandMedian shape/dimension the same as resid array so I can add them together to make corrected lipo dataframe/matrix
testrep <- t(matrix(rep(list(grandMedian), times=112), ncol=2158))
testrep2 <- t(do.call(cbind, testrep))
dim(testrep2)
#[1] 2158 112
grandMedianrep <- testrep2

cl <- resid + grandMedianrep # cl = corrected lipo
dim(cl)
#[1] 2158 112
#write.csv(cl, file = "BUS_SAU_correctedLipo_28112023.csv")

bus_sau2 <- cbind(cl, ann)
dim(bus_sau2)
#[1] 2158 126

table(bus_sau2$cohort)

# BUSSELTON     SAUDI 
#      1976       182 

#save(bus_sau2, file = "BUS_SAU_bus_sau2_28112023.rda")
#write.csv(bus_sau2, file = "BUS_SAU_bus_sau2_28112023.csv", row.names=F)
#load("BUS_SAU_bus_sau2_28112023.rda")
load("BUS_SAU_correctedLipo_ann_14022024.rda") # added a comb2 column
```

# PCA 
```{r}
nodm <- bus_sau2[which(bus_sau2$DM == "NO DM"),]

pca.nodm = PCA(nodm[, 1:112], center = T, scale. = T, rank=2)

plotScores(model=pca.nodm, optns=list(color = nodm$cohort, ellipse="hotellings", plotTitle = "PCA - BUS v SAU - No DM")) # to get the PC%

plotLoadings(model = pca.nodm, optns=list(plotTitle = "PCA - BUS v SAU - No DM"))

dm2 <- bus_sau2[which(bus_sau2$DM == "DM2"),]

pca.dm2 <- PCA(dm2[, 1:112], center=T, scale.=T, rank=2)

plotScores(model=pca.dm2, optns=list(color = dm2$cohort, ellipse="hotellings", plotTitle = "PCA - BUS v SAU - DM2")) # to get the PC%

plotLoadings(model = pca.dm2, optns=list(plotTitle = "PCA - BUS v SAU - DM2"))

```


# Sig test + boxplot
```{r}
library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

# corrected Lipo for age, sex, cohort - NO DM
for(i in lipo_group){
    data.frame(nodm%>%select(cohort),nodm[,grep(i,names(nodm))])%>%pivot_longer(cols = !cohort,names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = cohort, y = val,fill = cohort))+geom_boxplot()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+facet_wrap_paginate(~lipo,scales = "free")->p1
  
  plot(p1)

}


# corrected Lipo for age, sex, cohort - DM2
for(i in lipo_group){
    data.frame(dm2%>%select(cohort),dm2[,grep(i,names(dm2))])%>%pivot_longer(cols = !cohort,names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = cohort, y = val,fill = cohort))+geom_boxplot()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+facet_wrap_paginate(~lipo,scales = "free")->p2
  
  plot(p2)

}

```

# 5Mar2024
```{r}
nodm <- bus[which(bus$DM == "NO DM" & bus$comb != "Underweight_NODM"),] 

library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

# raw - NO DM
for(i in lipo_group){
    data.frame(nodm%>%select(BMI.weight, comb, TPTG:H1A2),nodm[,grep(i,names(nodm))])%>%pivot_longer(cols = !c(BMI.weight, comb),names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = BMI.weight, y = val,fill = comb))+geom_boxplot()+facet_wrap_paginate(~lipo,scales = "free")->p1
  
  plot(p1)

}

lipolist <- colnames(nodm[1:112])

for (i in lipolist){
  nodm %>% ggplot(aes(x = BMI.weight, y = i, fill =comb))+geom_boxplot() -> p
  plot(p)
}

nodm %>% ggplot(aes(x = BMI.weight, y = L2TG,fill = comb))+geom_boxplot() 

```




## Fig 1 -significant lipos only amongst NO DM 
To see which lipoproteins are significantly different after adjusting for age, sex, cohort amongst non-diabetics -- this could be due to the different ethnicity? 
```{r}
library(ggforce)

lipo_sig <- c("IDTG", "L3TG", "TPTG", "V1TG", "V2TG", "V3TG", "VLTG", "V1CH", "V2CH", "V3CH", "VLCH", "H1FC", "V1FC", "V2FC", "V3FC", "IDPL", "V1PL", "V2PL", "V3PL")

signodm <- bus_sau2[, c("cohort", lipo_sig)] %>% filter(bus_sau2$DM == "NO DM")

# significant lipos  only - corrected Lipo for age, sex, cohort - NO DM
signodm %>% pivot_longer(cols = !cohort, names_to = "lipo", values_to = "val") %>% 
    ggplot(aes(x = cohort, y = val,fill = cohort))+geom_boxplot()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+facet_wrap_paginate(~lipo,scales = "free")

```


To see which lipoproteins are significantly different after adjusting for age, sex, cohort amongst DIABETICS -- this could be due to the different ethnicity? 
```{r}
library(ggforce)

lipo_sig2 <- c("L2TG", "L3TG", "L1CH", "L3CH", "L4CH", "LDCH", "TPCH", "L1FC", "L4FC", "LDFC", "H4PL", "L1PL", "L3PL", "L4PL", "LDPL", "L1AB", "L3AB", "L4AB", "LDAB", "TPAB")

sigdm <- bus_sau2[, c("cohort", lipo_sig2)] %>% filter(bus_sau2$DM == "DM2")

# significant lipos  only - corrected Lipo for age, sex, cohort - NO DM
sigdm %>% pivot_longer(cols = !cohort, names_to = "lipo", values_to = "val") %>% 
    ggplot(aes(x = cohort, y = val,fill = cohort))+geom_boxplot()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+facet_wrap_paginate(~lipo,scales = "free")

```



# Univariate lm - each lipo vs BMI
```{r}
lipoList <- colnames(bus_sau2[, 1:112])
ann <- bus_sau2[, 113:ncol(bus_sau2)]


# running lm
out <- vector('list', length(lipoList))
resid <- vector('list', length(lipoList))

for (i in seq_along(lipoList)){
  out[[i]] <- lm(paste(lipoList[i],  '~', 'bmi'),
               data = bus_sau2)
  resid[[i]] <- out[[i]]$residuals
}

# bind all the residuals together to form a matrix 
# resid <- do.call("cbind", resid)
# colnames(resid) <- colnames(bus_sau2[, 1:112])
# class(resid)
#[1] "matrix" "array"
# dim(resid)
#[1] 2158 112

```


# Checking numbers
```{r}
table(bus_sau2$comb, bus_sau2$cohort)

  #                  BUSSELTON SAUDI
  # Healthy_DM2             18     6
  # Healthy_NODM           502    57
  # Obese_DM2               81    44
  # Obese_NODM             480    51
  # Overweight_DM2          55     5
  # Overweight_NODM        834    19
  # Underweight_NODM         6     0

```


# BUS v SAU
## Healthy_DM2  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Healthy_DM2") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#        18         6 
X = m1[,1:112]

mod1 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 24 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.515     0.35  -0.203 0.373   1   1  0.4 0.4

# Q2Y
mod1@modelDF[["Q2"]][[1]]
#[1] 0.0417

save(mod1, file="oplsda_HW_DM2_BusvSau.rda")


mod1.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
mod1.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.30  0.93     0.60
# 2       1       2 0.34  0.94     0.69
# 3       1       3   NA  1.00     0.70
save(mod1.m8, file="oplsda_BUSvSau_HW_DM2_m8.rda") 


#plotScores(model=mod1, optns=list(color = m1$cohort, ellipse="hotellings", plotTitle = "OPLSDA - BUS v SAU - Healthy_DM2")) 

# plotscores - as per Diabesity paper
ddf1=data.frame(x=mod1@scoreMN, y=mod1@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=comb), size=4)+
   scale_shape_manual(values=c('Healthy_NODM'=16, 'Healthy_DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


plotLoadings(model = mod1, optns=list(plotTitle = "OPLSDA - BUS v SAU - Healthy_DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod1.m8) # Saudi is the reference data 
df # calling the plot
head(df$data) # to get top values
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_HealthyDM2_15122023.csv')

```


## Overweight_DM2  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Overweight_DM2") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#        55         5 
X = m1[,1:112]

mod2 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 60 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total     0.44   0.0835 0.00902 0.271   1   1 1.05 0.05

# Q2Y
mod2@modelDF[["Q2"]][[1]]
#[1] 0.0289

save(mod2, file="oplsda_Ow_DM2_BusvSau.rda")


mod2.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
mod2.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.21  0.87     0.69
# 2       1       2 0.23  0.93     0.74
# 3       1       3   NA  0.95     0.75
save(mod2.m8, file="oplsda_Ow_DM2_BUSvSau_m8.rda") # unbalanced number - be cautious at interpreting results!


# plotscores
ddf1=data.frame(x=mod2@scoreMN, y=mod2@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=comb), size=4)+
   scale_shape_manual(values=c('Overweight_NODM'=16, 'Overweight_DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod2, optns=list(plotTitle = "OPLSDA - BUS v SAU - Overweight_DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod2.m8) # Saudi is the reference data 
df # calling the plot
head(df$data) # to get top values
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_OwDM2_14122023.csv')
```


## Obese_DM2  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Obese_DM2") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#        81       44 
X = m1[,1:112]

mod3 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 125 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.485    0.127 0.00386 0.452   1   1 0.05 0.05

# Q2Y
mod3@modelDF[["Q2"]][[1]]
#[1] 0.0417

save(mod3, file="oplsda_Ob_DM2_BusvSau.rda")


mod3.m8 <- metabom8::opls(X, Y, scale="UV", center = TRUE)
mod3.m8@summary
#   PC_pred PC_orth R2X AUROC AUROC_CV
# 1       1       1 0.3  0.76     0.62
# 2       1       2  NA  0.76     0.65
save(mod3.m8, file="oplsda_Ob_DM2_BUSvSau_m8.rda") 

# plotscores
ddf1=data.frame(x=mod3@scoreMN, y=mod3@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=comb), size=4)+
   scale_shape_manual(values=c('Obese_NODM'=16, 'Obese_DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod3, optns=list(plotTitle = "OPLSDA - BUS v SAU - Obese_DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod3.m8) # Saudi is the reference data 
df # calling the plot
head(df$data) # to get top values
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_ObDM2_14122023.csv')
```

## All weight_DM2
```{r}
m1=bus_sau2[which(bus_sau2$DM == "DM2") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#       154        55 

X = m1[,1:112]

mod4 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 209 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.378   0.0769 -0.0182 0.426   1   1  0.1 0.2

# Q2Y
mod4@modelDF[["Q2"]][[1]]
#[1] 0.0125

save(mod4, file="oplsda_allweight_DM2_BusvSau.rda")


mod4.m8 <- metabom8::opls(X, Y, scale="UV", center = TRUE)
mod4.m8@summary
#   PC_pred PC_orth R2X AUROC AUROC_CV
# 1       1       1 0.2  0.72     0.61
# 2       1       2  NA  0.73     0.62
save(mod4.m8, file="oplsda_allweight_DM2_BUSvSau_m8.rda") 

# plotscores
ddf1=data.frame(x=mod4@scoreMN, y=mod4@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod4, optns=list(plotTitle = "OPLSDA - BUS v SAU - All weight_DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod4.m8) # Saudi is the reference data 
df # calling the plot
head(df$data) # to get top values
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_AllWeightDM2_15122023.csv')
```


## All weight_NoDM
```{r}
m1=bus_sau2[which(bus_sau2$DM == "NO DM") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#     1822        127 

X = m1[,1:112]

mod5 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 1949 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum)  Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.393  0.00519 -0.00375 0.246   1   1 0.55 0.5

# Q2Y
mod5@modelDF[["Q2"]][[1]]
#[1] -0.000787

# R2X
mod5@modelDF[["R2X"]][[1]]
#[1] 0.0743

save(mod5, file="oplsda_allweight_NODM_BusvSau.rda")

# plotscores
ddf1=data.frame(x=mod5@scoreMN, y=mod5@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod5, optns=list(plotTitle = "OPLSDA - BUS v SAU - All weight_NoDM"))

mod5.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NM 15/12/2023.
# Kept failing as auroc_cv < 0.60. The highest I got was 0.59. 
# This suggests that not perhaps clumping their weight together was masking the BMI effect and hence the model detected 
# no separation between the cohort. 
# I will proceed with doing OPLSDA for NODM for each weight group. 


# figuring out top sig lipos # volcano plot can't be auto-produced so need to do this.  
library(rstatix)

lipoList <- colnames(m1[, 1:112])

out2 <- vector('list', length(lipoList))
adj.sig <- vector('list', length(lipoList))

for (i in seq_along(lipoList)){
  out2[[i]] <- wilcox_test(as.formula(paste(lipoList[i], '~', 'cohort')),
               data = m1) %>% adjust_pvalue()
  adj.sig[[i]] <- out2[[i]][["p.adj"]]
}

adj.sig2 <- do.call("cbind", adj.sig)
colnames(adj.sig2) <- lipoList
adj.sig3 <- t(adj.sig2)
colnames(adj.sig3)[1] <- "p_adj"

write.csv(adj.sig3, file = "BusvSau_AllWeightsNoDM_Wilcox_adj_sig.csv")

```


## Healthy_NODM  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Healthy_NODM") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#       502        57 
X = m1[,1:112]

mod6 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 559 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.415   0.0307 -0.0195 0.299   1   1 0.05 0.7

# Q2Y
mod6@modelDF[["Q2"]][[1]]
#[1] 0.00447

save(mod6, file="oplsda_Hw_NoDM_BusvSau.rda")


mod6.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
mod6.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.19  0.76     0.64
# 2       1       2   NA  0.77     0.68
save(mod6.m8, file="oplsda_Hw_NoDM_BUSvSau_m8.rda") # unbalanced number - be cautious at interpreting results!

# plotscores
ddf1=data.frame(x=mod6@scoreMN, y=mod6@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod6, optns=list(plotTitle = "OPLSDA - BUS v SAU - HealthyWeight_NoDM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod6.m8) # Saudi is the reference data 
df # calling the plot
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_HwNoDM_15122023.csv')
```


## Overweight_NODM  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Overweight_NODM") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#       834        19 
X = m1[,1:112]

mod7 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 853 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum)  Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.308   0.0101 -0.00102 0.147   1   1 0.45 0.15

# Q2Y
mod7@modelDF[["Q2"]][[1]]
#[1] -0.00223

save(mod7, file="oplsda_Ow_NoDM_BusvSau.rda")

mod7.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
mod7.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.12  0.73     0.63
# 2       1       2   NA  0.76     0.63
save(mod7.m8, file="oplsda_Ow_NoDM_BUSvSau_m8.rda") # unbalanced number - be cautious at interpreting results!


# plotscores
ddf1=data.frame(x=mod7@scoreMN, y=mod7@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod7, optns=list(plotTitle = "OPLSDA - BUS v SAU - Overweight_NoDM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod7.m8) # Saudi is the reference data 
df # calling the plot
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_OwNoDM_15122023.csv')
```


## Obese_NODM  
```{r}
m1=bus_sau2[which(bus_sau2$comb == "Obese_NODM") ,] 
Y = m1$cohort
table(Y) 
# BUSSELTON     SAUDI 
#       480        51
X = m1[,1:112]

mod8 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 531 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.493   0.0258 0.00686 0.292   1   1  0.2 0.05

# Q2Y
mod8@modelDF[["Q2"]][[1]]
#[1] 0.0113

save(mod8, file="oplsda_Ob_NoDM_BusvSau.rda")

mod8.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
mod8.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.31  0.68      0.6
# 2       1       2   NA  0.71      0.6
save(mod8.m8, file="oplsda_Ob_NoDM_BUSvSau_m8.rda") # unbalanced number - be cautious at interpreting results!


# plotscores
ddf1=data.frame(x=mod8@scoreMN, y=mod8@orthoScoreMN, m1[, 113:ncol(m1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=cohort, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('BUSSELTON' = 'green2', 'SAUDI' = 'orange')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = mod8, optns=list(plotTitle = "OPLSDA - BUS v SAU - Obese_NoDM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(mod8.m8) # Saudi is the reference data 
df # calling the plot
df=df$data
write.csv(df, file='cliffsdelta_BusvSau_ObNoDM_15122023.csv')
```



Investigating from BMI angle
# Busselton
## BMI
### Correlation
#### BMI v HW_NoDM
```{r}
bus1=bus_sau2[which(bus_sau2$cohort=="BUSSELTON") & (bus_sau2$comb=='Healthy_NODM'),]

plot(bus1$bmi, bus1$TPTG)
plot(bus1$bmi, bus1$TPCH)
plot(bus1$bmi, bus1$VLTG)
plot(bus1$bmi, bus1$IDTG)

bus2=bus_sau2[which(bus_sau2$cohort=="BUSSELTON") & (bus_sau2$comb=='Obese_DM2'),]

plot(bus2$bmi, bus2$TPTG)
plot(bus2$bmi, bus2$TPCH)
plot(bus2$bmi, bus2$VLTG)
plot(bus2$bmi, bus2$IDTG)


library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

nodm <- bus_sau2[which(bus_sau2$DM == "NO DM"),]

dm2 <- bus_sau2[which(bus_sau2$DM == "DM2"),]

hw_nodm <-bus_sau2[which(bus_sau2$comb=='Healthy_NODM'),]

ob_dm2 <- bus_sau2[which(bus_sau2$comb=='Obese_DM2'),]


for(i in lipo_group){
    data.frame(nodm%>%select(cohort, bmi),nodm[,grep(i,names(nodm))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = bmi, y = val,color = cohort))+geom_point()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+facet_wrap_paginate(~lipo,scales = "free")->p1
  
  plot(p1)

}


data.frame(nodm%>%select(cohort, bmi),nodm[,grep(i,names(nodm))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p1
  
  plot(p1)


data.frame(hw_nodm%>%select(cohort, bmi),hw_nodm[,grep(i,names(hw_nodm))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p2
  
  plot(p2)
  

  data.frame(ob_dm2%>%select(cohort, bmi),ob_dm2[,grep(i,names(ob_dm2))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p2
  
  plot(p2)


# ser_control2 %>% pivot_longer(cols = !c(U_Sample_title, classif, Company123), names_to = "param", values_to = "val") %>% ggplot(aes(x = factor(classif), y = val, color = factor(Company123))) +
#   geom_boxplot() +
#   facet_wrap(~param, scales = "free") +
#   labs(color = "Company") +
#   ggtitle("Boxplot IMPUTED ClinChem Serum SOM Node Classif vs. Company")


```




### Healthy_NODM v Overweight_NODM 
```{r}
# opls of NODM healthy vs overweight 
bus1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Overweight_NODM') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$BMI.weight
table(Y)
# Y
#    Healthy Overweight 
#       502        834

X = bus1[,1:112]

smod1.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 1336 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.447   0.0913  0.0793 0.462   1   1 0.05 0.05
save(smod1.b, file="oplsda_BUS_HW_NODM_OW_NODM.rda")

smod1.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod1.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.33  0.69     0.68
# 2       1       2   NA  0.69     0.68
save(smod1.b.m8, file="oplsda_BUS_HW_NODM_OW_NODM_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod1.b@scoreMN, y=smod1.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod1.b, optns=list(plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# plotscore
plotScores(model=smod1.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod1.b.m8) 
df # calling the plot 
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod1.b.m8,p_adj = "fdr")
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1

head(df_1$plot$data)
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_BUS_healthyNODM_owNODM_07122023.csv')


```

### Healthy_NODM v Obese_NODM 
```{r}
# opls of NODM healthy vs overweight 
bus1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Obese_NODM') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$BMI.weight
table(Y)
# Y
#    Healthy Overweight 
#       502        480

X = bus1[,1:112]

smod2.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 982 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.494    0.213     0.2 0.444   1   1 0.05 0.05

# Q2Y
smod2.b@modelDF[["Q2"]][[1]]
#[1] 0.18.
save(smod2.b, file="oplsda_BUS_HW_NODM_OB_NODM.rda")

smod2.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod2.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.36  0.78     0.77
# 2       1       2   NA  0.79     0.78
save(smod2.b.m8, file="oplsda_BUS_HW_NODM_OB_NODM_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod2.b@scoreMN, y=smod2.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod2.b, optns=list(plotTitle="BUSSELTON - Healthy No DM vs Obese No DM"))

# plotscore
plotScores(model=smod2.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Obese No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod2.b.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod2.b.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1
head(df_1$plot$data)
df_1=df_1$plot$data

write.csv(df_1, file='cliffsdelta_BUS_healthyNODM_ObNODM_07122023.csv')
```



### Overweight_NODM v Obese_NODM 
```{r}
# opls of NODM overweight v obese
bus1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Obese_NODM') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$BMI.weight
table(Y)
# Y
#      Obese Overweight 
#        480        834 

X = bus1[,1:112]

smod3.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 1314 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.486   0.0435  0.0334 0.471   1   1 0.05 0.05

# Q2Y
smod3.b@modelDF[["Q2"]][[1]]
#[1] 0.025
save(smod3.b, file="oplsda_BUS_OW_NODM_OB_NODM.rda")

smod3.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod3.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.28  0.63     0.61
# 2       1       2   NA  0.65     0.63
save(smod3.b.m8, file="oplsda_BUS_OW_NODM_OB_NODM_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod3.b@scoreMN, y=smod3.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod3.b, optns=list(plotTitle="BUSSELTON - Overweight No DM vs Obese No DM"))

# plotscore
plotScores(model=smod3.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Overweight No DM vs Obese No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod3.b.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod3.b.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
head(df_1$plot$data)
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_BUS_OwNODM_ObNODM_07122023.csv')

```


### Overweight_DM2 v Obese_DM2
```{r}
# opls of DM2 overweight v obese 
bus1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_DM2','Obese_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$BMI.weight
table(Y)
# Y
#      Obese Overweight 
#        81        55 

X = bus1[,1:112]

smod4.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 136 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.385    0.102 -0.0787  0.47   1   1 0.05 0.5

# Q2Y
smod4.b@modelDF[["Q2"]][[1]]
#[1] 0.025
save(smod4.b, file="oplsda_BUS_OW_DM2_OB_DM2.rda")

smod4.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod4.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.24  0.70     0.61
# 2       1       2   NA  0.72     0.58
save(smod4.b.m8, file="oplsda_BUS_OW_DM2_OB_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod4.b@scoreMN, y=smod4.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod4.b, optns=list(plotTitle="BUSSELTON - Overweight DM2 vs Obese DM2"))

# plotscore
#plotScores(model=smod1.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod4.b.m8) 
df # calling the plot
head(df$data) 
df=df$data
write.csv(df, file='cliffsdelta_BUS_OwDM2_ObDM2_07122023.csv')

```


Investigating from Diabetes angle
## T2DM
### Healthy_NODM v Healthy_DM2
#### Imbalanced - original samples
```{r}
# opls of Healthy NODM v Healthy DM2
bus1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Healthy_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$DM
table(Y)
# Y
#   DM2 NO DM 
#    18   502 

X = bus1[,1:112]

smod5.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 520 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.513   0.0337  0.0112  0.18   1   1  0.1 0.05

# Q2Y
smod5.b@modelDF[["Q2"]][[1]]
#[1] 0.025
save(smod5.b, file="oplsda_BUS_HW_NODM_HW_DM2.rda")

smod5.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod5.b.m8@summary
#  PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.31  0.80     0.65
# 2       1       2   NA  0.84     0.62
save(smod5.b.m8, file="oplsda_BUS_HW_NODM_HW_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod5.b@scoreMN, y=smod5.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Healthy_NODM'=16, 'Healthy_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Healthy_NODM'='grey', 'Healthy_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod5.b, optns=list(plotTitle="BUSSELTON - Healthy No DM vs Healthy DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod5.b.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod5.b.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_BUS_Hw_NODM_Hw_DM2_08122023.csv')
```

plotPRROC function
```{r}
#Run plotPRROC function
#Using function from https://github.com/phenological/mva-plots
plotPRROC<-function(model = NULL,x = NULL,y = NULL,PC = c(1,2),col = c("red","black"),caption = FALSE){
 if(!is.null(model)){
 if(class(model)[1]=="opls"){
 method<-model@typeC
 Y = as.numeric(factor(model@suppLs$y))
 x<--model@scoreMN[which(Y==PC[1])]
 y<--model@scoreMN[which(Y==PC[2])]
 }else{
 stop("model is not from ropls function, Try x and y input instead")
 }
 }
 if(is.null(model)){
 if(exists("x") &exists("y")){
 x<-x
 y<-y
 }else{
 stop("Please specify ropls model or x and y input")
 }
 }
 roc<-roc.curve(scores.class0 = x, scores.class1 = y, curve = TRUE)
 pr<-pr.curve(scores.class0 = x, scores.class1 = y, curve = TRUE)
 ROC<-data.frame(roc$curve[,1:2])
 PR<-data.frame(rev(pr$curve[,1]),rev(pr$curve[,2])) # reverse the order
 #PR<-data.frame(rev(pr$curve[,1]),(rev(pr$curve[,2])))
 names(ROC)<-names(PR)<-c("x","y")
 PR$y<-abs(1-PR$y) # change the scale for y axis
 #PR$y<-abs(PR$y)
 p1<-ggplot(ROC, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR, color = col[2])+
 theme_bw()+geom_abline(intercept = 0, linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name = "FPR",
 breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
 if(caption == TRUE){
 text<-paste0("AUC ROC: ", round(roc$auc,2),"\n","AUC PR: ", round(pr$auc.integral,2))
 p1<-p1+annotate("text", x = 0.5, y = 0.5, label = text, angle=45)
 }
 if(caption == FALSE){
 text<-paste0("AUC ROC: ", round(roc$auc,2),", AUC PR: ", round(pr$auc.integral,2))
 p1<-p1+labs(caption = text)
 }
 plot(p1)

 PRROC_plot<-list(plot = p1,PR = pr,ROC =roc)
 return(PRROC_plot)

}
```


#### Balanced - matched samples 
Fig 1A
```{r}
bus1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Healthy_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

hw_nodm <- bus1 %>% filter(comb == "Healthy_NODM")
hw_dm2 <- bus1 %>% filter(comb == "Healthy_DM2")

set.seed(123)
nodm <- hw_nodm[sample(nrow(hw_nodm), 18, replace = F), c(1:112)]
dm2 <- hw_dm2[sample(nrow(hw_dm2), 18, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM",18),rep("DM2",18)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
#save(model, file = "matched_oplsda_BUS_HW_NODM_HW_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Busselton Healthy Weight No DM (n = 18) vs DM2 (n = 18)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Busselton Healthy Weight No DM (n = 18) vs DM2 (n = 18)"))


#bh_vip <- ropls::getVipVn(bh_model)

bh_rocpr <- plotPRROC(bh_model, caption=TRUE)
#AUC ROC = 0.85, AUC PR = 0.83
Fig1A <- bh_rocpr$plot

Fig1A <- Fig1A+labs(title = "Busselton Healthy Weight No DM (n = 18) vs DM2 (n = 18)",
 subtitle = paste0("R2X = ",bh_model@summaryDF$`R2X(cum)`,
 ", R2Y = ", bh_model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",bh_model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  bh_model@summaryDF$RMSEE),
 tag = "A")

Fig1A

rm(hw_nodm, hw_dm2, nodm, dm2, df, Y)

```


```{r}
bh_model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
bh_model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.36  0.87     0.72
# 2       1       2   NA  0.90     0.69

#save(bh_model.m8, file="matched_oplsda_BUS_HW_NODM_HW_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(bh_model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(bh_model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot
edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_BUS_Hw_NODM_Hw_DM2_01022024.csv')

```

### VIP plots or log-fold changes plot
```{r}
#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
  
  edf_1$logp = -log10(edf_1$pval)
  
  bh_smod =t(as.matrix(bh_model.m8@p_pred))
  bh_smod = data.frame(bh_smod)
  bh_smod$varname = (lipoList)

  idx = which(bh_smod$bh_smod < 0) # 48 lipos 
  flip = as.character(edf_1$id)[idx] 
  
  edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

  bh_p = data.frame(edf_1$id,edf_1$logp)
  colnames(bh_p) = c("varname","bh_p")

  Lipo_bh_p = cbind(bh_p)
  Lipo_bh_p = data.frame(Lipo_bh_p)

  lipo <- c(Lipo_bh_p$varname)
  value = c(Lipo_bh_p$bh_p)
  data<- data.frame(lipo, value)
  
  data$lipo=factor(data$lipo, levels = Lipo_bh_p$varname[order(Lipo_bh_p$bh_p)])
  
  ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+scale_fill_manual(values = c("red","blue"))+
    coord_flip()+
    xlab("")+ylab("-log10(p_values)")+ theme(legend.position='top',aspect.ratio =1.5 ,
                                            axis.text.x =element_text(color="black",size = 10),
                                            axis.text.y = element_text(color = "black",size = 8, angle = 0),
                                            axis.title.x = element_text(color = "black",size = 15, angle = 0),
                                            axis.title.y = element_text(color = "black", size = 8, angle = 90),
                                            legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 


rm(bh_p, bh_smod, data, dm2, edf, edf_1)  
```



#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=18 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""
bus_hw_nodm <- bus1 %>% filter(comb == "Healthy_NODM")
bus_hw_dm2 <- bus1 %>% filter(comb == "Healthy_DM2")

for(i in seq(iteration)){
 bh_nodm <- bus_hw_nodm[sample(nrow(bus_hw_nodm), 18, replace = F), c(1:112)]
 bh_dm2 <- bus_hw_dm2[sample(nrow(bus_hw_dm2), 18, replace = F), c(1:112)]
 df <- rbind(bh_nodm,bh_dm2)
 Y <- factor(c(rep("No DM",18),rep("DM2",18)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(bh_nodm,bh_dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")
```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Busselton Healthy Weight No DM (n = 18) vs DM2 (n = 18)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B
```


n=16 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""
bus_hw_nodm <- bus3 %>% filter(comb == "Healthy_NODM")
bus_hw_dm2 <- bus3 %>% filter(comb == "Healthy_DM2")

for(i in seq(iteration)){
 bh_nodm <- bus_hw_nodm[sample(nrow(bus_hw_nodm), 16, replace = F), c(1:112)]
 bh_dm2 <- bus_hw_dm2[sample(nrow(bus_hw_dm2), 16, replace = F), c(1:112)]
 df <- rbind(bh_nodm,bh_dm2)
 Y <- factor(c(rep("No DM",16),rep("DM2",16)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(bh_nodm,bh_dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")
```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Busselton Healthy Weight No DM (n = 16) vs DM2 (n = 16)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B
```


### Overweight_NODM v Overweight_DM2
#### Imbalanced - original samples
```{r}
# opls of Overweight NODM v Overweight DM2
bus1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Overweight_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$DM
table(Y)
# Y
#   DM2 NO DM 
#    55   834 

X = bus1[,1:112]

smod6.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 889 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.479    0.019 -0.0122 0.239   1   1  0.1 0.55

# Q2Y
smod6.b@modelDF[["Q2"]][[1]]
#[1] -0.004
save(smod6.b, file="oplsda_BUS_OW_NODM_OW_DM2.rda")


smod6.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod6.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.26  0.70      0.6
# 2       1       2   NA  0.73      0.6
save(smod6.b.m8, file="oplsda_BUS_OW_NODM_OW_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod6.b@scoreMN, y=smod6.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Overweight_NODM'=16, 'Overweight_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Overweight_NODM'='grey', 'Overweight_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod6.b, optns=list(plotTitle="BUSSELTON - Overweight No DM vs Overweight DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod6.b.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod6.b.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_BUS_Ow_NODM_Ow_DM2_08122023.csv')

```


#### Matched samples 
Fig 1A
```{r}
bus1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Overweight_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

ow_nodm <- bus1 %>% filter(comb == "Overweight_NODM") #834
ow_dm2 <- bus1 %>% filter(comb == "Overweight_DM2")#55

set.seed(7)
nodm <- ow_nodm[sample(nrow(ow_nodm), 55, replace = F), c(1:112)]
dm2 <- ow_dm2[sample(nrow(ow_dm2), 55, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM",55),rep("DM2",55)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
#save(model, file="matched_oplsda_BUS_OW_NODM_OW_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Busselton Overweight No DM (n = 55) vs DM2 (n = 55)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Busselton Overweight No DM (n = 55) vs DM2 (n = 55)"))

#plotPRROC(model)
#AUC ROC = 0.72, AUC PR = 0.68
plot_rocpr <- plotPRROC(model, caption=TRUE)

Fig1A <- plot_rocpr$plot

Fig1A <- Fig1A+labs(title = "Busselton Overweight No DM (n = 55) vs DM2 (n = 55)",
 subtitle = paste0("R2X = ",model@summaryDF$`R2X(cum)`,
 ", R2Y = ", model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  model@summaryDF$RMSEE),
 tag = "A")

Fig1A
```


```{r}
model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.18  0.72     0.63
# 2       1       2   NA  0.76     0.67

save(model.m8, file="matched_oplsda_BUS_Ow_NODM_Ow_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot
edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_BUS_Ow_NODM_Ow_DM2_02022024.csv')


#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
edf_1$logp = -log10(edf_1$pval)
  
smod =t(as.matrix(model.m8@p_pred))
smod = data.frame(smod)
smod$varname = lipoList

idx = which(smod$smod<0) 
flip = as.character(edf_1$id)[idx] 

edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

p = data.frame(edf_1$id,edf_1$logp)
colnames(p) = c("varname","p")

lipo <- c(p$varname)
value = c(p$p)
data<- data.frame(lipo,value)
  
data$lipo=factor(data$lipo, levels = p$varname[order(p$p)])
  
ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+
    scale_fill_manual(values =c("red","blue"))+
    coord_flip()+
    xlab("")+
    ylab("-log10(p_values)") + 
    theme(legend.position='top',aspect.ratio =1.5 ,
          axis.text.x =element_text(color="black",size = 10),
          axis.text.y = element_text(color = "black",size = 8, angle = 0),
          axis.title.x = element_text(color = "black",size = 15, angle = 0),
          axis.title.y = element_text(color = "black", size = 8, angle = 90),
          legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 

```


#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=55 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""

for(i in seq(iteration)){
 nodm <- ow_nodm[sample(nrow(ow_nodm), 55, replace = F), c(1:112)]
 dm2 <- ow_dm2[sample(nrow(ow_dm2), 55, replace = F), c(1:112)]
 df <- rbind(nodm,dm2)
 Y <- factor(c(rep("No DM",55),rep("DM2",55)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(nodm,dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")

```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Busselton Overweight No DM (n = 55) vs DM2 (n = 55)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B

rm(X_ave, Y_ave, roc_ave, pr_ave, ROC_ave, PR_ave)
```


### Obese_NODM v Obese_DM2
```{r}
# opls of Obese NODM v Obese DM2
bus1=bus_sau2[which(bus_sau2$comb %in% c('Obese_NODM','Obese_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

Y = bus1$DM
table(Y)
# Y
#   DM2 NO DM 
#    81   480 

X = bus1[,1:112]

smod7.b = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 561 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.532   0.0683  0.0421  0.34   1   1 0.05 0.05

# Q2Y
smod7.b@modelDF[["Q2"]][[1]]
#[1] 0.04
save(smod7.b, file="oplsda_BUS_Ob_NODM_Ob_DM2.rda")


smod7.b.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod7.b.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.35  0.72     0.65
# 2       1       2   NA  0.76     0.64
save(smod7.b.m8, file="oplsda_BUS_Ob_NODM_Ob_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod7.b@scoreMN, y=smod7.b@orthoScoreMN, bus1[, 113:ncol(bus1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Obese_NODM'=16, 'Obese_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Obese_NODM'='grey', 'Obese_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod7.b, optns=list(plotTitle="BUSSELTON - Obese No DM vs Obese DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod7.b.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod7.b.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_BUS_Ob_NODM_Ob_DM2_08122023.csv')
```


#### Matched samples 
Fig 1A
```{r}
bus1=bus_sau2[which(bus_sau2$comb %in% c('Obese_NODM','Obese_DM2') & (bus_sau2$cohort=="BUSSELTON")) ,] 

ob_nodm <- bus1 %>% filter(comb == "Obese_NODM") #480
ob_dm2 <- bus1 %>% filter(comb == "Obese_DM2") #81

set.seed(7)
nodm <- ob_nodm[sample(nrow(ob_nodm), 81, replace = F), c(1:112)]
dm2 <- ob_dm2[sample(nrow(ob_dm2), 81, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM",81),rep("DM2",81)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")

plot_rocpr <- plotPRROC(model, caption=TRUE)

Fig1A <- plot_rocpr$plot

Fig1A <- Fig1A+labs(title = "Busselton Obese No DM (n = 81) vs DM2 (n = 81)",
 subtitle = paste0("R2X = ",model@summaryDF$`R2X(cum)`,
 ", R2Y = ", model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  model@summaryDF$RMSEE),
 tag = "A")

Fig1A

#save(model, file="matched_oplsda_BUS_Ob_NODM_Ob_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Busselton Obese No DM (n = 81) vs DM2 (n = 81)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Busselton Obese No DM (n = 81) vs DM2 (n = 81)"))

```


```{r}
model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.31  0.73     0.61
# 2       1       2   NA  0.76     0.59

save(model.m8, file="matched_oplsda_BUS_Ob_NODM_Ob_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot
edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_BUS_Ob_NODM_Ob_DM2_02022024.csv')


#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
edf_1$logp = -log10(edf_1$pval)
  
smod =t(as.matrix(model.m8@p_pred))
smod = data.frame(smod)
smod$varname = lipoList

idx = which(smod$smod<0) 
flip = as.character(edf_1$id)[idx] 

edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

p = data.frame(edf_1$id,edf_1$logp)
colnames(p) = c("varname","p")

lipo <- c(p$varname)
value = c(p$p)
data<- data.frame(lipo,value)
  
data$lipo=factor(data$lipo, levels = p$varname[order(p$p)])
  
ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+
    scale_fill_manual(values =c("red","blue"))+
    coord_flip()+
    xlab("")+
    ylab("-log10(p_values)") + 
    theme(legend.position='top',aspect.ratio =1.5 ,
          axis.text.x =element_text(color="black",size = 10),
          axis.text.y = element_text(color = "black",size = 8, angle = 0),
          axis.title.x = element_text(color = "black",size = 15, angle = 0),
          axis.title.y = element_text(color = "black", size = 8, angle = 90),
          legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 

```


#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=81 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""

for(i in seq(iteration)){
 nodm <- ob_nodm[sample(nrow(ob_nodm), 81, replace = F), c(1:112)]
 dm2 <- ob_dm2[sample(nrow(ob_dm2), 81, replace = F), c(1:112)]
 df <- rbind(nodm,dm2)
 Y <- factor(c(rep("No DM",81),rep("DM2",81)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(nodm,dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")

```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Busselton Obese No DM (n = 81) vs DM2 (n = 81)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B

rm(X_ave, Y_ave, roc_ave, pr_ave, ROC_ave, PR_ave)
```


# Saudi
## BMI
### Correlation BMI v lipo
```{r}
library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

sau <- bus_sau2[which(bus_sau2$cohort=='SAUDI'),]

for(i in lipo_group){
    data.frame(sau%>%select(bmi),sau[,grep(i,names(sau))])%>%pivot_longer(cols = !c(bmi), names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = bmi, y = val, color = bmi ))+geom_point()+stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth") +facet_wrap_paginate(~lipo,scales = "free")->p1
  
  plot(p1)

}

sau2 <- bus_sau2[which(bus_sau2$cohort=='SAUDI' & bus_sau2$DM == "DM2"),]

for(i in lipo_group){
    data.frame(sau2%>%select(bmi),sau2[,grep(i,names(sau2))])%>%pivot_longer(cols = !c(bmi), names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = bmi, y = val, color = bmi ))+geom_point()+stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth") +facet_wrap_paginate(~lipo,scales = "free")->p2
  
  plot(p2)

}


sau3 <- bus_sau2[which(bus_sau2$cohort=='SAUDI' & bus_sau2$DM == "NO DM"),]

for(i in lipo_group){
    data.frame(sau3%>%select(bmi),sau3[,grep(i,names(sau3))])%>%pivot_longer(cols = !c(bmi), names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = bmi, y = val, color = bmi ))+geom_point()+stat_smooth(method = "lm", 
              formula = y ~ x, 
              geom = "smooth") + stat_cor(aes(label=..rr.label..), label.x=40, label.y=200, size = 3) + facet_wrap_paginate(~lipo,scales = "free")->p3
  
  plot(p3)

}


# data.frame(nodm%>%select(cohort, bmi),nodm[,grep(i,names(nodm))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
# ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p1
#   
#   plot(p1)
# 
# 
# data.frame(hw_nodm%>%select(cohort, bmi),hw_nodm[,grep(i,names(hw_nodm))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
# ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p2
#   
#   plot(p2)
#   
# 
#   data.frame(ob_dm2%>%select(cohort, bmi),ob_dm2[,grep(i,names(ob_dm2))])%>%pivot_longer(cols = !c(cohort, bmi), names_to = "lipo",values_to = "val")%>%
# ggplot(aes(x = bmi, y = val, color = cohort))+geom_point()+facet_wrap_paginate(~lipo,scales = "free")->p2
#   
#   plot(p2)


```

### Investigation
##### Overweight_NODM
Investigating why for Saudi cohort, Overweight_NODM is more extreme than Obese_NODM
Maybe there is/are some outliers that are hyperlidimia that pulled everyone out of whack - esp
since the n for Overweight_NODM = 19 vs n for Obese_NODM = 51.
```{r}
sau4 <- bus_sau2[which(bus_sau2$cohort=='SAUDI' & bus_sau2$DM == "NO DM"),]

library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

# corrected Lipo for age, sex, cohort - NO DM
for(i in lipo_group){
    data.frame(sau4%>%select(comb, BMI.weight),sau4[,grep(i,names(sau4))])%>%pivot_longer(cols = !c(BMI.weight, comb),names_to = "lipo",values_to = "val")%>%
    ggplot(aes(x = BMI.weight, y = val,fill = comb))+geom_boxplot() + 
  facet_wrap_paginate(~lipo,scales = "free")->p1
  #+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)
  
  plot(p1)

}

table(sau4$comb)

library(gtsummary)
data.frame(group = sau4%>%select(comb),
            sau4%>%select(TPTG:H4A2))%>%tbl_summary(by = comb)%>%
  as_gt() %>% gt::gtsave(filename = "SAU_NoDM.docx")

# tbl %>%
#   as_gt() %>%
#   gt::gtsave(filename = ".") # use extensions .png, .html, .docx, .rtf, .tex, .ltx


```



### Healthy_NODM v Healthy_DM2
```{r}
sau1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Overweight_NODM') & (bus_sau2$cohort=="SAUDI")) ,] #76
Y = sau1$BMI.weight
table(Y)
# Y
#    Healthy Overweight 
#         57         19 
X = sau1[,1:112]

smod1.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 76 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.443    0.154   -0.05 0.406   1   1 0.25 0.25

# R2X-1st component = 0.23, Q2Y - first component = 0.05
save(smod1.s, file="oplsda_SAU_HW_NODM_OW_NODM.rda")


smod1.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod1.s.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.25  0.76     0.60
# 2       1       2   NA  0.79     0.61
save(smod1.s.m8, file="oplsda_SAU_HW_NODM_OW_NODM_m8.rda")
# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod1.s@scoreMN, y=smod1.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2



# plotload
plotLoadings(model = smod1.s, optns=list(plotTitle="SAUDI - Healthy No DM vs Overweight No DM"))

# plotscore
# plotScores(model=smod1.s, optns=list(color = sau1$BMI.weight, ellipse="hotellings", plotTitle="SAUDI - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod1.s.m8) 
df # calling the plot
head(df$data) 
df=df$data
write.csv(df, file='cliffsdelta_SAU_HW_NODM_OW_NODM_07122023.csv')

# figuring out top sig lipos # not quite needed if volcano plot can be produced. But still useful if ever necessary. 

library(rstatix)

lipoList <- colnames(sau1[, 1:112])

out2 <- vector('list', length(lipoList))
adj.sig <- vector('list', length(lipoList))

for (i in seq_along(lipoList)){
  out2[[i]] <- wilcox_test(as.formula(paste(lipoList[i], '~', 'BMI.weight')),
               data = sau1) %>% adjust_pvalue()
  adj.sig[[i]] <- out2[[i]][["p.adj"]]
}

adj.sig2 <- do.call("cbind", adj.sig)
colnames(adj.sig2) <- lipoList
adj.sig3 <- t(adj.sig2)
colnames(adj.sig3)[1] <- "p_adj"

write.csv(adj.sig3, file = "Sau_healthyNODM_owNODM_Wilcox_adj_sig.csv")

```


### Healthy_NODM v Obese_NODM 
```{r}
# opls of NODM healthy vs overweight 
sau1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Obese_NODM') & (bus_sau2$cohort=="SAUDI")) ,] 

Y = sau1$BMI.weight
table(Y)
# Y
#    Healthy   Obese 
#       57        51

X = sau1[,1:112]

smod2.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 108 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.406    0.166 -0.0473 0.462   1   1 0.05 0.25

# Q2Y
smod2.s@modelDF[["Q2"]][[1]]
#[1] 0.02
save(smod2.s, file="oplsda_SAU_HW_NODM_OB_NODM.rda")

smod2.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod2.s.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.18  0.78     0.62
# 2       1       2   NA  0.79     0.65
save(smod2.s.m8, file="oplsda_SAU_HW_NODM_OB_NODM_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod2.s@scoreMN, y=smod2.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod2.s, optns=list(plotTitle="SAUDI - Healthy No DM vs Obese No DM"))

# plotscore
#plotScores(model=smod1.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod2.s.m8) 
df # calling the plot
head(df$data)
df=df$data
write.csv(df, file='cliffsdelta_SAU_healthyNODM_ObNODM_07122023.csv')
```


### Overweight_NODM v Obese_NODM 
```{r}
# opls of NODM overweight v obese
sau1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Obese_NODM') & (bus_sau2$cohort=="SAUDI")) ,] 

Y = sau1$BMI.weight
table(Y)
# Y
#      Obese Overweight 
#        51        19 

X = sau1[,1:112]

smod3.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 70 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum)   Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.364    0.229 -0.000975 0.399   1   1 0.05 0.1

# Q2Y
smod3.s@modelDF[["Q2"]][[1]]
#[1] 0.0137
save(smod3.s, file="oplsda_SAU_OW_NODM_OB_NODM.rda")

smod3.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
# smod3.s.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.13  0.84     0.64
# 2       1       2   NA  0.86     0.65
save(smod3.s.m8, file="oplsda_SAU_OW_NODM_OB_NODM_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod3.s@scoreMN, y=smod3.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod3.s, optns=list(plotTitle="SAUDI - Overweight No DM vs Obese No DM"))

# plotscore
#plotScores(model=smod1.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod3.s.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod3.s.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
head(df_1$plot$data)
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_Sau_OwNODM_ObNODM_08122023.csv')

```



### Overweight_DM2 v Obese_DM2
```{r}
# opls of DM2 overweight v obese 
sau1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_DM2','Obese_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

Y = sau1$BMI.weight
table(Y)
# Y
#      Obese Overweight 
#        44        5 

X = sau1[,1:112]

smod4.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 49 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.473    0.156 -0.0531 0.287   1   1 0.55 0.2

# Q2Y
smod4.s@modelDF[["Q2"]][[1]]
#[1] 0.04
save(smod4.s, file="oplsda_SAU_OW_DM2_OB_DM2.rda")

smod4.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod4.s.m8@summary
#  PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.31  0.95     0.73
# 2       1       2   NA  0.96     0.73
save(smod4.s.m8, file="oplsda_SAU_OW_DM2_OB_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod4.s@scoreMN, y=smod4.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=BMI.weight, shape=DM), size=4)+
   scale_shape_manual(values=c('NO DM'=16, 'DM2'=15))+
   scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod4.b, optns=list(plotTitle="SAUDI - Overweight DM2 vs Obese DM2"))

# plotscore
#plotScores(model=smod1.b, optns=list(color = bus1$BMI.weight, ellipse="hotellings", plotTitle="BUSSELTON - Healthy No DM vs Overweight No DM"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod4.s.m8) 
df # calling the plot
head(df$data) 
df=df$data
write.csv(df, file='cliffsdelta_SAU_OwDM2_ObDM2_08122023.csv')
```


## T2DM
### Healthy_NODM v Healthy_DM2
#### Imbalanced - original samples 
```{r}
# opls of Healthy NODM v Healthy DM2
sau1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Healthy_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 
Y = sau1$DM
table(Y)
# Y
#   DM2 NO DM 
#    6   57 

X = sau1[,1:112]

smod5.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 63 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.364    0.354 0.00608 0.242   1   1 0.05 0.05

# Q2Y
smod5.s@modelDF[["Q2"]][[1]]
#[1] 0.003
save(smod5.s, file="oplsda_SAU_HW_NODM_HW_DM2.rda")

smod5.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod5.s.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.14  0.98     0.78
# 2       1       2   NA  0.99     0.77
save(smod5.s.m8, file="oplsda_SAU_HW_NODM_HW_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod5.s@scoreMN, y=smod5.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Healthy_NODM'=16, 'Healthy_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Healthy_NODM'='grey', 'Healthy_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod5.s, optns=list(plotTitle="SAUDI - Healthy No DM vs Healthy DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod5.s.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod5.s.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_SAU_Hw_NODM_Hw_DM2_08122023.csv')
```

#### Matched samples 
Fig 1A
```{r}
sau1=bus_sau2[which(bus_sau2$comb %in% c('Healthy_NODM','Healthy_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

hw_nodm <- sau1 %>% filter(comb == "Healthy_NODM") #57
hw_dm2 <- sau1 %>% filter(comb == "Healthy_DM2") #6

set.seed(7)
nodm <- hw_nodm[sample(nrow(hw_nodm), 6, replace = F), c(1:112)]
dm2 <- hw_dm2[sample(nrow(hw_dm2), 6, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM",6),rep("DM2",6)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")

plot_rocpr <- plotPRROC(model, caption=TRUE)

Fig1A <- plot_rocpr$plot

Fig1A <- Fig1A+labs(title = "Saudi Healthy weight No DM (n = 6) vs DM2 (n = 6)",
 subtitle = paste0("R2X = ",model@summaryDF$`R2X(cum)`,
 ", R2Y = ", model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  model@summaryDF$RMSEE),
 tag = "A")

Fig1A

save(model, file="matched_oplsda_SAU_Hw_NODM_Hw_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Saudi Healthy weight No DM (n = 6) vs DM2 (n = 6)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Saudi Healthy weight No DM (n = 6) vs DM2 (n = 6)"))

```


```{r}
model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.15  0.97     0.69
# 2       1       2 0.20  1.00     0.75
# 3       1       3   NA  1.00     0.67

save(model.m8, file="matched_oplsda_SAU_Hw_NODM_Hw_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot
edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_SAU_Hw_NODM_Hw_DM2_02022024.csv')


#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
edf_1$logp = -log10(edf_1$pval)
  
smod =t(as.matrix(model.m8@p_pred))
smod = data.frame(smod)
smod$varname = lipoList

idx = which(smod$smod<0) 
flip = as.character(edf_1$id)[idx] 

edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

p = data.frame(edf_1$id,edf_1$logp)
colnames(p) = c("varname","p")

lipo <- c(p$varname)
value = c(p$p)
data<- data.frame(lipo,value)
  
data$lipo=factor(data$lipo, levels = p$varname[order(p$p)])
  
ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+
    scale_fill_manual(values =c("red","blue"))+
    coord_flip()+
    xlab("")+
    ylab("-log10(p_values)") + 
    theme(legend.position='top',aspect.ratio =1.5 ,
          axis.text.x =element_text(color="black",size = 10),
          axis.text.y = element_text(color = "black",size = 8, angle = 0),
          axis.title.x = element_text(color = "black",size = 15, angle = 0),
          axis.title.y = element_text(color = "black", size = 8, angle = 90),
          legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 

```


#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=6 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""

for(i in seq(iteration)){
 nodm <- hw_nodm[sample(nrow(hw_nodm), 6, replace = F), c(1:112)]
 dm2 <- hw_dm2[sample(nrow(hw_dm2), 6, replace = F), c(1:112)]
 df <- rbind(nodm,dm2)
 Y <- factor(c(rep("No DM",6),rep("DM2",6)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(nodm,dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")

```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Saudi Healthy Weight No DM (n = 6) vs DM2 (n = 6)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B

rm(X_ave, Y_ave, roc_ave, pr_ave, ROC_ave, PR_ave)
```





### Overweight_NODM v Overweight_DM2
#### Imbalanced - original samples
```{r}
# opls of Overweight NODM v Overweight DM2
sau1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Overweight_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

Y = sau1$DM
table(Y)
# Y
#   DM2 NO DM 
#    5   19 

X = sau1[,1:112]

smod6.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 24 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y pQ2
# Total    0.455    0.376  -0.223 0.343   1   1  0.3 0.4

# Q2Y
smod6.s@modelDF[["Q2"]][[1]]
#[1] -0.004
save(smod6.s, file="oplsda_SAU_OW_NODM_OW_DM2.rda")


smod6.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod6.s.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.24  0.98     0.86
# 2       1       2   NA  0.99     0.72

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod6.s@scoreMN, y=smod6.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Overweight_NODM'=16, 'Overweight_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Overweight_NODM'='grey', 'Overweight_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod6.s, optns=list(plotTitle="SAUDI - Overweight No DM vs Overweight DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod6.s.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod6.s.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_SAU_Ow_NODM_Ow_DM2_08122023.csv')
```


#### Matched samples 
Fig 1A
```{r}
sau1=bus_sau2[which(bus_sau2$comb %in% c('Overweight_NODM','Overweight_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

ow_nodm <- sau1 %>% filter(comb == "Overweight_NODM") #19
ow_dm2 <- sau1 %>% filter(comb == "Overweight_DM2") #5

set.seed(7)
nodm <- ow_nodm[sample(nrow(ow_nodm), 5, replace = F), c(1:112)]
dm2 <- ow_dm2[sample(nrow(ow_dm2), 5, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM",5),rep("DM2",5)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")

plot_rocpr <- plotPRROC(model, caption=TRUE)

Fig1A <- plot_rocpr$plot

Fig1A <- Fig1A+labs(title = "Saudi Overweight No DM (n = 5) vs DM2 (n = 5)",
 subtitle = paste0("R2X = ",model@summaryDF$`R2X(cum)`,
 ", R2Y = ", model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  model@summaryDF$RMSEE),
 tag = "A")

Fig1A

save(model, file="matched_oplsda_SAU_Ow_NODM_Ow_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Saudi Overweight No DM (n = 5) vs DM2 (n = 5)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Saudi Overweight No DM (n = 5) vs DM2 (n = 5)"))

```


```{r}
model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.27     1     0.80
# 2       1       2 0.29     1     0.88
# 3       1       3   NA     1     0.84

save(model.m8, file="matched_oplsda_SAU_Ow_NODM_Ow_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot

edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_SAU_Ow_NODM_Ow_DM2_02022024.csv')


#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
edf_1$logp = -log10(edf_1$pval)
  
smod =t(as.matrix(model.m8@p_pred))
smod = data.frame(smod)
smod$varname = lipoList

idx = which(smod$smod<0) 
flip = as.character(edf_1$id)[idx] 

edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

p = data.frame(edf_1$id,edf_1$logp)
colnames(p) = c("varname","p")

lipo <- c(p$varname)
value = c(p$p)
data<- data.frame(lipo,value)
  
data$lipo=factor(data$lipo, levels = p$varname[order(p$p)])
  
ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+
    scale_fill_manual(values =c("red","blue"))+
    coord_flip()+
    xlab("")+
    ylab("-log10(p_values)") + 
    theme(legend.position='top',aspect.ratio =1.5 ,
          axis.text.x =element_text(color="black",size = 10),
          axis.text.y = element_text(color = "black",size = 8, angle = 0),
          axis.title.x = element_text(color = "black",size = 15, angle = 0),
          axis.title.y = element_text(color = "black", size = 8, angle = 90),
          legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 

```


#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=5 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""

for(i in seq(iteration)){
 nodm <- ow_nodm[sample(nrow(ow_nodm), 5, replace = F), c(1:112)]
 dm2 <- ow_dm2[sample(nrow(ow_dm2), 5, replace = F), c(1:112)]
 df <- rbind(nodm,dm2)
 Y <- factor(c(rep("No DM",5),rep("DM2",5)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(nodm,dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")

```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Saudi Overweight No DM (n = 5) vs DM2 (n = 5)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B

rm(X_ave, Y_ave, roc_ave, pr_ave, ROC_ave, PR_ave)
```




### Obese_NODM v Obese_DM2
#### Imbalanced - original samples
```{r}
# opls of Obese NODM v Obese DM2
sau1=bus_sau2[which(bus_sau2$comb %in% c('Obese_NODM','Obese_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

Y = sau1$DM
table(Y)
# Y
#   DM2 NO DM 
#    44   51 

X = sau1[,1:112]

smod7.s = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 95 samples x 112 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.468    0.166 -0.0632 0.463   1   1  0.1 0.45

# Q2Y
smod7.s@modelDF[["Q2"]][[1]]
#[1] 0.06
save(smod7.s, file="oplsda_SAU_Ob_NODM_Ob_DM2.rda")


smod7.s.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)
smod7.s.m8@summary
#   PC_pred PC_orth R2X AUROC AUROC_CV
# 1       1       1 0.3  0.77     0.61
# 2       1       2  NA  0.81     0.60
save(smod7.s.m8, file="oplsda_SAU_Ob_NODM_Ob_DM2_m8.rda")

# plotscores - as per Diabesity paper
ddf1=data.frame(x=smod7.s@scoreMN, y=smod7.s@orthoScoreMN, sau1[, 113:ncol(sau1)])

g1=ggplot()+
   geom_point(data=ddf1, aes(p1, o1, colour=comb, shape=comb), size=4)+
   scale_shape_manual(values=c('Obese_NODM'=16, 'Obese_DM2'=15))+
  #scale_color_manual(values=c('Healthy' = 'grey','Overweight'='orange', 'Obese'='cyan')) +
   scale_color_manual(values=c('Obese_NODM'='grey', 'Obese_DM2'='maroon'))+
   #scale_color_manual(values=c('NO DM'='grey', 'DM2' = 'maroon')) + 
   theme_bw()+
   theme(legend.position='top')+
   labs(colour=NULL, x=expression("pred score"), y=expression("orth score"))+
   guides(colour = guide_legend(override.aes = list(shape = 17)))

g1

 n <- nrow(ddf1)

hotFisN <- (n - 1) * 2 * (n^2 - 1) / (n^2 * (n - 2)) * qf(0.95, 2, n - 2)

ellipse <- gg_circle(rx = sqrt(var(ddf1$p1) * hotFisN),
                           ry = sqrt(var(ddf1$o1) * hotFisN),
                           xc = 0,
                           yc = 0)

g1_2 <- g1 + ellipse
g1_2


# plotload
plotLoadings(model = smod7.s, optns=list(plotTitle="SAUDI - Obese No DM vs Obese DM2"))

# eruption plot - MUST use oplsda model built by metabom8 
df=eruption(smod7.s.m8) 
df # calling the plot
# plot needs flipping:
#to flip the eruption plot!
df_1=eruption(smod7.s.m8,p_adj = "fdr") 
df_1$plot$data$Cd<--df_1$plot$data$Cd
df_1$plot
df_1=df_1$plot$data
write.csv(df_1, file='cliffsdelta_SAU_Ob_NODM_Ob_DM2_08122023.csv')
```



#### Matched samples 
Fig 1A
```{r}
sau1=bus_sau2[which(bus_sau2$comb %in% c('Obese_NODM','Obese_DM2') & (bus_sau2$cohort=="SAUDI")) ,] 

ob_nodm <- sau1 %>% filter(comb == "Obese_NODM") #51
ob_dm2 <- sau1 %>% filter(comb == "Obese_DM2") #44

set.seed(365)
nodm <- ob_nodm[sample(nrow(ob_nodm), 44, replace = F), c(1:112)] 
dm2 <- ob_dm2[sample(nrow(ob_dm2), 44, replace = F), c(1:112)]
df <- rbind(nodm,dm2)
Y <- factor(c(rep("No DM", 44),rep("DM2", 44)))
model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")

plot_rocpr <- plotPRROC(model, caption=TRUE)

Fig1A <- plot_rocpr$plot

Fig1A <- Fig1A+labs(title = "Saudi Obese No DM (n = 44) vs DM2 (n = 44)",
 subtitle = paste0("R2X = ",model@summaryDF$`R2X(cum)`,
 ", R2Y = ", model@summaryDF$`R2Y(cum)`,
 ", Q2 = ",model@summaryDF$`Q2(cum)`,
 ", RMSEE = ",  model@summaryDF$RMSEE),
 tag = "A")

Fig1A

save(model, file="matched_oplsda_SAU_Ob_NODM_Ob_DM2.rda")

plotScores(model, optns=list(discretePalette = c("No DM" = "#00BFC4", "DM2" = "#F8766D"), plotTitle="Score plot - Saudi Obese No DM (n = 44) vs DM2 (n = 44)", colorTitle = "Condition"))

plotLoadings(model, optns=list(plotTitle = "Loading plot - Saudi Obese No DM (n = 44) vs DM2 (n = 44)"))

```


```{r}
model.m8 <- metabom8::opls(df, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
model.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.27  0.79     0.63
# 2       1       2   NA  0.81     0.66

save(model.m8, file="matched_oplsda_SAU_Ob_NODM_Ob_DM2_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(model.m8) 
edf # calling the plot
# plot needs flipping:
#to flip the eruption plot!
edf_1=eruption(model.m8,p_adj = "fdr") 
edf_1$plot$data$Cd<--edf_1$plot$data$Cd
edf_1$plot

edf_1=edf_1$plot$data
write.csv(edf_1, file='matched_cliffsdelta_SAU_Ob_NODM_Ob_DM2_02022024.csv')


#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work
edf_1$logp = -log10(edf_1$pval)
  
smod =t(as.matrix(model.m8@p_pred))
smod = data.frame(smod)
smod$varname = lipoList

idx = which(smod$smod<0) 
flip = as.character(edf_1$id)[idx] 

edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

p = data.frame(edf_1$id,edf_1$logp)
colnames(p) = c("varname","p")

lipo <- c(p$varname)
value = c(p$p)
data<- data.frame(lipo,value)
  
data$lipo=factor(data$lipo, levels = p$varname[order(p$p)])
  
ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+
    scale_fill_manual(values =c("red","blue"))+
    coord_flip()+
    xlab("")+
    ylab("-log10(p_values)") + 
    theme(legend.position='top',aspect.ratio =1.5 ,
          axis.text.x =element_text(color="black",size = 10),
          axis.text.y = element_text(color = "black",size = 8, angle = 0),
          axis.title.x = element_text(color = "black",size = 15, angle = 0),
          axis.title.y = element_text(color = "black", size = 8, angle = 90),
          legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 

```


#### Bootstrapped matched samples
Run Receiver operating characteristic and Precision-recall curves for bootstrapped
balanced OPLS-DA lipoprotein admission models 
n=44 each
```{r}
#Run bootstrapped model with 100 random iterations
iteration = 100
X1<-Y1<-""

for(i in seq(iteration)){
 nodm <- ob_nodm[sample(nrow(ob_nodm), 44, replace = F), c(1:112)] 
 dm2 <- ob_dm2[sample(nrow(ob_dm2), 44, replace = F), c(1:112)]
 df <- rbind(nodm,dm2)
 Y <- factor(c(rep("No DM", 44),rep("DM2", 44)))
 model <- ropls::opls(df, y = Y, predI = 1, orthoI = 1, fig.pdfC = "none", info.txtC = "none")
 rm(Y)
 Y <- as.numeric(factor(model@suppLs$y))
 x <- -model@scoreMN[which(Y==1)]
 y <- -model@scoreMN[which(Y==2)]
 if(i == 1){
 X1 <- data.frame(x)
 Y1 <- data.frame(y)
 R2X <- model@summaryDF$`R2X(cum)`
 R2Y <- model@summaryDF$`R2Y(cum)`
 Q2 <- model@summaryDF$`Q2(cum)`
 RMSEE <- model@summaryDF$RMSEE
 } else{
 X1 <- cbind(X1, x)
 Y1 <- cbind(Y1, y)
 R2X <- c(R2X, model@summaryDF$`R2X(cum)`)
 R2Y <- c(R2Y, model@summaryDF$`R2Y(cum)`)
 Q2 <- c(Q2, model@summaryDF$`Q2(cum)`)
 RMSEE <- c(RMSEE, model@summaryDF$RMSEE)
 }
 rm(nodm,dm2,df,Y,model,x,y)
}

X_ave <- apply(X1, 1, mean, na.rm = TRUE)
Y_ave <- apply(Y1, 1, mean, na.rm = TRUE)
roc_ave <- roc.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
pr_ave <- pr.curve(scores.class0 = X_ave, scores.class1 = Y_ave, curve = TRUE)
ROC_ave <- data.frame(roc_ave$curve[,1:2])
PR_ave <- data.frame(rev(pr_ave$curve[,1]),rev(pr_ave$curve[,2])) # reverse the order
names(ROC_ave) <- names(PR_ave)<-c("x","y")
PR_ave$y <- abs(1 - PR_ave$y) # change the scale for y axis

col = c("red","black")

```


Combine bootstrapped admission PR-ROC curves - Figure 1B
```{r}
Fig1B <- ggplot(ROC_ave, aes(x, y)) +
 geom_line(color = col[1]) +
 geom_line(data = PR_ave, color = col[2])+
 theme_bw()+
 geom_abline(intercept = 0,linetype = "dashed")+
 scale_y_continuous(name = "Sensitivity", breaks = seq(0,1,0.2), sec.axis = sec_axis(~abs(.-1),
 name = "Precision", breaks = seq(0,1,0.2)))+
 scale_x_continuous(name = "Recall", breaks = seq(0,1,0.2), sec.axis = dup_axis(name =
 "FPR", breaks = seq(0,1,0.2)))+
 coord_fixed(ratio = 1)
R2X_ave = round(mean(R2X), 2)
R2Y_ave = round(mean(R2Y), 2)
Q2_ave = round(mean(Q2), 2)
RMSEE_ave = round(mean(RMSEE), 2)
text <- paste0("AUC ROC: ", round(roc_ave$auc,2), "\n", "AUC PR: ", round(pr_ave$auc.integral, 2)
)

Fig1B <- Fig1B + annotate("text", x = 0.5, y = 0.5, label = text, angle=45)+
 labs(title = paste0("Saudi Obese No DM (n = 44) vs DM2 (n = 44)"),
 subtitle = paste0("R2X = ", R2X_ave ,
 ", R2Y = ", R2Y_ave,
 ", Q2 = ", Q2_ave,
 ", RMSEE = ", RMSEE_ave),
 tag = "B")

Fig1B

rm(X_ave, Y_ave, roc_ave, pr_ave, ROC_ave, PR_ave)
```


# Radar plot

- will make 2 radar plots, one for Bus and one for Sau
- each plot will contain6 separate groups
1) Healthy No DM
2) Overweight No DM
3) Obese No DM
4) Healthy DM2
5) Overweight DM2
6) Obese DM2

## Busselton
```{r}
# Start with Busselton
library(ggpubr)
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb != "Underweight_NODM") %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_DM2    Healthy_NODM       Obese_DM2      Obese_NODM  Overweight_DM2 Overweight_NODM 
#         18             502              81             480              55             834 

lipo_name<-c("CH","TG","PL","FC","A")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white")+
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Busselton"), nrow = 2)



# tdf1<-data.frame(Healthy_DM2 = apply(na.omit(tdf%>%filter(comb=="Healthy_DM2")%>%select(contains(l))),2,median),                     Healthy_NODM = apply(na.omit(tdf%>%filter(comb=="Healthy_NODM")%>%select(contains(l))),2,median),                     Obese_DM2 = apply(na.omit(tdf%>%filter(comb=="Obese_DM2")%>%select(contains(l))),2,median),    
#                  Obese_NODM = apply(na.omit(tdf%>%filter(comb=="Obese_NODM")%>%select(contains(l))),2,median),  
#                  Overweight_NODM = apply(na.omit(tdf%>%filter(comb=="Overweight_NODM")%>%select(contains(l))),2,median),  
#       Overweight_DM2 = apply(na.omit(tdf%>%filter(comb=="Overweight_DM2")%>%select(contains(l))),2,median))
#       
# 
# # re-scale     
# for(j in 1:nrow(tdf1)){       tdf1[j,]<-tdf1[j,]/max(tdf1[j,])     }
# 
# tdf1<-data.frame(t(tdf1))
# 
# tdf1<-tdf1 %>%rownames_to_column(var = "Groups")
# 
# ggradar(tdf1,             plot.title = "radar plot",             values.radar = c("", "", ""),             group.point.size = 3,             group.line.width = 0.5,             axis.label.size = 4,             background.circle.colour = "white")+theme(     legend.key = element_rect(fill = NA, color = NA),     legend.background = element_blank(),     panel.background = element_blank(),     panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()   )

```


### NoDM only (Fig2 - Busselton)
```{r}
library(ggpubr)
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb != "Underweight_NODM") %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_DM2    Healthy_NODM       Obese_DM2      Obese_NODM  Overweight_DM2 Overweight_NODM 
#         18             502              81             480              55             834 

lipo_name<-c("CH","TG","PL","FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      # ), 2, median)
    )
  
  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white", 
    group.colours = lcols,
    plot.legend = FALSE)+ # to remove legend
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Busselton"), nrow = 2)


```


## Saudi
### with Overweight 
```{r}
library(ggpubr)
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & BMI.weight != "Underweight") %>%select(TPTG:H4A2,comb)

table(tdf$comb)
    # Healthy_DM2    Healthy_NODM       Obese_DM2      Obese_NODM  Overweight_DM2 Overweight_NODM 
    #           6              57              44              51               5              19

lipo_name<-c("CH","TG","PL","FC","A")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white")+
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Saudi"), nrow = 2)

```


#### SuppMat
```{r}
library(ggpubr)
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & BMI.weight != "Underweight") %>%select(TPTG:H4A2,comb)

table(tdf$comb)
    # Healthy_DM2    Healthy_NODM       Obese_DM2      Obese_NODM  Overweight_DM2 Overweight_NODM 
    #           6              57              44              51               5              19

lipo_name<-c("CH","TG","PL","FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      # ), 2, median)
    )
  
  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white",
    group.colours = lcols,
    plot.legend = FALSE)+ # to remove legend
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Saudi"), nrow = 2)

```



### Obese incl Overweight 
Combining Overweight and Obese together - mostly due to low number of overweight in Saudi 
```{r}
bus_sau2$comb2 = ""
bus_sau2$comb2[which(bus_sau2$comb %in% c("Overweight_NODM", "Obese_NODM"))] = "Obese_NODM"
bus_sau2$comb2[which(bus_sau2$comb == "Healthy_NODM")] = "Healthy_NODM"
bus_sau2$comb2[which(bus_sau2$comb %in% c("Overweight_DM2", "Obese_DM2"))] = "Obese_DM2"
bus_sau2$comb2[which(bus_sau2$comb == "Healthy_DM2")] = "Healthy_DM2"
```

#### Fig2 - Saudi
```{r}
library(ggpubr)
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & BMI.weight != "Underweight") %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Healthy_DM2 Healthy_NODM    Obese_DM2   Obese_NODM 
 #           6           57           49           70 

lipo_name<-c("CH","TG","PL","FC","A")


lcols <- c("#00BFC4", "#F8766D", "#FFC425")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white",
    group.colours = lcols)#,
    #plot.legend = FALSE)+ # to remove legend
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Saudi"), nrow = 2)

```




## Bus v Sau 
```{r}
# creating another combination category 
bus_sau2$comb2 = "" 
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Healthy_NODM")] = "Bus_Healthy_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Healthy_DM2")] = "Bus_Healthy_DM2"
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Obese_NODM")] = "Bus_Obese_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Obese_DM2")] = "Bus_Obese_DM2"
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Overweight_NODM")] = "Bus_Overweight_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "BUSSELTON" & bus_sau2$comb == "Overweight_DM2")] = "Bus_Overweight_DM2"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Healthy_NODM")] = "Sau_Healthy_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Healthy_DM2")] = "Sau_Healthy_DM2"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Obese_NODM")] = "Sau_Obese_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Obese_DM2")] = "Sau_Obese_DM2"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Overweight_NODM")] = "Sau_Overweight_NODM"
bus_sau2$comb2[which(bus_sau2$cohort == "SAUDI" & bus_sau2$comb == "Overweight_DM2")] = "Sau_Overweight_DM2"

save(bus_sau2, file="BUS_SAU_bus_sau2_14022024.rda")
```

### BMI = Healthy
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Healthy_NODM", "Bus_Healthy_DM2", "Sau_Healthy_NODM", "Sau_Healthy_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Bus_Healthy_DM2 Bus_Healthy_NODM  Sau_Healthy_DM2 Sau_Healthy_NODM 
 #              18              502                6               57 

lipo_name<-c("CH","TG","PL","FC","A")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Bus_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      Sau_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Sau_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_NODM") %>% select(contains(l))
      ), 2, median)
    )

  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white")+
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Busselton v Saudi"), nrow = 2)

```

### BMI = Overweight
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Overweight_NODM", "Bus_Overweight_DM2", "Sau_Overweight_NODM", "Sau_Overweight_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Bus_Overweight_DM2 Bus_Overweight_NODM  Sau_Overweight_DM2 Sau_Overweight_NODM 
 #                 55                 834                   5                  19

lipo_name<-c("CH","TG","PL","FC","A")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Overweight_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Overweight_DM2") %>% select(contains(l))
      ), 2, median),
      Bus_Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Overweight_NODM") %>% select(contains(l))
      ), 2, median),
      Sau_Overweight_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Overweight_DM2") %>% select(contains(l))
      ), 2, median),
      Sau_Overweight_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Overweight_NODM") %>% select(contains(l))
      ), 2, median)
    )

  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white")+
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Busselton v Saudi"), nrow = 2)

```


### BMI = Obese
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Obese_NODM", "Bus_Obese_DM2", "Sau_Obese_NODM", "Sau_Obese_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Bus_Obese_DM2 Bus_Obese_NODM  Sau_Obese_DM2 Sau_Obese_NODM 
 #            81            480             44             51 

lipo_name<-c("CH","TG","PL","FC","A")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Bus_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Sau_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Sau_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_NODM") %>% select(contains(l))
      ), 2, median)
    )

  # re-scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% rownames_to_column(var = "Groups")
  
  p<-ggradar(
    tdf1,
    plot.title = l,
    values.radar = c("", "", ""),
    group.point.size = 3,
    group.line.width = 0.5,
    axis.label.size = 4,
    background.circle.colour = "white")+
    theme(
    legend.key = element_rect(fill = NA, color = NA),
    legend.background = element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
    )
  
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],  p1_legend, top=("Busselton v Saudi"), nrow = 2)
             
```


# Parallel coordinates chart
```{r}
library(GGally)
library(ggpubr)

load("BUS_SAU_bus_sau2_28112023.rda")

```

## Busselton 
### redo - Non-diabetic HW vs Ob
```{r}
load("BUS_SAU_correctedLipo_ann_14022024.rda")
```

```{r}
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_NODM   Obese_NODM 
#          502          480 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")


p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton"), nrow=4) #nrow=4 is the best one. 

```


### redo - Diabetic HW vs Ob
```{r}
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb %in% c("Healthy_DM2", "Obese_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_DM2   Obese_DM2 
#          18          81 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")


p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      # Healthy_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      # ), 2, median),
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median)
      # Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton"), nrow=4) #nrow=4 is the best one. 

```


### redo - Non-diabetic HW vs Diabetic HW
```{r}
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Healthy_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_DM2   Obese_DM2 
#          18          81 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median)
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      # Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton"), nrow=4) #nrow=4 is the best one. 

```


### redo - Non-diabetic Ob vs Diabetic Ob
```{r}
tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb %in% c("Obese_NODM", "Obese_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
 # Obese_DM2 Obese_NODM 
 #        81        480 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      # Healthy_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      # ), 2, median)
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton"), nrow=4) #nrow=4 is the best one. 

```


## Saudi
### redo - Non-diabetic HW vs Ob
```{r}
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_NODM   Obese_NODM 
#          502          480 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")


p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Saudi"), nrow=4) #nrow=4 is the best one. 

```


### redo - Diabetic HW vs Ob
```{r}
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & comb %in% c("Healthy_DM2", "Obese_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_DM2   Obese_DM2 
#          18          81 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")


p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      # Healthy_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      # ), 2, median),
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median)
      # Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Saudi"), nrow=4) #nrow=4 is the best one. 

```



### redo - Non-diabetic HW vs Diabetic HW
```{r}
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Healthy_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
 # Healthy_DM2 Healthy_NODM 
 #           6           57 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median)
      # Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      # Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Saudi"), nrow=4) #nrow=4 is the best one. 

```


### redo - Non-diabetic Ob vs Diabetic Ob
```{r}
tdf <- bus_sau2 %>% filter(cohort == "SAUDI" & comb %in% c("Obese_NODM", "Obese_DM2")) %>%select(TPTG:H4A2,comb)

table(tdf$comb)
 # Obese_DM2 Obese_NODM 
 #        44         51  

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Healthy_DM2 = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      # ), 2, median),
      # Healthy_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      # ), 2, median)
      Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
      # Overweight_NODM = apply(na.omit(
      #   tdf %>% filter(comb == "Overweight_NODM") %>% select(contains(l))
      # ), 2, median),
      # Overweight_DM2 = apply(na.omit(
      #    tdf %>% filter(comb == "Overweight_DM2") %>% select(contains(l))
      #  ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Saudi"), nrow=4) #nrow=4 is the best one. 

```


## Bus and Sau - Diabetic HW v Non-diabetic HW
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Healthy_NODM", "Bus_Healthy_DM2", "Sau_Healthy_NODM", "Sau_Healthy_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Bus_Healthy_DM2 Bus_Healthy_NODM  Sau_Healthy_DM2 Sau_Healthy_NODM 
 #              18              502                6               57

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4", "magenta", "blue")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Bus_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      Sau_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Sau_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```


## Bus and Sau - Diabetic Ob v Non-diabetic Ob
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Obese_NODM", "Bus_Obese_DM2", "Sau_Obese_NODM", "Sau_Obese_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
 # Bus_Obese_DM2 Bus_Obese_NODM  Sau_Obese_DM2 Sau_Obese_NODM 
 #            81            480             44             51  

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4", "magenta", "blue")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Bus_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_NODM") %>% select(contains(l))
      ), 2, median),
      Sau_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_DM2") %>% select(contains(l))
      ), 2, median),
      Sau_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```


## Bus and Sau - Diabetic Ob 
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Obese_DM2", "Sau_Obese_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
# Bus_Obese_DM2 Sau_Obese_DM2 
#            81            44 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "magenta")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_DM2") %>% select(contains(l))
      ), 2, median),
      # Bus_Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb2 == "Bus_Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      Sau_Obese_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_DM2") %>% select(contains(l))
      ), 2, median)
      # Sau_Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb2 == "Sau_Obese_NODM") %>% select(contains(l))
      # ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```


## Bus and Sau - Diabetic HW 
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Healthy_DM2", "Sau_Healthy_DM2")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
# Bus_Healthy_DM2 Sau_Healthy_DM2 
#              18               6 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "magenta")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Bus_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      # Bus_Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb2 == "Bus_Obese_NODM") %>% select(contains(l))
      # ), 2, median),
      Sau_Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_DM2") %>% select(contains(l))
      ), 2, median)
      # Sau_Obese_NODM = apply(na.omit(
      #   tdf %>% filter(comb2 == "Sau_Obese_NODM") %>% select(contains(l))
      # ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```




## Bus and Sau - Non-diabetic Ob 
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Obese_NODM", "Sau_Obese_NODM")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
# Bus_Obese_NODM Sau_Obese_NODM 
#            480             51 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#00BFC4", "blue")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Bus_Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb2 == "Bus_Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Bus_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Obese_NODM") %>% select(contains(l))
      ), 2, median),
      # Sau_Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb2 == "Sau_Obese_DM2") %>% select(contains(l))
      # ), 2, median)
      Sau_Obese_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Obese_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```



## Bus and Sau - Non-Diabetic HW
```{r}
tdf <- bus_sau2 %>% filter(comb2 %in% c("Bus_Healthy_NODM", "Sau_Healthy_NODM")) %>%select(TPTG:H4A2,comb2)

table(tdf$comb2)
# Bus_Healthy_NODM Sau_Healthy_NODM 
#              502               57 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#00BFC4", "blue")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      # Bus_Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb2 == "Bus_Obese_DM2") %>% select(contains(l))
      # ), 2, median),
      Bus_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Bus_Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      # Sau_Obese_DM2 = apply(na.omit(
      #   tdf %>% filter(comb2 == "Sau_Obese_DM2") %>% select(contains(l))
      # ), 2, median)
      Sau_Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb2 == "Sau_Healthy_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton v Saudi"), nrow=4) #nrow=4 is the best one. 

```


# Weight comparison between cohort
Significantly different for the non-diabetic groups regardless of the weight. 

## HW Non-diabetic - sig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Healthy_NODM", "Sau_Healthy_NODM")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Healthy_NODM Sau_Healthy_NODM 
#              502               57

wilcox.test(weight ~ comb2, data = tdf)
# p-value = 6.55e-05
# the weight distribution in the two cohort sub-groups are nonidentical populations.
tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(weight),
            median = median(weight),
            max = max(weight))

#   comb2              min median   max
#   <chr>            <dbl>  <dbl> <dbl>
# 1 Bus_Healthy_NODM  43.9     64  92.4
# 2 Sau_Healthy_NODM  40       60  92.4
```

## HW Diabetic - notsig - small n for both esp. Saudi
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Healthy_DM2", "Sau_Healthy_DM2")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Healthy_DM2 Sau_Healthy_DM2 
#              18               6 

wilcox.test(weight ~ comb2, data = tdf)
# p-value = 0.1192
# the weight distribution in the two cohort sub-groups are identical populations.
tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(weight),
            median = median(weight),
            max = max(weight))

#   comb2              min median   max
#   <chr>            <dbl>  <dbl> <dbl>
# 1 Bus_Healthy_DM2    58   64.4  80.8
# 2 Sau_Healthy_DM2    67   69.4  71.4
```


## Obese Non-diabetic - sig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Obese_NODM", "Sau_Obese_NODM")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Obese_NODM Sau_Obese_NODM 
#            480             51

wilcox.test(weight ~ comb2, data = tdf)
#p-value = 2.366e-08 
# the weight distribution in the two cohort sub-groups are nonidentical populations.

tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(weight),
            median = median(weight),
            max = max(weight))

#   comb2            min median   max
#   <chr>          <dbl>  <dbl> <dbl>
# 1 Bus_Obese_NODM  68.1     95  140.
# 2 Sau_Obese_NODM  73.5    110  227   
```

## Obese Diabetic - notsig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Obese_DM2", "Sau_Obese_DM2")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Obese_DM2 Sau_Obese_DM2 
#            81            44 

wilcox.test(weight ~ comb2, data = tdf)
# p-value = 0.2147
# the weight distribution in the two cohort sub-groups are identical populations.

tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(weight),
            median = median(weight),
            max = max(weight))

#   comb2           min median   max
#   <chr>         <dbl>  <dbl> <dbl>
# 1 Bus_Obese_DM2  74.3  100    142.
# 2 Sau_Obese_DM2  62     93.2  151.  
```


# BMI comparison between cohort
Significantly different for the non-diabetic groups regardless of the weight. 

## HW Non-diabetic - sig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Healthy_NODM", "Sau_Healthy_NODM")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Healthy_NODM Sau_Healthy_NODM 
#              502               57

wilcox.test(bmi ~ comb2, data = tdf)
# p-value = 0.000409
# the BMI distribution in the two cohort sub-groups are nonidentical populations.
tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(bmi),
            median = median(bmi),
            max = max(bmi))

#   comb2              min median   max
#   <chr>            <dbl>  <dbl> <dbl>
# 1 Bus_Healthy_NODM  17.9   23.1  26.0
# 2 Sau_Healthy_NODM  18.5   21.9  25.0
```

## HW Diabetic - notsig - small n for both esp. Saudi
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Healthy_DM2", "Sau_Healthy_DM2")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Healthy_DM2 Sau_Healthy_DM2 
#              18               6 

wilcox.test(bmi ~ comb2, data = tdf)
# p-value = 0.3432
# the BMI distribution in the two cohort sub-groups are identical populations.
tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(bmi),
            median = median(bmi),
            max = max(bmi))

#   comb2              min median   max
#   <chr>            <dbl>  <dbl> <dbl>
# 1 Bus_Healthy_DM2  20.2   23.0  24.8
# 2 Sau_Healthy_DM2  22.8   23.8  24.8
```

## Obese Non-diabetic - sig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Obese_NODM", "Sau_Obese_NODM")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Obese_NODM Sau_Obese_NODM 
#            480             51

wilcox.test(bmi ~ comb2, data = tdf)
#p-value = 7.552e-09 
# the BMI distribution in the two cohort sub-groups are nonidentical populations.

tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(bmi),
            median = median(bmi),
            max = max(bmi))
#   comb2            min median   max
#   <chr>          <dbl>  <dbl> <dbl>
# 1 Bus_Obese_NODM  30.0   32.6  50.0
# 2 Sau_Obese_NODM  30.0   38.2  69.3   
```

## Obese Diabetic - notsig
```{r}
tdf <- bus_sau2 %>% dplyr::filter(comb2 %in% c("Bus_Obese_DM2", "Sau_Obese_DM2")) %>%select(height:waist,comb2)

table(tdf$comb2)
# Bus_Obese_DM2 Sau_Obese_DM2 
#            81            44 

wilcox.test(bmi ~ comb2, data = tdf)
# p-value = 0.8544
# the BMI distribution in the two cohort sub-groups are identical populations.

tdf %>%                               
  group_by(comb2) %>% 
  summarize(min = min(bmi),
            median = median(bmi),
            max = max(bmi))

#   comb2           min median   max
#   <chr>         <dbl>  <dbl> <dbl>
# 1 Bus_Obese_DM2  30.1   35.5  48.5
# 2 Sau_Obese_DM2  30.1   35.0  63.3  
```


# Ratio 
## L2+3 : L4+5
```{r}
bus_sau2$L2345TG_R <- (rowSums(bus_sau2[, c("L2TG", "L3TG")]))/(rowSums(bus_sau2[, c("L4TG", "L5TG")]))

bus_sau2$L2345CH_R <- (rowSums(bus_sau2[, c("L2CH", "L3CH")]))/(rowSums(bus_sau2[, c("L4CH", "L5CH")]))

bus_sau2$L2345PL_R <- (rowSums(bus_sau2[, c("L2PL", "L3PL")]))/(rowSums(bus_sau2[, c("L4PL", "L5PL")]))

bus_sau2$L2345PN_R <- (rowSums(bus_sau2[, c("L2PN", "L3PN")]))/(rowSums(bus_sau2[, c("L4PN", "L5PN")]))

bus_sau2$L2345FC_R <- (rowSums(bus_sau2[, c("L2FC", "L3FC")]))/(rowSums(bus_sau2[, c("L4FC", "L5FC")]))

bus_sau2$L2345AB_R <- (rowSums(bus_sau2[, c("L2AB", "L3AB")]))/(rowSums(bus_sau2[, c("L4AB", "L5AB")]))
```

#### HW NoDM vs Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345CH_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345PL_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345PN_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345FC_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345AB_R ~ comb, data = tdf) # p < 2.2e-16
```

```{r}
c16 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "orchid1", "blue1"
)
```


#### plotting attempt
```{r}
library(GGally)
library(ggpubr)

tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

tdf$group = ""
tdf$group[which(tdf$comb == "Healthy_NODM")] = "Hw Non-diabetic"
tdf$group[which(tdf$comb == "Obese_NODM")] = "Ob Non-diabetic"

ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, 
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Iris Data",
    alphaLines = 0.3
    ) + 
    xlab("") + ylab("") +
    scale_color_manual(values=c16) +
    theme_classic()
```


```{r}
library(tidyr)
library(ggforce)
lipo_group<-c("TG","CH","FC","PL","AB|A1|A2")

tdf <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

save(tdf, file="lipo_ratio_forAndres_16022024.rda")

for(i in lipo_group){
    data.frame(tdf%>%select(comb),tdf[,grep(i,names(tdf))])%>%pivot_longer(cols = !comb,names_to = "ratio",values_to = "val")%>%
    ggplot(aes(x = comb, y = log10(val),fill = comb))+geom_boxplot()+stat_compare_means(aes(label = after_stat(p.signif)),label.x = 1.25, method = c("wilcox"), vjust = 1)+ theme(legend.position = "none") +facet_wrap_paginate(~ratio,scales = "free")->p1 
  
  plot(p1)

}

```

trying and trying 
```{r}
tdf1 <- data.frame(tdf%>%select(comb),tdf[,grep(i,names(tdf))])%>%pivot_longer(cols = !comb,names_to = "ratio",values_to = "val")

ggparcoord(tdf,
    columns = 2:19, groupColumn = 1, 
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Iris Data",
    alphaLines = 0.3
    ) + 
    xlab("") + ylab("") +
    #scale_color_manual(values=c16) +
    theme_classic()

```

#### HW NoDM vs Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.3309 (NS)
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.008595
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.01247
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.01336
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.0101
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.0136
```


#### HW DM2 v HW NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.06437 (NS)
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.01997
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.01778
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.02412
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.02843
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.02412
```


#### HW DM2 v HW NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.2867 (NS)
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.03825
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.04048
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.0534 (just missed the cut!)
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.03216
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.0534 (just missed the cut!)
```


#### Ob DM2 v Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.1933 (NS)
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.004856
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.006585
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.007344
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.01828
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.007409
```

#### Ob DM2 v Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:L2345AB_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.03015
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.004954
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.007294
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.008331
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.003827
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.008331
```



## L2 : L5
```{r}
bus_sau2$L25TG_R <- (bus_sau2[, "L2TG"])/(bus_sau2[, "L5TG"])

bus_sau2$L25CH_R <- (bus_sau2[, "L2CH"])/(bus_sau2[, "L5CH"])

bus_sau2$L25PL_R <- (bus_sau2[, "L2PL"])/(bus_sau2[, "L5PL"])

bus_sau2$L25PN_R <- (bus_sau2[, "L2PN"])/(bus_sau2[, "L5PN"])

bus_sau2$L25FC_R <- (bus_sau2[, "L2FC"])/(bus_sau2[, "L5FC"])

bus_sau2$L25AB_R <- (bus_sau2[, "L2AB"])/(bus_sau2[, "L5AB"])
```


#### HW NoDM vs Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25CH_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25PL_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25PN_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25FC_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25AB_R ~ comb, data = tdf) # p < 2.2e-16
```

#### HW NoDM vs Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.2733 (NS)
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.01247
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.01612
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.01812
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.02136
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.01812
```

#### HW DM2 vs HW NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.01442
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.01278
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.01147
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.01307
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.01227
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.01307
```

#### HW DM2 vs HW NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.2661 (NS)
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.05635 (just missed the cut!)
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.06606 (just missed the cut!)
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.0941 (NS)
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.05635 (just missed the cut!)
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.0941 (NS)
```

#### Ob DM2 vs Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.1845 (NS)
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.006779
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.01044
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.00736
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.02425
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.007312
```

#### Ob DM2 vs Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.006374
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.008149
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.007132
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.007971
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.006519
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.007971
```


## H1 : H4 
No Particle number (PN) and AB for HDL. Instead there are A1 and A2. 
```{r}
bus_sau2$H14TG_R <- (bus_sau2[, "H1TG"])/(bus_sau2[, "H4TG"])

bus_sau2$H14CH_R <- (bus_sau2[, "H1CH"])/(bus_sau2[, "H4CH"])

bus_sau2$H14PL_R <- (bus_sau2[, "H1PL"])/(bus_sau2[, "H4PL"])

bus_sau2$H14FC_R <- (bus_sau2[, "H1FC"])/(bus_sau2[, "H4FC"])

bus_sau2$H14A1_R <- (bus_sau2[, "H1A1"])/(bus_sau2[, "H4A1"])

bus_sau2$H14A2_R <- (bus_sau2[, "H1A2"])/(bus_sau2[, "H4A2"])

```

```{r echo=FALSE, include=FALSE, eval=FALSE}
#save(bus_sau2, file="BUS_SAU_correctedLipo_ann_withRatio_29022024.rda")
```


#### HW NoDM vs Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(H14CH_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(H14PL_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(H14FC_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(H14A1_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(H14A2_R ~ comb, data = tdf) # p < 2.2e-16
```

#### HW NoDM vs Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.007706
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.002896
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.001345
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.0003664
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.0004733
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.01028

```

#### HW DM2 vs HW NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.04764
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.01938
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.01233
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.01061
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.01023
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.00535

```

#### HW DM2 vs HW NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.5046 (NS)
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.4608 (NS)
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.4058 (NS)
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.4897 (NS)
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.3084 (NS)
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.9347 (NS)
```

#### Ob DM2 vs Ob NoDM - Bus
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "BUSSELTON" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.04093
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.9347 (NS)
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.9619 (NS)
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.118 (NS)
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.9997 (NS)
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.5179 (NS)
```

#### Ob DM2 vs Ob NoDM - Sau
```{r}
tdf <- bus_sau2 %>% dplyr::filter(cohort == "SAUDI" & comb %in% c("Obese_DM2", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.9673 (NS)
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.1662 (NS)
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.2613 (NS)
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.1708 (NS)
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.2252 (NS)
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.7062 (NS)
```


# BUS - uber Healthy 
```{r}
df <- read.csv("ann_160224.csv")
df <- df[, -1] # removing the Excel auto-generated row-id column

healthyB <- df[which(df$Healthy_normalONLY == "Healthy"), ]

# matching bus_sau2 for healthyB
df1 <- bus_sau2 %>% filter(cohort == "BUSSELTON" & sampleID %in% healthyB$sampleID) %>%select(TPTG:H4A2,comb, sampleID)
dim(df1)
#[1] 125 113 ## Uber Healthy No DM Busselton

df1_2 <- bus_sau2 %>% filter(cohort == "BUSSELTON" & !sampleID %in% healthyB$sampleID & comb=="Healthy_NODM") %>%select(TPTG:H4A2,comb, sampleID)

dim(df1_2)
#[1] 377 114
table(df1_2$comb)

#write.csv(df1_2, file="HealthyNODM_minusUberHealthy_BUS_correctedLipo_ann_11032024.csv", row.names = F)


df2 <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb == "Obese_NODM") %>%select(TPTG:H4A2,comb)
dim(df2)
#[1] 480 113

df3 <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb == "Obese_DM2") %>%select(TPTG:H4A2,comb)
dim(df3)
#[1]  81 113

df4 <- bus_sau2 %>% filter(cohort == "BUSSELTON" & comb == "Healthy_DM2") %>%select(TPTG:H4A2,comb)
dim(df4)
#[1]  18 113

bus_sau3 <- rbind(df1, df2, df3, df4)  
dim(bus_sau3)  
#[1] 704 113  

table(bus_sau3$comb)
 # Healthy_DM2 Healthy_NODM    Obese_DM2   Obese_NODM 
 #          18          125           81          480 

write.csv(df1, file="UberHealthy_BUS_correctedLipo_ann_11032024.csv", row.names = F)
#NOTE: bus_sau3 is actually only Busselton and the Healthy_NODM cohort consists only the uber healthy peeps.  
#save(bus_sau3, file = "UberHealthy_BUS_correctedLipo_ann_16022024.rda")

#load("UberHealthy_BUS_correctedLipo_ann_16022024.rda")
#write.csv(bus_sau3, file="UberHealthy_BUS_correctedLipo_ann_16022024.csv", row.names = F)

table(bus_sau3$comb)

rm(df, df1, df2, df3)
```


## Parallel coordinates chart
### Uber Healthy vs Ob Non-diabetic HW 
```{r}
library(GGally)
library(ggpubr)

tdf <- bus_sau3 %>%select(TPTG:H4A2,comb)

table(tdf$comb)
# Healthy_NODM   Obese_NODM 
#          125          480 

lipo_name<-c("CH","TG","PL","PN", "FC","A")

lcols <- c("#00BFC4", "#F8766D", "#FFC425")


p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median),
      Obese_NODM = apply(na.omit(
        tdf %>% filter(comb == "Obese_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton UBER Healthy v Non-diabetic Obese"), nrow=4) #nrow=4 is the best one. 

```

### Uber Healthy vs Diabetic HW
```{r}
tdf <- bus_sau3 %>%filter(comb %in% c("Healthy_NODM",
  "Healthy_DM2")) %>% select(TPTG:H4A2,comb) 

table(tdf$comb)
# Healthy_DM2 Healthy_NODM 
#           18          125

lipo_name<-c("CH","TG","PL","PN", "FC","A")

#lcols <- c("#00BFC4", "#F8766D", "#FFC425")
lcols <- c("#F8766D", "#00BFC4")

p1 <- list()
for (l in lipo_name) {
  tdf1 <-
    data.frame(
      Healthy_DM2 = apply(na.omit(
        tdf %>% filter(comb == "Healthy_DM2") %>% select(contains(l))
      ), 2, median),
      Healthy_NODM = apply(na.omit(
        tdf %>% filter(comb == "Healthy_NODM") %>% select(contains(l))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
  
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>%rownames_to_column(var = "Groups")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    #title = "Parallel Coordinate Plot for the Busselton Non-Diabetic Data",
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values=lcols) +
    theme_classic()

  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  rm(tdf1,p)
}

library(gridExtra)
grid.arrange(p1[[1]],p1[[2]],p1[[3]],p1[[4]],p1[[5]],p1[[6]],p1_legend, top=("Busselton"), nrow=4) #nrow=4 is the best one. 

```


## Ratio 
```{r}
bus_sau3$L2345TG_R <- (rowSums(bus_sau3[, c("L2TG", "L3TG")]))/(rowSums(bus_sau3[, c("L4TG", "L5TG")]))

bus_sau3$L2345CH_R <- (rowSums(bus_sau3[, c("L2CH", "L3CH")]))/(rowSums(bus_sau3[, c("L4CH", "L5CH")]))

bus_sau3$L2345PL_R <- (rowSums(bus_sau3[, c("L2PL", "L3PL")]))/(rowSums(bus_sau3[, c("L4PL", "L5PL")]))

bus_sau3$L2345PN_R <- (rowSums(bus_sau3[, c("L2PN", "L3PN")]))/(rowSums(bus_sau3[, c("L4PN", "L5PN")]))

bus_sau3$L2345FC_R <- (rowSums(bus_sau3[, c("L2FC", "L3FC")]))/(rowSums(bus_sau3[, c("L4FC", "L5FC")]))

bus_sau3$L2345AB_R <- (rowSums(bus_sau3[, c("L2AB", "L3AB")]))/(rowSums(bus_sau3[, c("L4AB", "L5AB")]))

bus_sau3$L25TG_R <- (bus_sau3[, "L2TG"])/(bus_sau3[, "L5TG"])

bus_sau3$L25CH_R <- (bus_sau3[, "L2CH"])/(bus_sau3[, "L5CH"])

bus_sau3$L25PL_R <- (bus_sau3[, "L2PL"])/(bus_sau3[, "L5PL"])

bus_sau3$L25PN_R <- (bus_sau3[, "L2PN"])/(bus_sau3[, "L5PN"])

bus_sau3$L25FC_R <- (bus_sau3[, "L2FC"])/(bus_sau3[, "L5FC"])

bus_sau3$L25AB_R <- (bus_sau3[, "L2AB"])/(bus_sau3[, "L5AB"])

bus_sau3$H14TG_R <- (bus_sau3[, "H1TG"])/(bus_sau3[, "H4TG"])

bus_sau3$H14CH_R <- (bus_sau3[, "H1CH"])/(bus_sau3[, "H4CH"])

bus_sau3$H14PL_R <- (bus_sau3[, "H1PL"])/(bus_sau3[, "H4PL"])

bus_sau3$H14FC_R <- (bus_sau3[, "H1FC"])/(bus_sau3[, "H4FC"])

bus_sau3$H14A1_R <- (bus_sau3[, "H1A1"])/(bus_sau3[, "H4A1"])

bus_sau3$H14A2_R <- (bus_sau3[, "H1A2"])/(bus_sau3[, "H4A2"])

save(bus_sau3, file = "UberHealthy_BUS_correctedLipo_ann_withRatio_22Feb2024.rda")
```


### L2+3 : L4+5
#### Uber Healthy vs Ob NoDM - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 7.759e-14
wilcox.test(L2345CH_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345PL_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345PN_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345FC_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L2345AB_R ~ comb, data = tdf) # p < 2.2e-16
```

#### Uber Healthy vs HW DM2 - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L2345TG_R ~ comb, data = tdf) # p = 0.01068
wilcox.test(L2345CH_R ~ comb, data = tdf) # p = 0.006001
wilcox.test(L2345PL_R ~ comb, data = tdf) # p = 0.005167
wilcox.test(L2345PN_R ~ comb, data = tdf) # p = 0.007212
wilcox.test(L2345FC_R ~ comb, data = tdf) # p = 0.007212
wilcox.test(L2345AB_R ~ comb, data = tdf) # p = 0.007212
```

### L2 : L5
#### Uber Healthy vs Ob NoDM - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 7.862e-14
wilcox.test(L25CH_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25PL_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25PN_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25FC_R ~ comb, data = tdf) # p < 2.2e-16
wilcox.test(L25AB_R ~ comb, data = tdf) # p < 2.2e-16
```

#### Uber Healthy vs HW DM2 - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(L25TG_R ~ comb, data = tdf) # p = 0.0008623
wilcox.test(L25CH_R ~ comb, data = tdf) # p = 0.003009
wilcox.test(L25PL_R ~ comb, data = tdf) # p = 0.002514
wilcox.test(L25PN_R ~ comb, data = tdf) # p = 0.002367
wilcox.test(L25FC_R ~ comb, data = tdf) # p = 0.00267
wilcox.test(L25AB_R ~ comb, data = tdf) # p = 0.002367
```

## H1 : H4 
No Particle number (PN) and AB for HDL. Instead there are A1 and A2. 

#### Uber Healthy vs Ob NoDM - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_NODM", "Obese_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.002367
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 9.649e-10
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 3.143e-15
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 9.712e-16
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 6.245e-16
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 4.057e-09
```

#### Uber Healthy vs HW DM2 - Bus
```{r}
tdf <- bus_sau3 %>% filter(comb %in% c("Healthy_DM2", "Healthy_NODM")) %>%select(comb, L2345TG_R:H14A2_R)

wilcox.test(H14TG_R ~ comb, data = tdf) # p = 0.09972 (NS)
wilcox.test(H14CH_R ~ comb, data = tdf) # p = 0.03882
wilcox.test(H14PL_R ~ comb, data = tdf) # p = 0.02958
wilcox.test(H14FC_R ~ comb, data = tdf) # p = 0.01928
wilcox.test(H14A1_R ~ comb, data = tdf) # p = 0.02492
wilcox.test(H14A2_R ~ comb, data = tdf) # p = 0.03004

```


## Analysis
### Creating new data matrix - ie Ratio data & class 
```{r}
tdf <- bus_sau3 %>% select(comb, L2345TG_R:H14A2_R)

dim(tdf)
#[1] 704  19

table(tdf$comb)
 # Healthy_DM2 Healthy_NODM    Obese_DM2   Obese_NODM 
 #          18          125           81          480 

#save(tdf, file="UberHealthy_BUS_Ratio_22Feb2024.rda")
```

### Creating train : test set
```{r}
# opls of Healthy_NODM v Obese_NODM
df <- tdf %>% filter(comb %in% c("Healthy_NODM", "Obese_NODM"))

hw_nodm <- df %>% filter(comb == "Healthy_NODM") #125
ob_nodm <- df %>% filter(comb == "Obese_NODM") #480

liporatio <- colnames(df[2:19])

# train set - 2/3 of the respective class size
train_hw <- hw_nodm[sample(nrow(hw_nodm), 83, replace = F), c(1:19)]
train_ob <- ob_nodm[sample(nrow(ob_nodm), 320, replace = F), c(1:19)]

train_df <- rbind(train_hw, train_ob)

idx.train.hw <- which(rownames(hw_nodm) %in% rownames(train_hw))
idx.train.ob <- which(rownames(ob_nodm) %in% rownames(train_ob))

# test set - 1/3 of the respective class size
test_hw <- hw_nodm[-idx.train.hw, ] 
test_ob <- ob_nodm[-idx.train.ob, ]

test_df <- rbind(test_hw, test_ob)
```


### OPLS-DA
```{r}
Y = train_df$comb
table(Y)
# Y
# Healthy_NODM   Obese_NODM 
#          83          320

X = train_df[, 2:19]

smod1 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 403 samples x 18 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.486    0.152   0.108 0.374   1   1 0.05 0.05

# Q2Y
smod1@modelDF[["Q2"]][[1]]
#[1] 0.118
save(smod1, file="oplsda_BUS_train_HwNoDM_v_ObNoDM.rda")

# plotscore 
plotScores(smod1, optns=list(discretePalette = c("Healthy_NODM" = "#00BFC4", "Obese_NODM" = "#F8766D"), plotTitle="Score plot - BUS Train Set - Healthy Weight No DM (n = 83) vs Obese No DM (n = 320)", colorTitle = "Condition", ellipse="hotellings"))

# plotload
plotLoadings(model = smod1, optns=list(plotTitle="BUS Train Set - Healthy Weight No DM (n = 83) vs Obese No DM (n = 320)"))

smod1.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
smod1.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.36  0.76     0.74
# 2       1       2   NA  0.78     0.76

#save(smod1.m8, file="oplsda_BUS_train_HwNoDM_v_ObNoDM_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
edf=eruption(smod1.m8) 
edf # calling the plot
edf_1=edf$plot$data
#write.csv(edf_1, file='cliffsdelta_BUS_train_HwNoDM_v_ObNoDM_26Feb2024.csv')

```

### VIP plots or log-fold changes plot
```{r}
#to make p value plots (also called VIP plots) - must use metabom8 oplsda model results for this code to work

  #liporatio <- colnames(df[2:19])
  edf_1$logp = -log10(edf_1$pval)
  
  smod = t(as.matrix(smod1.m8@p_pred))
  smod = data.frame(smod)
  smod$varname = (liporatio)

  idx = which(smod$smod < 0) # 17 lipos 
  flip = as.character(edf_1$id)[idx] 
  
  edf_1$logp[which(edf_1$id %in% as.character(flip))] = -(edf_1$logp[which(edf_1$id %in% as.character(flip))])

  smod_p = data.frame(edf_1$id,edf_1$logp)
  colnames(smod_p) = c("varname","smod_p")

  Lipo_smod_p = cbind(smod_p)
  Lipo_smod_p = data.frame(smod_p)

  lipo <- c(Lipo_smod_p$varname)
  value = c(Lipo_smod_p$smod_p)
  data<- data.frame(lipo,value)
  
  data$lipo=factor(data$lipo, levels = Lipo_smod_p$varname[order(Lipo_smod_p$smod_p)])
  
  ggplot(data[order(data$value, decreasing = T),],aes(fill = value>0, y =value, x = lipo))+
    geom_bar(position="dodge",stat="identity", show.legend = FALSE)+scale_fill_manual(values = c("red","blue"))+
    coord_flip()+
    xlab("")+ylab("-log10(p_values)")+ theme(legend.position='top',aspect.ratio =1.5 ,
                                            axis.text.x =element_text(color="black",size = 10),
                                            axis.text.y = element_text(color = "black",size = 8, angle = 0),
                                            axis.title.x = element_text(color = "black",size = 15, angle = 0),
                                            axis.title.y = element_text(color = "black", size = 8, angle = 90),
                                            legend.text = element_text(colour = "black",size = 10,angle = 0))
  #legend removed for now. 
```

### Prediction - Test set
```{r}
smod1.pred <- oplsdaPredict(smod1, test_df[, 2:19])
View(smod1.pred)
pred.value <- as.factor(smod1.pred$predY)
actual.value <- as.factor(test_df$comb)

confusionMatrix(actual.value, pred.value)

#NOTE: it seems like from the log-fold change and cliff's delta, L25PL_R, L25CH_R and H14TG_R are the ones to go for. We'll see how it goes when they are used in modeling to predict in different cohort such as Saudi and Mauritius. 
```


## Validation - SAUDI
```{r}
sdf <- bus_sau2 %>% filter(cohort == "SAUDI" & comb %in% c("Healthy_NODM", "Obese_NODM")) %>% select(TPTG:H4A2,comb)

sdf$L2345TG_R <- (rowSums(sdf[, c("L2TG", "L3TG")]))/(rowSums(sdf[, c("L4TG", "L5TG")]))

sdf$L2345CH_R <- (rowSums(sdf[, c("L2CH", "L3CH")]))/(rowSums(sdf[, c("L4CH", "L5CH")]))

sdf$L2345PL_R <- (rowSums(sdf[, c("L2PL", "L3PL")]))/(rowSums(sdf[, c("L4PL", "L5PL")]))

sdf$L2345PN_R <- (rowSums(sdf[, c("L2PN", "L3PN")]))/(rowSums(sdf[, c("L4PN", "L5PN")]))

sdf$L2345FC_R <- (rowSums(sdf[, c("L2FC", "L3FC")]))/(rowSums(sdf[, c("L4FC", "L5FC")]))

sdf$L2345AB_R <- (rowSums(sdf[, c("L2AB", "L3AB")]))/(rowSums(sdf[, c("L4AB", "L5AB")]))

sdf$L25TG_R <- (sdf[, "L2TG"])/(sdf[, "L5TG"])

sdf$L25CH_R <- (sdf[, "L2CH"])/(sdf[, "L5CH"])

sdf$L25PL_R <- (sdf[, "L2PL"])/(sdf[, "L5PL"])

sdf$L25PN_R <- (sdf[, "L2PN"])/(sdf[, "L5PN"])

sdf$L25FC_R <- (sdf[, "L2FC"])/(sdf[, "L5FC"])

sdf$L25AB_R <- (sdf[, "L2AB"])/(sdf[, "L5AB"])

sdf$H14TG_R <- (sdf[, "H1TG"])/(sdf[, "H4TG"])

sdf$H14CH_R <- (sdf[, "H1CH"])/(sdf[, "H4CH"])

sdf$H14PL_R <- (sdf[, "H1PL"])/(sdf[, "H4PL"])

sdf$H14FC_R <- (sdf[, "H1FC"])/(sdf[, "H4FC"])

sdf$H14A1_R <- (sdf[, "H1A1"])/(sdf[, "H4A1"])

sdf$H14A2_R <- (sdf[, "H1A2"])/(sdf[, "H4A2"])

#save(sdf, file = "UberHealthy_SAU_correctedLipo_ann_withRatio_22Feb2024.rda")
```


```{r}
sdf2 <- sdf %>% select(comb, c("L25PL_R", "L25CH_R", "H14TG_R"))

table(sdf2$comb)
# Healthy_NODM   Obese_NODM 
#           57           51

sdf3 <- sdf %>% select(comb, L2345TG_R:H14A2_R)

table(sdf3$comb)
# Healthy_NODM   Obese_NODM 
#           57           51
```



### OPLS-DA 
#### Creating another model with only L25PL_R, L25CH_R and H14TG_R in Busselton to later predict Saudi
```{r}
df2 <- df %>% select(comb, c("L25PL_R", "L25CH_R", "H14TG_R"))

dim(df2)
#[1] 605  4

table(df2$comb)
# Healthy_NODM   Obese_NODM 
#          125          480 

Y = df2$comb
table(Y)
# Y
# Healthy_NODM   Obese_NODM 
#          125          480

X = df2[, 2:4]

smod2 = oplsda(X, Y, type = "OPLS", optns = list(orthoI=1))
# OPLS-DA
# 605 samples x 3 variables and 1 response
# standard scaling of predictors and response(s)
#       R2X(cum) R2Y(cum) Q2(cum) RMSEE pre ort pR2Y  pQ2
# Total    0.746   0.0216  -0.556 0.401   1   1 0.05 1.05

# Q2Y
smod2@modelDF[["Q2"]][[1]]
#[1] -0.0136
save(smod2, file="oplsda_BUS_selectedratio_HwNoDM_v_ObNoDM.rda")

# plotscore 
plotScores(smod2, optns=list(discretePalette = c("Healthy_NODM" = "#00BFC4", "Obese_NODM" = "#F8766D"), plotTitle="Score plot - BUS - Selected ratio only - Healthy Weight No DM (n = 125) vs Obese No DM (n = 480)", colorTitle = "Condition", ellipse="hotellings"))

# plotload
plotLoadings(model = smod2, optns=list(plotTitle="BUS - Selected ratio only - Healthy Weight No DM (n = 125) vs Obese No DM (n = 480)"))

#smod1.m8 <- metabom8::opls(X, Y, scale = "UV", center = TRUE)#, cv = list(method = "k-fold", k = 2, split = 1/3))
# NOTE: k-fold parameter had to be modified due to very unbalanced sample size between groups. 
#smod1.m8@summary
#   PC_pred PC_orth  R2X AUROC AUROC_CV
# 1       1       1 0.36  0.76     0.74
# 2       1       2   NA  0.78     0.76

#save(smod1.m8, file="oplsda_BUS_train_HwNoDM_v_ObNoDM_m8.rda")

# eruption plot - MUST use oplsda model built by metabom8 
#edf=eruption(smod1.m8) 
#edf # calling the plot
#edf_1=edf$plot$data
#write.csv(edf_1, file='cliffsdelta_BUS_train_HwNoDM_v_ObNoDM_26Feb2024.csv')

```

### Prediction - Saudi set
```{r}
smod2.pred <- oplsdaPredict(smod2, sdf2[, 2:4])

pred.value <- as.factor(smod2.pred$predY)
actual.value <- as.factor(sdf2$comb)

table(actual.value, pred.value)
# actual.value   Obese_NODM
#   Healthy_NODM         57
#   Obese_NODM           51
#confusionMatrix(actual.value, pred.value)


smod1.pred2 <- oplsdaPredict(smod1, sdf3[, 2:19])

pred.value <- as.factor(smod1.pred2$predY)
actual.value <- as.factor(sdf3$comb)

table(actual.value, pred.value)
# actual.value   Healthy_NODM Obese_NODM
#   Healthy_NODM            3         54
#   Obese_NODM              4         47

confusionMatrix(actual.value, pred.value)
# Confusion Matrix and Statistics
# 
#               Reference
# Prediction     Healthy_NODM Obese_NODM
#   Healthy_NODM            3         54
#   Obese_NODM              4         47
#                                           
#                Accuracy : 0.463           
#                  95% CI : (0.3665, 0.5615)
#     No Information Rate : 0.9352          
#     P-Value [Acc > NIR] : 1               
#                                           
#                   Kappa : -0.0245         
#                                           
#  Mcnemar's Test P-Value : 1.243e-10       
#                                           
#             Sensitivity : 0.42857         
#             Specificity : 0.46535         
#          Pos Pred Value : 0.05263         
#          Neg Pred Value : 0.92157         
#              Prevalence : 0.06481         
#          Detection Rate : 0.02778         
#    Detection Prevalence : 0.52778         
#       Balanced Accuracy : 0.44696         
#                                           
#        'Positive' Class : Healthy_NODM    

```














bits and pieces 
```{r}
# Train a logistic regression model
logit1 <- glm(as.factor(comb) ~ ., data = train_df, family = "binomial")

# Model summary
summary(logit1)


logitTG <- glm(as.factor(comb) ~ L2345TG_R + L25TG_R + H14TG_R, data = train_df, family = "binomial")

summary(logitTG)
```

# Pie charts
```{r}
#please give to lucy 
load("BUS_SAU_correctedLipo_ann_14022024.rda") 
names(bus_sau2)
```


##LDL1
```{r}
abe <- bus_sau2
abe$L1CE <- abe$L1CH - abe$L1FC
vars <- grep("L1.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```



##LDL2
```{r}
abe <- bus_sau2
abe$L2CE <- abe$L2CH - abe$L2FC
vars <- grep("L2.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), nrow = 2, ncol=4)

```

##LDL3
```{r}
abe <- bus_sau2
abe$L3CE <- abe$L3CH - abe$L3FC
vars <- grep("L3.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```



##LDL4
```{r}
abe <- bus_sau2
abe$L4CE <- abe$L4CH - abe$L4FC
vars <- grep("L4.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```


##LDL5
```{r}
abe <- bus_sau2
abe$L5CE <- abe$L5CH - abe$L5FC
vars <- grep("L5.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```

##LDL6
```{r}
abe <- bus_sau2
abe$L6CE <- abe$L6CH - abe$L6FC
vars <- grep("L6.*[^BNH]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```


##HDL1
```{r}
abe <- bus_sau2
abe$H1CE <- abe$H1CH - abe$H1FC
vars <- grep("H1.*[^BNH12]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```

##HDL2
```{r}
abe <- bus_sau2
abe$H2CE <- abe$H2CH - abe$H2FC
vars <- grep("H2.*[^BNH12]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```

##HDL3
```{r}
abe <- bus_sau2
abe$H3CE <- abe$H3CH - abe$H3FC
vars <- grep("H3.*[^BNH12]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```

##HDL4
```{r}
abe <- bus_sau2
abe$H4CE <- abe$H4CH - abe$H4FC
vars <- grep("H4.*[^BNH12]$",names(abe),value=TRUE)
abe <- abe[,c("cohort","comb",vars)]

g1 <- list()
for (ch in unique(abe$cohort)){
  for (cm in  grep("[HO][eb]",unique(abe$comb),value=TRUE)){
    dF <- pivot_longer(abe[abe$cohort == ch & abe$comb == cm,],vars)
    dF <- group_by(dF,name) %>% summarise(avg=mean(value))
    dF$name <- factor(dF$name,levels=dF$name)
    dF$y <- cumsum(dF$avg)
    g <- ggplot(dF,aes(x="",y=avg,fill=name)) + geom_col() + coord_polar("y",start=0) + theme_void()
    g <- g + geom_text(aes(y=max(y)-y+avg*0.5,label=round(avg,2)))
    g <- g + ggtitle(paste0(ch,", ",cm))
    g1_legend <- get_legend(g)
    g1_legend <- as_ggplot(g1_legend)
    #g1[["legend"]] <- g1_legend
    g1[[paste0(ch,"_",cm)]] <- g + theme(legend.position="none") 
  }
}
g1[["legend"]] <- g1_legend

pattern <- c("BUSSELTON_Healthy_NODM", "BUSSELTON_Obese_NODM", "BUSSELTON_Healthy_DM2", "BUSSELTON_Obese_DM2", "SAUDI_Healthy_NODM", "SAUDI_Obese_NODM", "SAUDI_Healthy_DM2", "SAUDI_Obese_DM2", "legend")

g2 <- g1[pattern]

library(gridExtra)
grid.arrange(grobs=lapply(g2,ggplotGrob), ncol=4)
```

