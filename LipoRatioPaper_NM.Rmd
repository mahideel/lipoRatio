---
title: "NoviaLipoRatioPaper"
author: "Novia Minaee"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


<style type="text/css">
.main-container {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
</style>

<style>
  @media print {
    body {
       display: table;
       table-layout: fixed;
       padding-top: 0.5cm;
       padding-bottom: 0.5cm;
       height: auto;
    }
  }
  body {
    margin:0;
    padding:0;
  }
  .flat-table {
    display: block;
    font-family: sans-serif;
    -webkit-font-smoothing: antialiased;
    font-size: 115%;
    overflow: auto;
    width: auto;
  }
  thead {
    background-color: rgb(254, 254, 254);
    color: black;
    font-weight: normal;
    padding: 0px 0px;
    text-align: center;
  }
  tbody {
    background-color: rgb(254, 254, 254);
    color: rgb(70, 70, 70);
    padding: 0px 0px;
  }
  table, th, td{
        border: 1px solid #666;
    }
  table th, table td{
        padding: 3px; 
    }
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,cache = FALSE)
library(dplyr)
library(gtsummary)
library(ggplot2)
library(tidyr)
library(htmlTable)
library(knitr)
library(corrplot)
#library(mva.plots)
library(fusion)
#library(nmr.parser)
library(tidyverse)

# install.packages("/Users/novia/Downloads/Telegram Desktop/rldx", repos=NULL, type="source")

library(rldx)

devtools::load_all("~/git/phenological/nmr-parser/")
devtools::load_all("~/git/phenological/uva-plots/")
devtools::load_all("~/git/phenological/fusion/")
devtools::load_all("~/git/phenological/mva-plots/") # so can do split correlation plot function

```


Following Reika's DOb_BHAS_demographics.Rmd script to make sure my numbers tally-up. 
Notes: Busselton Grouping is DM or NDM status 

Both Type 1 and Type 2 DM --> DM (using Summary_Diabetes_idx 1 or 0)

For BMI category
(18.5,25] = "Healthy"
(25,30] = "OverWeight"
(30,70] = "Obese"

remove those underweight participants
# Busselton data
```{r}
#setting the path 
Sys.setenv(DATASETS = "/Users/novia/DATASETS")
pathToData <- file.path(Sys.getenv()['DATASETS'], "Busselton")


# Lipo
lipo<-local(get(load(file.path(pathToData,"DataElements","Busselton_PLA_LIPO.daE"))))

Lipo<-data.frame(apply(lipo@.Data,2,as.numeric))
Lipo_Ann<-lipo@obsDescr[[1]]


# SPC
spc<-local(get(load(file.path(pathToData,"DataElements","busselton_C1_PLA_BHASr03@local_dire@prof_plasma_dire_anpc_SpcGlyc.daE"))))

SPC<-data.frame(apply(spc@.Data,2,as.numeric))
SPC_Ann<-spc@obsDescr[[1]]
SPC_Ann$sampleID<-sapply(strsplit(SPC_Ann$sampleID, "_"),"[",1)


# Annotation 
Anno1<-read.csv(file.path(pathToData,"rawData", "meta", "Anno_t1_MH_new.csv"))

Anno1%>%select(sampleID,age,sex,bmi,Diabetes_Type,Summary_Diabetes_idx)%>%
  rename(Age = age,
         Sex = sex,
         BMI = bmi,
         DM = Summary_Diabetes_idx)%>%
  mutate(cohort = "Busselton",
         BMI_cat = cut(BMI,
                       c(18.5,25,30,70),
                       labels = c("Healthy","OverWeight","Obese"),
                       levels = c("Healthy","OverWeight","Obese")),
                       #labels = c("<25","25-30",">30"),
                       #levels = c("<25","25-30",">30")),
         DM = ifelse(DM==1,"DM","NDM"),
         DM = factor(DM, level = c("NDM", "DM"))
         )%>%
  dplyr::filter(!is.na(BMI_cat)) ->Anno1

## Remove hye Type 1 Diabetes from analysis 
idx <- which(Anno1$Diabetes_Type == 1) #9 
Anno1 <- Anno1[-idx, ]
Anno1 <- Anno1 %>% select(!Diabetes_Type) 


Lipo<-Lipo[which(Lipo_Ann$sampleID %in% Anno1$sampleID),]
Lipo_Ann<-Lipo_Ann[which(Lipo_Ann$sampleID %in% Anno1$sampleID),]
SPC<-SPC[which(SPC_Ann$sampleID %in% Anno1$sampleID),]
SPC_Ann<-SPC_Ann[which(SPC_Ann$sampleID %in% Anno1$sampleID),]

Lipo<-Lipo[match(Anno1$sampleID, Lipo_Ann$sampleID),]
SPC<-SPC[match(Anno1$sampleID, SPC_Ann$sampleID),]

BHA_Lipo<-Lipo
BHA_SPC<-SPC
BHA_Anno<-Anno1

table(BHA_Anno$DM, BHA_Anno$BMI_cat)

table(BHA_Anno$sampleID == Lipo_Ann$sampleID) # TRUE 1960

#table(rownames(BHA_Lipo) == rownames(Lipo_Ann)) # TRUE 1960

# NOTE TO SELF: Lipo (which becomes BHA_Lipo) and Lipo_Ann are matched by rownames. Lipo_Ann and Anno1 (which becomes BHA_Anno) are matched by sampleID.
# Therefore BHA_Lipo and BHA_Anno are matched. 

rm(lipo, Lipo, Lipo_Ann, spc, SPC, SPC_Ann, Anno1, idx)
```



# Saudi
```{r}
#setting the path 
pathToData <- file.path(Sys.getenv()['DATASETS'], "Saudi")

# Lipo
lipo<-local(get(load(file.path(pathToData,"DataElements","DiaObesity_LIPO.daE"))))

Lipo<-data.frame(apply(lipo@.Data,2,as.numeric))
Lipo_Ann<-lipo@obsDescr[[1]]

# Annotation
Anno1<-local(get(load(file.path(pathToData,"DataElements","DiaObesity_ANNO.daE"))))
Anno1<-Anno1@obsDescr[[1]]

Anno1%>%select(sampleID,Age,Gender,BMI,`Presence of any known diseases`)%>%
  rename(
         Sex = Gender,
         DM = `Presence of any known diseases`)%>%
  mutate(cohort = "DiaObesity",
         BMI_cat = cut(BMI,
                       c(18.5,25,30,70),
                       labels = c("Healthy","OverWeight","Obese"),
                       levels = c("Healthy","OverWeight","Obese")),                       
                       # labels = c("<25","25-30",">30"),
                       # levels = c("<25","25-30",">30")),
         DM = ifelse(grepl("1",DM),"T1DM",DM), #grab "1" and rename as T1DM in DM column 
         DM = ifelse(grepl("2",DM),"DM",DM), #grab "1" and rename as DM in DM column 
         DM = ifelse(!grepl("DM",DM),"NDM",DM),
         Sex = ifelse(grepl("F",Sex),"F","M"))%>%
  dplyr::filter(DM!="T1DM")%>%
  mutate(DM = factor(DM, level = c("NDM", "DM"))) %>%
  dplyr::filter(!is.na(BMI_cat))->Anno1
  
Lipo<-Lipo[which(Lipo_Ann$sampleID %in% Anno1$sampleID),]
Lipo_Ann<-Lipo_Ann[which(Lipo_Ann$sampleID %in% Anno1$sampleID),]
Anno1<-Anno1[match(Lipo_Ann$sampleID,Anno1$sampleID),]

table(Anno1$DM, Anno1$BMI_cat)
  #     Healthy OverWeight Obese
  # NDM       58         20    56
  # T2DM       6          5    44

Dia_Lipo<-Lipo
Dia_Anno<-Anno1


rm(Lipo,Lipo_Ann,Anno1,pathToData,lipo)

```

## Lipoprotein Sup Mat table
```{r}
library(gtsummary)
cbind(BHA_Anno%>%
        select(DM,BMI_cat),BHA_Lipo)%>%
  tbl_strata(
    strata = DM,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = BMI_cat,
                    statistic = all_continuous() ~ "{median} ± {sd}",
                    missing = "no") %>%
        add_p(group = NULL),
    .header = "**{strata}**, N = {n}"
  )->tble_bus
  
cbind(Dia_Anno%>%
        select(DM,BMI_cat),
      Dia_Lipo)%>%
  tbl_strata(
    strata = DM,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = BMI_cat,
                    statistic = all_continuous() ~ "{median} ± {sd}",
                    missing = "no") %>%
        add_p(),
    .header = "**{strata}**, N = {n}"
  )->tble_sau
  

tbl_merge_ex1 <-
  tbl_merge(
    tbls = list(tble_bus,tble_sau),
    tab_spanner = c("**Busselton**", "**Saudi**")
  )

tbl_merge_ex1

#write.csv(tbl_merge_ex1, file = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Bus_Sau_tbl_merge_ex1.csv", fileEncoding = "UTF-8") # not working properly, weird plus minus signs. 

library(writexl)

my_table <- as.data.frame(tbl_merge_ex1)

# Write to Excel file
# write_xlsx(my_table, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Bus_Sau_tbl_merge_ex1.xlsx")

```

## Demographics

### *Busselton*
```{r}
#setting the path 
Sys.setenv(DATASETS = "/Users/novia/DATASETS")
pathToData <- file.path(Sys.getenv()['DATASETS'], "Busselton")
Annotation<-read.csv(file.path(pathToData,"rawData", "meta", "Anno_t1_MH_new.csv"))[,-1]
Annotation<-Annotation[match(BHA_Anno$sampleID,Annotation$sampleID),]

### Alcohole consumption ###
drinking<-Annotation[,grep("dn7",colnames(Annotation))]

for(i in 1:ncol(drinking)){
  drinking[,i]<-drinking[,i]-2
}

for(i in 1:ncol(drinking)){
  drinking[,i]<-gsub("-2","0",gsub("-1","0.2",gsub("0","0.5",drinking[,i])))
}

for(i in 1:ncol(drinking)){
  drinking[which(is.na(drinking[,i])),i]<-0
}

drinking<-apply(drinking, 2,as.numeric)

drinking<-data.frame(drinking)
maximum<-apply(drinking,1,max) # alcohol_days_maximum
total<-apply(drinking,1,sum) # alcohol_days_total
total[which(total>7)]<-7 # total that are greater than 7 are replaced by 7 ( since 7 days a week is the maximum)
days_drink<-(total+maximum)/2 # take the mean values between total and the maximum drinking days per week 

Drinks<-Annotation$dn8
#Drinks<-Anno_t1_MH$`DN_Alcohol/number_of_glasses`
Drinks[which(is.na(Drinks))]<-0

Annotation$alcohol_glasses_per_week=Drinks*days_drink
rm(days_drink,Drinks,i,maximum, total,drinking)
############################
# Physical Activity
      # moderate
      # hours pa4a
      # minutes pa4b
mod_hours<-Annotation$pa4a
mod_hours[which(is.na(mod_hours))]<-0
mod_hours<-mod_hours*60
mod_min<-Annotation$pa4b
mod_min[which(is.na(mod_min))]<-0
moderatePA<-as.numeric(mod_hours)+as.numeric(mod_min)
Annotation$moderatePA<-moderatePA*7
remove(mod_hours,mod_min,moderatePA)

# vigorous
mod_hours<-Annotation$pa2a
mod_hours[which(is.na(mod_hours))]<-0
mod_hours<-mod_hours*60
mod_min<-Annotation$pa2b
mod_min[which(is.na(mod_min))]<-0
vigorousPA<-as.numeric(mod_hours)+as.numeric(mod_min)
Annotation$vigorousPA<-vigorousPA*7
remove(mod_hours,mod_min,vigorousPA)
##############################
# lipids_lowering medication
Annotation$lipids_lowering<-ifelse(grepl("STATIN|FIBRATE|EZETIMIBE|PCSK9|hyperlipidemia|Antihyperlipidemic|HMG-CoA_reductase_inhibitor|Lipid_lowering_treatment",unite(Annotation,col = "Medication",grep("med",colnames(Annotation)),sep = " / ")$Medication, ignore.case = T),1,0)
##############################

cbind(BHA_Anno%>%select(Age,Sex,BMI,DM,BMI_cat)%>%
        mutate(DM = factor(DM)),
      Annotation%>%
  select(
         height,
         weight,
         waist,
         sbp,
         dbp,
         glycated_haemoglobin,
         c_reactive_protein,
         sm1,
         sm1,
         sm2,
         alcohol_glasses_per_week,
         moderatePA,
         vigorousPA,
         an_med,
         lipids_lowering,
         Summary_Diabetes_idx,
         Summary_Cardiovascular_idx,)%>%
  mutate(smoking = ifelse(as.numeric(sm1)==1,"Past","Never"),
         smoking = ifelse(as.numeric(sm1)==1 & as.numeric(sm2)==1,"Current",smoking),
          `Blood pressure medication`= ifelse(grepl("Calcium_channel_blocker|Angiotensin|Antihypertensive|hypertension|Blood_pressure_lowering",an_med),1,0))%>%
  rename(`Height (m)` = height,
         `Weight (kg)` = weight,
         `Waist circumference (cm)` = waist,
         `Systolic blood pressure (mmHg)` = sbp,
         `Diastolic blood pressure (mmHg)` = dbp,
         `HbA1c (%)` = glycated_haemoglobin,
         `C-reactive protein (ug/L)` = c_reactive_protein,
         `Alcohol consumption (std drinks/week)` = alcohol_glasses_per_week,
         # `Red meat (days/week)` = dn1a,
         # `Chicken/poultry (days/week)` = dn1b,
         # `Fish (days/week)` = dn1d,
         # `Cooked vegetables (serves/day)` = dn4a,
         # `Raw vegetables (serves/day)` = dn4b,
         # `Fruit (serves/day)` = dn5a,
         `Lipid-lowering medication` = lipids_lowering,
         `Diabetes` = Summary_Diabetes_idx,
         `Cardiovascular disease` = Summary_Cardiovascular_idx,
         `Moderate physical activity (mins/week)` = moderatePA,
         `Vigorous physical activity (mins/week)` = vigorousPA)%>%
  select(-c(sm1,sm2,an_med))%>%
  relocate(where(is.character))%>%
  relocate(`Blood pressure medication`,.before =`Lipid-lowering medication` )%>%
  mutate(`Systolic blood pressure (mmHg)`  = ifelse(is.na(`Systolic blood pressure (mmHg)` ),NA,as.numeric(`Systolic blood pressure (mmHg)` )),
         `Diastolic blood pressure (mmHg)` = ifelse(is.na(`Diastolic blood pressure (mmHg)`),NA,as.numeric(`Diastolic blood pressure (mmHg)`))))->tble_bus_demo


tble_bus_demo%>%
  tbl_strata(
    strata = DM,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = BMI_cat,
                    statistic = all_continuous() ~ "{median} ± {sd}",
                    missing = "no") %>%
        add_p(group = NULL),
    .header = "**{strata}**, N = {n}"
  )->tble_bus_demo

rm(Annotation)
tble_bus_demo
```


### *SAUDI*
```{r}
library(readxl)
Annotation<-read_excel("~/git/phenocare/diabetes/DiaObesity/originalFiles/Randomised diabesity.xlsx",sheet = 2)
Annotation<-Annotation%>%
  mutate(sampleID = make.unique(paste0("SAUD_",seq(1,nrow(Annotation),by=1)),sep = "."))%>%
  select(sampleID,
         Height,
         Weight,
         `Waist Circumference`,
         `Blood Pressure - Systolic`,
         `Blood Pressure - Diastolic`,
         `Smoking?`,
         `Exercise or Physical Activities (moderate)  for more than 30 min in a day.`
         )%>%
  rename(`Height (m)` = Height,
         `Weight (kg)` = Weight,
         `Waist circumference (cm)` = `Waist Circumference`,
         `Systolic blood pressure (mmHg)` = `Blood Pressure - Systolic`,
         `Diastolic blood pressure (mmHg)` = `Blood Pressure - Diastolic`,
         Smoking = `Smoking?`,
         `Moderate physical activity (>30 mins/day)` = `Exercise or Physical Activities (moderate)  for more than 30 min in a day.`)

Annotation<-Annotation[match(Dia_Anno$sampleID,Annotation$sampleID),]

cbind(Dia_Anno%>%select(Age,Sex,BMI,DM,BMI_cat),
      Annotation)%>%select(!sampleID)%>%
  tbl_strata(
    strata = DM,
    .tbl_fun =
      ~ .x %>%
        tbl_summary(by = BMI_cat,
                    statistic = all_continuous() ~ "{median} ± {sd}",
                    missing = "no") %>%
        add_p(),
    .header = "**{strata}**, N = {n}"
  )->tble_sau_demo
  
tble_sau_demo
rm(Annotation)
```


### additional test for demography - don't end up needing this but good to keep
```{r, eval = FALSE}
anno1 <- BHA_Anno
anno1$comb <- gsub("\\s","", paste(anno1$BMI_cat,"_", anno1$DM))

anno2 <- Dia_Anno
anno2$comb <- gsub("\\s","", paste(anno2$BMI_cat,"_", anno2$DM))

anno1 %>%
  dplyr::filter(comb %in% c("Obese_NDM", "Obese_DM")) %>%
  summarize(age_test = wilcox.test(Age ~ comb)$p.value,
            bmi_test = wilcox.test(BMI ~ comb)$p.value)

anno1 %>%
  dplyr::filter(comb %in% c("Healthy_DM", "Obese_DM")) %>%
  summarize(age_test = wilcox.test(Age ~ comb)$p.value,
            bmi_test = wilcox.test(BMI ~ comb)$p.value)

```



# Fig1. Line chart - Busselton
(parallel coordinates chart)

```{r, fig.width=20, fig.height=15}
library(GGally)
library(ggpubr)

#lipo_name<-c("CH","TG","PL","PN","FC","A1|A2|AB")
lipo_name<-c("CH","FC","PL", "TG")

tdf <- BHA_Lipo
#relocate VLCH and IDCH before LDCH to be consistent with TG, PL and FC and if decided not to use TPCH and TPTG
tdf <- tdf %>%
  relocate(c("VLCH", "IDCH"), .before = "LDCH") %>% select(-c(TPCH, TPTG))

tdf$BMI_cat<- factor(BHA_Anno$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))

tdf <- tdf %>% mutate(BMI_cat = recode(BMI_cat, Healthy = "<25", OverWeight = "25-30", Obese = ">30"))

p1 <- list()
# Loop over each lipid class in lipo_name
for (l in lipo_name) {
  # If the current class is "A1|A2|AB", use grep to match the specific pattern
  if (l == "A1|A2|AB") {
    selected_vars <- grep("A1|A2|AB", colnames(tdf), value = TRUE)
  } else {
    # Otherwise, use contains to match the general classes (e.g., "CH", "TG", etc.)
    selected_vars <- grep(l, colnames(tdf), value = TRUE)
  }

  # Filter the data for 'Healthy' BMI_cat and select the appropriate columns
  tdf1 <- data.frame(
    Group1 = apply(na.omit(
      tdf %>%
        dplyr::filter(BMI_cat == "<25") %>%
        select(all_of(selected_vars))
    ), 2, median),
    Group2 = apply(na.omit(
        tdf %>% 
          dplyr::filter(BMI_cat == "25-30") %>% 
          select(all_of(selected_vars))
      ), 2, median),
    Group3 = apply(na.omit(
       tdf %>% 
         dplyr::filter(BMI_cat == ">30") %>% 
         select(all_of(selected_vars))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
    
  tdf1 <- data.frame(t(tdf1))
  
  tdf1 <- tdf1 %>% tibble::rownames_to_column(var = "BMI")
  
  tdf1$BMI <- recode(tdf1[[1]], Group1 = "<25", Group2 = "25-30", Group3 = ">30")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values = c("<25" = "#00BFC4", "25-30" = "#FFC425", ">30" = "#F8766D")) +  
     geom_line(size=0.6) + theme(
      axis.text = element_text(size = 14),           # Increase axis text size
      axis.title = element_text(size = 20),          # Increase axis title size
      axis.line = element_line(size = 0.6),
      axis.text.x = element_text(hjust = 1, angle = 90),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
     )
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  #rm(tdf1,j,l,lipo_name, selected_vars)
}

library(gridExtra)

pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"


# svglite::svglite(filename = file.path(pathToPlot,"RadarPlotBusselton.svg"))
ggarrange(p1[[1]], p1[[4]], p1[[3]], p1[[2]], nrow=4)
# dev.off()
# 
svglite::svglite(filename = file.path(pathToPlot,"RadarPlotBusseltonLegendv2.svg"))
plot(p1_legend)
dev.off()

library(cowplot)

# Extract the legend from one indiv plot
p1_legend <- get_legend(p)  

# Remove the title and legend from individual plots
p1_no_title <- lapply(p1, function(p) p + theme(legend.position = "none", plot.title = element_blank()))

# Arrange the plots with the legend to the right
final_plot <- grid.arrange(
  ggarrange(plotlist = p1_no_title, nrow = 4),  # Subplots without titles and legends
  p1_legend,  # Common legend on the right
  ncol = 2,  # Use 2 columns: one for plots and one for the legend
  widths = c(3, 0.5)  # Adjust the relative width of the plot and legend
)

#annotate_figure(final_plot, top = text_grob("Busselton", color = "black", face = "bold", size = 15))

svglite::svglite(filename = file.path(pathToPlot,"RadarPlotBusselton_wLegendv6.svg"))
final_plot <- grid.arrange(
  ggarrange(plotlist = p1_no_title, nrow = 4),  # Subplots without titles and legends
  p1_legend,  # Common legend on the right
  ncol = 2,  # Use 2 columns: one for plots and one for the legend
  widths = c(3, 0.5)  # Adjust the relative width of the plot and legend
)
dev.off()
#rm(tdf, p, p1_legend, p1, p1_no_title, final_plot)

```



# Fig2. Line chart -  Saudi
```{r, fig.width=20, fig.height=15}
library(GGally)
library(ggpubr)

#lipo_name<-c("CH","TG","PL","PN","FC","A1|A2|AB")
lipo_name<-c("CH","FC","PL", "TG")
tdf <- Dia_Lipo
#relocate VLCH and IDCH before LDCH to be consistent with TG, PL and FC. 
tdf <- tdf %>%
  relocate(c("VLCH", "IDCH"), .before = "LDCH") 
tdf <- tdf %>% select(-c(TPCH, TPTG)) # if decided not to use TPCH and TPTG
tdf$BMI_cat<- factor(Dia_Anno$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))
tdf <- tdf %>% mutate(BMI_cat = recode(BMI_cat, Healthy = "<25", OverWeight = "25-30", Obese = ">30"))

p1 <- list()
# Loop over each lipid class in lipo_name
for (l in lipo_name) {
  # If the current class is "A1|A2|AB", use grep to match the specific pattern
  if (l == "A1|A2|AB") {
    selected_vars <- grep("A1|A2|AB", colnames(tdf), value = TRUE)
  } else {
    # Otherwise, use contains to match the general classes (e.g., "CH", "TG", etc.)
    selected_vars <- grep(l, colnames(tdf), value = TRUE)
  }

    # Filter the data for 'Healthy' BMI_cat and select the appropriate columns
    tdf1 <- data.frame(
    Group1 = apply(na.omit(
      tdf %>%
        dplyr::filter(BMI_cat == "<25") %>%
        select(all_of(selected_vars))
    ), 2, median),
    Group2 = apply(na.omit(
        tdf %>% 
          dplyr::filter(BMI_cat == "25-30") %>% 
          select(all_of(selected_vars))
      ), 2, median),
    Group3 = apply(na.omit(
       tdf %>% 
         dplyr::filter(BMI_cat == ">30") %>% 
         select(all_of(selected_vars))
      ), 2, median)
    )
  
  # re-scale # if using this, make sure to set ggparcoord scale = "globalminmax" so not to double scale
  for (j in 1:nrow(tdf1)) {
    tdf1[j, ] <- tdf1[j, ] / max(tdf1[j, ])
  }
    
  tdf1 <- data.frame(t(tdf1))
 
  tdf1 <- tdf1 %>% tibble::rownames_to_column(var = "BMI")
  
  tdf1$BMI <- recode(tdf1[[1]], Group1 = "<25", Group2 = "25-30", Group3 = ">30")
  
  p<-ggparcoord(tdf1,
    columns = 2:ncol(tdf1), groupColumn = 1, scale = "globalminmax",
    showPoints = TRUE, 
    alphaLines = 0.3
    ) + xlab("") + ylab("") +
    scale_color_manual(values = c("<25" = "#00BFC4", "25-30" = "#FFC425", ">30" = "#F8766D")) +  
     geom_line(size=0.6) + theme(
      axis.text = element_text(size = 14),           # Increase axis text size
      axis.title = element_text(size = 20),          # Increase axis title size
      axis.line = element_line(size = 0.6),
      axis.text.x = element_text(hjust = 1, angle = 90),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
     )
  p1_legend<-get_legend(p)    
  p1_legend<-as_ggplot(p1_legend)   
  p1[[l]]<-p+theme(legend.position = "none")

  #rm(tdf1,j,l,lipo_name, selected_vars)
}
  

library(gridExtra)

pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
          
          
#svglite::svglite(filename = file.path(pathToPlot,"RadarPlotSaudi.svg"))
#ggarrange(p1[[1]], p1[[2]], p1[[3]], p1[[4]], nrow=4)
#dev.off()

svglite::svglite(filename = file.path(pathToPlot,"RadarPlotSaudiLegendv2.svg"))
plot(p1_legend)
dev.off()


library(cowplot)

# Extract the legend from one indiv plot
p1_legend <- get_legend(p)  

# Remove the title and legend from individual plots
p1_no_title <- lapply(p1, function(p) p + theme(legend.position = "none", plot.title = element_blank()))

# Arrange the plots with the legend to the right
final_plot <- grid.arrange(
  ggarrange(plotlist = p1_no_title, nrow = 4),  # Subplots without titles and legends
  p1_legend,  # Common legend on the right
  ncol = 2,  # Use 2 columns: one for plots and one for the legend
  widths = c(3, 0.5)  # Adjust the relative width of the plot and legend
)


#annotate_figure(final_plot, top = text_grob("Saudi", color = "black", face = "bold", size = 15))

svglite::svglite(filename = file.path(pathToPlot,"RadarPlotSaudi_wLegendv6.svg"))
final_plot <- grid.arrange(
  ggarrange(plotlist = p1_no_title, nrow = 4),  # Subplots without titles and legends
  p1_legend,  # Common legend on the right
  ncol = 2,  # Use 2 columns: one for plots and one for the legend
  widths = c(3, 0.5)  # Adjust the relative width of the plot and legend
)

dev.off()

#rm(tdf, p, p1_legend, p1, p1_no_title, final_plot)
```


# Line chart with Density as x-axis - JW's request
##Busselton
```{r, eval = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)

# Lipoprotein density as x-axis 
x_axis_values <- c(0.978, 1.013, 1.360, 1.137, 1.025, 1.033, 1.036, 1.039, 1.042, 1.054, 1.082, 1.113, 1.150, 1.193)

# Create new df with new x-axis
data <- data.frame(
  x = x_axis_values,
  HealthyWeight = c(0.600, 0.641, 1.000, 1.000, 1.000, 1.000, 1.000, 0.969, 0.847, 0.932, 1.000, 1.000, 1.000, 0.965),
  OverWeight = c(0.885, 0.902, 0.990, 0.796, 0.948, 0.802, 0.874, 1.000, 1.000, 1.000, 0.617, 0.789, 0.923, 1.000),
  Obese = c(1.000, 1.000, 0.958, 0.730, 0.891, 0.748, 0.779, 0.995, 0.980, 0.959, 0.522, 0.714, 0.855, 0.945)
)

# Reshape data to long format
long_data <- data %>%
  pivot_longer(-x, names_to = "Group", values_to = "Value")

# Create the plot
ggplot(long_data, aes(x = x, y = Value, color = Group)) +
  geom_line(aes(group = Group)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = x_axis_values) +  # Use density as x-axis values 
  labs(x = "Density", y = "Value", color = "Group") + 
  ggtitle("Busselton")

```


## Saudi
```{r, eval = FALSE}
# Lipoprotein density as x-axis 
x_axis_values <- c(0.978, 1.013, 1.360, 1.137, 1.025, 1.033, 1.036, 1.039, 1.042, 1.054, 1.082, 1.113, 1.150, 1.193)

# Create new df fwith new x-axis
data <- data.frame(
  x = x_axis_values,
  HealthyWeight = c(0.740,	0.697,	1.000,	1.000	,1.000,	1.000,	1.000,	0.939	,0.795,	0.911	,1.000,	1.000,	1.000	,0.970),
  OverWeight = c(0.952,	0.932,	0.976,	0.758,	0.857,	0.813,	0.838,	0.988,	0.970,	0.962,	0.694,	0.803,	0.777,	0.952),
  Obese = c(1.000,	1.000,	0.950,	0.807,	0.941,	0.737,	0.831,	1.000,	1.000,	1.000,	0.646,	0.812,	0.840,	1.000)
)

# Reshape data to long format
long_data <- data %>%
  pivot_longer(-x, names_to = "Group", values_to = "Value")

# Create the plot
ggplot(long_data, aes(x = x, y = Value, color = Group)) +
  geom_line(aes(group = Group)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = x_axis_values) +  # Use density as x-axis values 
  labs(x = "Density", y = "Value", color = "Group") + 
  ggtitle("Saudi")


```


# Fig3. Bar charts - PN
```{r}
tdf1 <- BHA_Lipo
tdf1$BMI_cat<- BHA_Anno$BMI_cat 
tdf1$BMI_cat <- factor(tdf1$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))
tdf1$DM <- BHA_Anno$DM
tdf1$DM <- factor(tdf1$DM, levels = c("NDM", "DM"))
tdf1$cohort <- BHA_Anno$cohort

tdf2 <- Dia_Lipo
tdf2$BMI_cat<- Dia_Anno$BMI_cat
tdf2$BMI_cat <- factor(tdf2$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))
tdf2$DM <- Dia_Anno$DM
tdf2$DM <- factor(tdf2$DM, levels = c("NDM", "DM"))
tdf2$cohort <- Dia_Anno$cohort
tdf2$cohort[which(tdf2$cohort == "DiaObesity")] = "Saudi"

tdf <- rbind(tdf1, tdf2)

# creating Combination (Diabesity) category
tdf$comb <- gsub("\\s","", paste(tdf$BMI_cat,"_", tdf$DM))
tdf$comb[which(tdf$comb == "Healthy_NDM")] = "Hw_NDM"
tdf$comb[which(tdf$comb == "OverWeight_NDM")] = "Ow_NDM"
tdf$comb[which(tdf$comb == "Obese_NDM")] = "Ob_NDM"
tdf$comb[which(tdf$comb == "Healthy_DM")] = "Hw_DM"
tdf$comb[which(tdf$comb == "OverWeight_DM")] = "Ow_DM"
tdf$comb[which(tdf$comb == "Obese_DM")] = "Ob_DM"
  
tdf$comb <- factor(tdf$comb, levels = c("Hw_NDM", "Ow_NDM", "Ob_NDM", "Hw_DM", "Ow_DM", "Ob_DM"))

tdf$normL1PN <- tdf$L1PN/tdf$LDPN
tdf$normL2PN <- tdf$L2PN/tdf$LDPN
tdf$normL3PN <- tdf$L3PN/tdf$LDPN
tdf$normL4PN <- tdf$L4PN/tdf$LDPN
tdf$normL5PN <- tdf$L5PN/tdf$LDPN
tdf$normL6PN <- tdf$L6PN/tdf$LDPN

```

## Busselton
```{r}
summarised_data <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(med_LDPN = median(LDPN, na.rm = TRUE), med_VLPN = median(VLPN, na.rm=TRUE), 
            med_IDPN = median(IDPN, na.rm = TRUE), med_HDA1 = median(HDA1, na.rm = TRUE), 
            med_HDPL = median(HDPL, na.rm = TRUE), 
            total_LDPN = sum(LDPN, na.rm = TRUE), sample_size = n())  # Median VDPN, IDPN, LDPN, HDA1, HDPL and total LDPN for each category

# Set the order of comb factor levels
summarised_data$comb <- factor(summarised_data$comb, 
                             levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

table(tdf$comb)

#write.csv(summarised_data, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/PN.csv", row.names = F)

```

### a.VLPN
```{r}
# Create the bar chart for VLPN
a <-ggplot(summarised_data, aes(x = comb, y = med_VLPN)) +
  geom_bar(stat = "identity", fill = "steelblue2") +
  labs(x = "", y = "VLPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      # axis.text.y = element_blank(),
      # axis.ticks.y = element_blank(),
      # axis.text.x = element_blank(),
      # axis.ticks.x = element_blank(),
      strip.text = element_text(size = 10),
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_VLPN.svg"))
# a
# dev.off()

```


### b.IDPN
```{r}
# Create the bar chart for IDPN
b<-ggplot(summarised_data, aes(x = comb, y = med_IDPN)) +
  geom_bar(stat = "identity", fill = "steelblue3") +
  labs(x = "", y = "IDPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_IDPN.svg"))
# b
# dev.off()
```


### c.LDPN 
```{r}
# Create the bar chart for LDPN
c<-ggplot(summarised_data, aes(x = comb, y = med_LDPN)) +
  geom_bar(stat = "identity", fill = "dodgerblue2") +
  labs(x = "", y = "LDPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_LDPN.svg"))
# c
# dev.off()
```


### d.L1PN to L6PN
```{r}
#Calculate total for each LDL PN and sample size within each category
sample_counts <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(across(starts_with("norm") & ends_with("PN"), median, na.rm = TRUE), 
            sample_size = n())  # Count samples in each category

# renaming the normalisedPN columns for graphing purpose later
colnames(sample_counts) [2] <- "L1PN"
colnames(sample_counts) [3] <- "L2PN"
colnames(sample_counts) [4] <- "L3PN"
colnames(sample_counts) [5] <- "L4PN"
colnames(sample_counts) [6] <- "L5PN"
colnames(sample_counts) [7] <- "L6PN"

#write.csv(sample_counts, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/normL1_L6PN.csv", row.names = F)

# Reshape data to long format
long_data <- sample_counts %>%
  pivot_longer(cols = starts_with("L"), 
               names_to = "Variable", 
               values_to = "Median") 

# Set the order of comb factor levels
long_data$comb <- factor(long_data$comb, 
                          levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

```

```{r}
# Create the bar chart for the normalised PN to LDPN
d <- ggplot(long_data, aes(x = comb, y = Median, fill = Variable)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  labs(x = "", y = "PN", fill = "") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01), 
                     limits = c(0, 0.35)) +  # Adjust the limits here to be slightly above the max value
  scale_fill_manual(values = c("L1PN" = "lightblue1", "L2PN" = "lightskyblue1", "L3PN"= "lightskyblue", "L4PN" = "skyblue2", "L5PN" = "skyblue3", "L6PN" = "skyblue4")) + 
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.line = element_line(size = 0.3),
    panel.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_normL1_6.svg"))
# d
# dev.off()
```


```{r}
busplot <- ggarrange(a,b,c,d, nrow = 2,ncol=2)

pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"

# svglite::svglite(filename = file.path(pathToPlot,"BarCharts_PN_Busselton.svg"))
# busplot
# dev.off()


#rm(a,b,c,d,long_data, sample_counts, summarised_data)
```


### e.H1A1 to H4A1
```{r}
#Calculate total for each LDL PN and sample size within each category
sample_counts <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(across(starts_with("H") & ends_with("A1"), median, na.rm = TRUE), 
            sample_size = n())  # Count samples in each category

# Check sample counts
#print(sample_counts)

# Select only L1PN to L6PN
sample_counts <- sample_counts %>%
  select(comb, H1A1, H2A1, H3A1, H4A1, sample_size)

# Reshape data to long format
long_data <- sample_counts %>%
  pivot_longer(cols = starts_with("H"), 
               names_to = "Variable", 
               values_to = "Median") 

# Set the order of comb factor levels
long_data$comb <- factor(long_data$comb, 
                          levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

# Create the bar chart
e<-ggplot(long_data, aes(x = comb, y = Median, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "", y = "A1", fill = "") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +
  scale_fill_manual(values = c("H1A1" = "lightblue1", "H2A1" = "lightskyblue", "H3A1"= "skyblue2", "H4A1" = "skyblue4")) + # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    ) 

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_H1_4.svg"))
# e
# dev.off()
```


### f. HDA1 - A1 substitute for PN for HDL
```{r}
# Create the bar chart for HDA1
f<-ggplot(summarised_data, aes(x = comb, y = med_HDA1)) +
  geom_bar(stat = "identity", fill = "skyblue3") +
  labs(x = "", y = "HDA1") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_HDA1.svg"))
# f
# dev.off()
```


#### BUS - PN Significance test
```{r}
library(FSA) # For Dunn's test
library(purrr)  # For map functions

# Initialize a list to store the results
result_list <- list()

# Perform analysis for each variable
variable_names <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  #pivot_longer(cols = starts_with("L") & ends_with("PN"), names_to = "variable", values_to = "value") %>%
  pivot_longer(cols = matches("(A1|PN)$"), names_to = "variable", values_to = "value") %>%
  pull(variable) %>% unique()  # Get unique variable names

# Loop through each variable to perform Kruskal-Wallis and Dunn's test
for (var in variable_names) {
  # Filter data for the current variable
  current_data <- tdf %>%
    dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
    select(comb, !!sym(var)) %>%
    rename(value = !!sym(var))
  
  # Perform Kruskal-Wallis test
  kruskal_test_result <- kruskal.test(value ~ comb, data = current_data)
  
  # Create a result entry
  result_entry <- data.frame(variable = var, kruskal_pval = kruskal_test_result$p.value)
  
  # If significant, perform Dunn's test
  if (kruskal_test_result$p.value < 0.05) {
    dunn_result <- dunnTest(value ~ comb, data = current_data, method = "bonferroni")$res
    dunn_result <- dunn_result %>% as.data.frame()  # Convert Dunn's result to data frame
    
    # Add the dunn results to the entry
    result_entry <- bind_cols(result_entry, dunn_result)
  } else {
    # If not significant, fill with NA
    result_entry$Comparison <- NA
    result_entry$Z <- NA
    result_entry$P.unadj <- NA
    result_entry$P.adj <- NA
  }
  
  # Append the result entry to the result list
  result_list[[var]] <- result_entry
}

# Combine all results into a single data frame
final_results <- bind_rows(result_list)

# View the tidy results
print(final_results)

#Export to CSV
#write.csv(final_results, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Bus_PN_kruskal_dunn_resultsv2.csv", row.names = FALSE)

```



## Saudi
```{r}
summarised_data <- tdf %>%
  dplyr::filter(cohort == "Saudi" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(med_LDPN = median(LDPN, na.rm = TRUE), med_VLPN = median(VLPN, na.rm=TRUE), 
            med_IDPN = median(IDPN, na.rm = TRUE), sample_size = n())  # Median VDPN, IDPN, LDPN for each category

# Set the order of comb factor levels
summarised_data$comb <- factor(summarised_data$comb, 
                             levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

#write.csv(summarised_data, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/SAU_PN.csv", row.names = F)

```

### a.VLPN
```{r}
# Create the bar chart for VLPN
a <-ggplot(summarised_data, aes(x = comb, y = med_VLPN)) +
  geom_bar(stat = "identity", fill = "palegreen1") +
  labs(x = "", y = "VLPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsSau_VLPN.svg"))
# a
# dev.off()


```


### b.IDPN
```{r}
# Create the bar chart for IDPN
b<-ggplot(summarised_data, aes(x = comb, y = med_IDPN)) +
  geom_bar(stat = "identity", fill = "palegreen3") +
  labs(x = "", y = "IDPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsSau_IDPN.svg"))
# b
# dev.off()



```


### c.LDPN 
```{r}
# Create the bar chart for LDPN
c<-ggplot(summarised_data, aes(x = comb, y = med_LDPN)) +
  geom_bar(stat = "identity", fill = "seagreen3") +
  labs(x = "", y = "LDPN") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsSau_LDPN.svg"))
# c
# dev.off()

```


### d.L1PN to L6PN
```{r}
#Calculate total for each LDL PN and sample size within each category
sample_counts <- tdf %>%
  dplyr::filter(cohort == "Saudi", comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(across(starts_with("norm") & ends_with("PN"), median, na.rm = TRUE), 
            sample_size = n())  # Count samples in each category

# renaming the normalisedPN columns for graphing purpose later
colnames(sample_counts) [2] <- "L1PN"
colnames(sample_counts) [3] <- "L2PN"
colnames(sample_counts) [4] <- "L3PN"
colnames(sample_counts) [5] <- "L4PN"
colnames(sample_counts) [6] <- "L5PN"
colnames(sample_counts) [7] <- "L6PN"

#write.csv(sample_counts, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/normL1_L6PN_SAU.csv", row.names = F)

# Check sample counts
print(sample_counts)

# Select only L1PN to L6PN
# sample_counts <- sample_counts %>%
#   select(comb, L1PN, L2PN, L3PN, L4PN, L5PN, L6PN, sample_size)

# Reshape data to long format
long_data <- sample_counts %>%
  pivot_longer(cols = starts_with("L"), 
               names_to = "Variable", 
               values_to = "Median") 

# Set the order of comb factor levels
long_data$comb <- factor(long_data$comb, 
                          levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

```

```{r}
# Create the bar chart for the normalised PN to LDPN
d <- ggplot(long_data, aes(x = comb, y = Median, fill = Variable)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  labs(x = "", y = "PN", fill = "") + 
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01), 
                     limits = c(0, 0.30)) +  # Adjust the limits here to be slightly above the max value
  scale_fill_manual(values = c("L1PN" = "darkseagreen1", "L2PN" = "darkseagreen2", 
                               "L3PN" = "lightgreen", "L4PN" = "seagreen2", 
                               "L5PN" = "seagreen3", "L6PN" = "seagreen")) + 
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.line = element_line(size = 0.3),
    panel.background = element_rect(fill = "white", color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```



```{r}
sauplot <- ggarrange(a,b,c,d, nrow = 2,ncol=2)

pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"

svglite::svglite(filename = file.path(pathToPlot,"BarCharts_normPN_Saudi.svg"))
sauplot
dev.off()


rm(a,b,c,d,long_data, sample_counts, summarised_data,tdf1,tdf2)
```


### e.H1A1 to H4A1
```{r}
#Calculate total for each LDL PN and sample size within each category
sample_counts <- tdf %>%
  dplyr::filter(cohort == "Saudi" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  group_by(comb) %>%
  summarise(across(starts_with("H") & ends_with("A1"), median, na.rm = TRUE), 
            sample_size = n())  # Count samples in each category

# Check sample counts
#print(sample_counts)

# Select only L1PN to L6PN
sample_counts <- sample_counts %>%
  select(comb, H1A1, H2A1, H3A1, H4A1, sample_size)

# Reshape data to long format
long_data <- sample_counts %>%
  pivot_longer(cols = starts_with("H"), 
               names_to = "Variable", 
               values_to = "Median") 

# Set the order of comb factor levels
long_data$comb <- factor(long_data$comb, 
                          levels = c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"))

# Create the bar chart
e2<-ggplot(long_data, aes(x = comb, y = Median, fill = Variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "", y = "A1", fill = "") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +
  scale_fill_manual(values = c("H1A1" = "lightblue1", "H2A1" = "lightskyblue", "H3A1"= "skyblue2", "H4A1" = "skyblue4")) + # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    ) 

# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_H1_4.svg"))
# e
# dev.off()
```


### f. HDA1 - A1 substitute for PN for HDL
```{r}
# Create the bar chart for HDA1
f<-ggplot(summarised_data, aes(x = comb, y = med_HDA1)) +
  geom_bar(stat = "identity", fill = "skyblue3") +
  labs(x = "", y = "HDA1") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +  # Format y-axis labels
  theme(
      axis.text = element_text(size = 12),           # Increase axis text size
      axis.title = element_text(size = 12),          # Increase axis title size
      axis.line = element_line(size = 0.3),
      panel.background = element_rect(fill = "white", color = NA),  # Set background to white
      panel.grid.major = element_blank(),            # Remove major grid lines
      panel.grid.minor = element_blank()             # Remove minor grid lines
    )

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"PN_BarChartsBus_HDA1.svg"))
# f
# dev.off()
```

### SAU - PN Significance test
```{r}
library(FSA) # For Dunn's test
library(purrr)  # For map functions

# Initialize a list to store the results
result_list <- list()

# Perform analysis for each variable
variable_names <- tdf %>%
  dplyr::filter(cohort == "Saudi" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  #pivot_longer(cols = starts_with("L") & ends_with("PN"), names_to = "variable", values_to = "value") %>%
  pivot_longer(cols = ends_with("PN"), names_to = "variable", values_to = "value") %>%
  pull(variable) %>% unique()  # Get unique variable names

# Loop through each variable to perform Kruskal-Wallis and Dunn's test
for (var in variable_names) {
  # Filter data for the current variable
  current_data <- tdf %>%
    dplyr::filter(cohort == "Saudi" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
    select(comb, !!sym(var)) %>%
    rename(value = !!sym(var))
  
  # Perform Kruskal-Wallis test
  kruskal_test_result <- kruskal.test(value ~ comb, data = current_data)
  
  # Create a result entry
  result_entry <- data.frame(variable = var, kruskal_pval = kruskal_test_result$p.value)
  
  # If significant, perform Dunn's test
  if (kruskal_test_result$p.value < 0.05) {
    dunn_result <- dunnTest(value ~ comb, data = current_data, method = "bonferroni")$res
    dunn_result <- dunn_result %>% as.data.frame()  # Convert Dunn's result to data frame
    
    # Add the dunn results to the entry
    result_entry <- bind_cols(result_entry, dunn_result)
  } else {
    # If not significant, fill with NA
    result_entry$Comparison <- NA
    result_entry$Z <- NA
    result_entry$P.unadj <- NA
    result_entry$P.adj <- NA
  }
  
  # Append the result entry to the result list
  result_list[[var]] <- result_entry
}

# Combine all results into a single data frame
final_results <- bind_rows(result_list)

# View the tidy results
print(final_results)

# Export to CSV
#write.csv(final_results, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Sau_PN_kruskal_dunn_resultsv2.csv", row.names = FALSE)

```

# Indiv Lipo composition 
Calculating Lipo composition per each sub-fraction based on ratio, particle number explanation (Philipp) 
## LDLs
```{r}
tdf1 <- BHA_Lipo
tdf1$BMI_cat<- BHA_Anno$BMI_cat 
tdf1$BMI_cat <- factor(tdf1$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))
tdf1$DM <- BHA_Anno$DM
tdf1$DM <- factor(tdf1$DM, levels = c("NDM", "DM"))
tdf1$cohort <- BHA_Anno$cohort

tdf2 <- Dia_Lipo
tdf2$BMI_cat<- Dia_Anno$BMI_cat
tdf2$BMI_cat <- factor(tdf2$BMI_cat, levels = c("Healthy", "OverWeight", "Obese"))
tdf2$DM <- Dia_Anno$DM
tdf2$DM <- factor(tdf2$DM, levels = c("NDM", "DM"))
tdf2$cohort <- Dia_Anno$cohort
tdf2$cohort[which(tdf2$cohort == "DiaObesity")] = "Saudi"

tdf <- rbind(tdf1, tdf2)

#tdf <- tdf1
# creating Combination (Diabesity) category
tdf$comb <- gsub("\\s","", paste(tdf$BMI_cat,"_", tdf$DM))
tdf$comb[which(tdf$comb == "Healthy_NDM")] = "Hw_NDM"
tdf$comb[which(tdf$comb == "OverWeight_NDM")] = "Ow_NDM"
tdf$comb[which(tdf$comb == "Obese_NDM")] = "Ob_NDM"
tdf$comb[which(tdf$comb == "Healthy_DM")] = "Hw_DM"
tdf$comb[which(tdf$comb == "OverWeight_DM")] = "Ow_DM"
tdf$comb[which(tdf$comb == "Obese_DM")] = "Ob_DM"
  
tdf$comb <- factor(tdf$comb, levels = c("Hw_NDM", "Ow_NDM", "Ob_NDM", "Hw_DM", "Ow_DM", "Ob_DM"))

# Extract CE from total CH
tdf$L1CE <- tdf$L1CH - tdf$L1FC
tdf$L2CE <- tdf$L2CH - tdf$L2FC
tdf$L3CE <- tdf$L3CH - tdf$L3FC
tdf$L4CE <- tdf$L4CH - tdf$L4FC
tdf$L5CE <- tdf$L5CH - tdf$L5FC
tdf$L6CE <- tdf$L6CH - tdf$L6FC

# Extract CE from total CH
tdf$H1CE <- tdf$H1CH - tdf$H1FC
tdf$H2CE <- tdf$H2CH - tdf$H2FC
tdf$H3CE <- tdf$H3CH - tdf$H3FC
tdf$H4CE <- tdf$H4CH - tdf$H4FC

# Calculate total lipid for each level
tdf$L1TotLip <- rowSums(tdf[, c("L1TG", "L1FC", "L1CE", "L1PL")])
tdf$L2TotLip <- rowSums(tdf[, c("L2TG", "L2FC", "L2CE", "L2PL")])
tdf$L3TotLip <- rowSums(tdf[, c("L3TG", "L3FC", "L3CE", "L3PL")])
tdf$L4TotLip <- rowSums(tdf[, c("L4TG", "L4FC", "L4CE", "L4PL")])
tdf$L5TotLip <- rowSums(tdf[, c("L5TG", "L5FC", "L5CE", "L5PL")])
tdf$L6TotLip <- rowSums(tdf[, c("L6TG", "L6FC", "L6CE", "L6PL")])

tdf$H1TotLip <- rowSums(tdf[, c("H1TG", "H1FC", "H1CE", "H1PL")])
tdf$H2TotLip <- rowSums(tdf[, c("H2TG", "H2FC", "H2CE", "H2PL")])
tdf$H3TotLip <- rowSums(tdf[, c("H3TG", "H3FC", "H3CE", "H3PL")])
tdf$H4TotLip <- rowSums(tdf[, c("H4TG", "H4FC", "H4CE", "H4PL")])

# Calculate percentages for each lipid component at each level, Do CH not CE as you use CH and FC to make CE
lipos <- c("TG", "FC", "CE", "PL")

# Loop through levels for 'LDL' 
for (level in 1:6) {
  # Loop through each lipid
  for (lipo in lipos) {
    # Construct the column names for the LDLs
    column_name <- paste0("L", level, lipo, "%")
    total_column_name <- paste0("L", level, "TotLip")
    
    # Calculate the ratio and create the new column
    tdf[[column_name]] <- tdf[[paste0("L", level, lipo)]] / tdf[[total_column_name]]
  }
}

# Loop through levels for 'HDL' 
for (level in 1:4) {
  # Loop through each lipid
  for (lipo in lipos) {
    # Construct the column names for the HDLs
    column_name <- paste0("H", level, lipo, "%")
    total_column_name <- paste0("H", level, "TotLip")
    
    # Calculate the ratio and create the new column
    tdf[[column_name]] <- tdf[[paste0("H", level, lipo)]] / tdf[[total_column_name]]
  }
}
```


### LDL1-3 v LDL4-6
### Stacked bar graphs - adjusted for PN
```{r}
generate_split_bar_charts <- function(data, variable, selected_comb = NULL, particleNo = TRUE, ncol = 6, nrow = 1, page = 1) {
    # Modify the grep pattern to handle variables starting with prop_totL
    if (particleNo) {
        vars <- grep(pattern = paste0("^", variable, ".*[^BNH]"), x = names(data), value = TRUE)
    } else {
        vars <- grep(pattern = paste0("^", variable), x = names(data), value = TRUE)
    }

    if (length(vars) == 0) {
        stop("No matching variables found")
    }

    if (!all(c("cohort", "comb", vars) %in% names(data))) {
        stop("Required columns are missing in the data")
    }

    df <- data[, c("cohort", "comb", vars)]
    dF <- tidyr::pivot_longer(df, cols = vars, names_to = "name", values_to = "value")

    dF <- dF %>%
        dplyr::mutate(lipo_class = sub(".*(TG|PL|CE|FC).*", "\\1", name)) %>%
        dplyr::mutate(lipo_type = ifelse(grepl("totL1_3", name), "totL1_3", "totL4_6"))

    dF <- dF %>%
        dplyr::group_by(cohort, comb, lipo_class, lipo_type, name) %>%
        dplyr::summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")

    df_complete <- tidyr::complete(dF, cohort, comb, lipo_class, lipo_type, name, fill = list(avg = 0))

    # Normalize the proportions so they sum to 100 within each group
    df_normalized <- df_complete %>%
        dplyr::group_by(cohort, lipo_class, comb) %>%
        dplyr::mutate(total_avg = sum(avg, na.rm = TRUE),
                      normalized_avg = (avg / total_avg) * 100)  # Normalizing to make it a percentage

    if (!is.null(selected_comb)) {
        df_normalized <- df_normalized %>% dplyr::filter(comb %in% selected_comb)
    }

    # Filter for a specific lipo_class
    df_normalized <- df_normalized %>% dplyr::filter(lipo_class == "CE")

    # Define the desired order for fill_group (this now only affects the bar colors, not grouping)
    desired_order <- c("totL1_3 Hw_NDM", "totL1_3 Ob_NDM", "totL1_3 Hw_DM", "totL1_3 Ob_DM",
                       "totL4_6 Hw_NDM", "totL4_6 Ob_NDM", "totL4_6 Hw_DM", "totL4_6 Ob_DM")

    df_normalized <- df_normalized %>%
        ungroup() %>%
        mutate(fill_group = factor(paste(lipo_type, comb, sep = " "), levels = desired_order))

    # Define colors and patterns
    comb_colors <- c("totL1_3" = "skyblue", "totL4_6" = "orange")
    summary(df_normalized$normalized_avg)

    # Create the bar chart with stacked bars
    bar_chart <- ggplot(df_normalized, aes(x = comb, y = normalized_avg, fill = lipo_type)) +
        geom_bar(stat = "identity", position = "stack", width = 0.8, color = "black") +  # Stack bars for prop_totL1_3 and prop_totL4_6
        geom_text(aes(label = ifelse(normalized_avg > 0.01, paste0(round(normalized_avg, 1), "%"), "")),  # Correct percentage label
                  position = position_stack(vjust = 0.5), color = "black", size = 3) +
        scale_fill_manual(values = comb_colors) +
        theme_minimal() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              legend.position = "right",
              strip.placement = "outside",
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              strip.text = element_text(size = 10),
              axis.text.x = element_text(hjust = 1, angle = 45),
              axis.ticks.x = element_blank(),
              strip.background = element_rect(fill = "white", color = "white", linewidth = 0),
              panel.spacing = element_blank(),
              panel.border = element_rect(color = "white", fill = NA, linewidth = 0)) +
        ggforce::facet_wrap_paginate(cohort ~ lipo_class, nrow = 1, ncol = 1, page = page) +
        labs(x = "BMI Category (comb)", y = "Proportion", fill = "Lipo Type")

    return(bar_chart)
}

```


```{r}

```


```{r}
CE <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

CE

FC <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

FC

PL <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

PL

TG <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

TG

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsBus_adjTG.svg"))
# TG
# dev.off()

```


## HDL
### Adjusted for PN -  trying different thing - 18/10/2024
```{r}
tdf$totH1_3TG <- rowSums(tdf[, c("H1TG%", "H2TG%", "H3TG%")])
tdf$totH1_3FC <- rowSums(tdf[, c("H1FC%", "H2FC%", "H3FC%")])
tdf$totH1_3CE <- rowSums(tdf[, c("H1CE%", "H2CE%", "H3CE%")])
tdf$totH1_3PL <- rowSums(tdf[, c("H1PL%", "H2PL%", "H3PL%")])

tdf$totH4TG <- tdf[, "H4TG%"]
tdf$totH4FC <- tdf[, "H4FC%"]
tdf$totH4CE <- tdf[, "H4CE%"]
tdf$totH4PL <- tdf[, "H4PL%"]

```



```{r}
generate_split_bar_charts <- function(data, variable, selected_comb = NULL, particleNo = TRUE, ncol = 6, nrow = 1, page = 1) {
    # Modify the grep pattern to handle variables starting with prop_totL
    if (particleNo) {
        vars <- grep(pattern = paste0("^", variable, ".*[^BNH]"), x = names(data), value = TRUE)
    } else {
        vars <- grep(pattern = paste0("^", variable), x = names(data), value = TRUE)
    }

    if (length(vars) == 0) {
        stop("No matching variables found")
    }

    if (!all(c("cohort", "comb", vars) %in% names(data))) {
        stop("Required columns are missing in the data")
    }

    df <- data[, c("cohort", "comb", vars)]
    dF <- tidyr::pivot_longer(df, cols = vars, names_to = "name", values_to = "value")

    dF <- dF %>%
        dplyr::mutate(lipo_class = sub(".*(TG|PL|CE|FC).*", "\\1", name)) %>%
        dplyr::mutate(lipo_type = ifelse(grepl("totH1_3", name), "totH1_3", "totH4"))

    dF <- dF %>%
        dplyr::group_by(cohort, comb, lipo_class, lipo_type, name) %>%
        dplyr::summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")

    df_complete <- tidyr::complete(dF, cohort, comb, lipo_class, lipo_type, name, fill = list(avg = 0))

    # Normalize the proportions so they sum to 100 within each group
    df_normalized <- df_complete %>%
        dplyr::group_by(cohort, lipo_class, comb) %>%
        dplyr::mutate(total_avg = sum(avg, na.rm = TRUE),
                      normalized_avg = (avg / total_avg) * 100)# Normalizing to make it a percentage

    if (!is.null(selected_comb)) {
        df_normalized <- df_normalized %>% dplyr::filter(comb %in% selected_comb)
    }

    # Filter for a specific lipo_class
    df_normalized <- df_normalized %>% dplyr::filter(lipo_class == "TG")

    # Define the desired order for fill_group (this now only affects the bar colors, not grouping)
    desired_order <- c("totH1_3 Hw_NDM", "totH1_3 Ob_NDM", "totH1_3 Hw_DM", "totH1_3 Ob_DM", "totH4 Hw_NDM", "totH4 Ob_NDM", "totH4 Hw_DM", "totH4 Ob_DM")

    df_normalized <- df_normalized %>%
        ungroup() %>%
        mutate(fill_group = factor(paste(lipo_type, comb, sep = " "), levels = desired_order))

    # Define colors and patterns
    comb_colors <- c("totH1_3" = "skyblue", "totH4" = "orange")

    # Create the bar chart with stacked bars
    bar_chart <- ggplot(df_normalized, aes(x = comb, y = normalized_avg, fill = lipo_type)) +
        geom_bar(stat = "identity", position = "stack", width = 0.8, color = "black") +  # Stack bars for prop_totH1_3 and prop_totH
        geom_text(aes(label = ifelse(normalized_avg > 0.01, paste0(round(normalized_avg,1), "%"), "")), 
                  position = position_stack(vjust = 0.5), color = "black", size = 3) +  
        scale_fill_manual(values = comb_colors) +
        theme_minimal() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              legend.position = "right",
              strip.placement = "outside",
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              strip.text = element_text(size = 10),
              axis.text.x = element_text(hjust = 1, angle = 45),
              axis.ticks.x = element_blank(),
              strip.background = element_rect(fill = "white", color = "white", linewidth = 0),
              panel.spacing = element_blank(),
              panel.border = element_rect(color = "white", fill = NA, linewidth = 0)) +
        ggforce::facet_wrap_paginate(cohort ~ lipo_class, nrow = 1, ncol = 1, page = page) +
        labs(x = "BMI Category (comb)", y = "Proportion", fill = "Lipo Type")

    return(bar_chart)
}

```



```{r}
CE <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totH", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

CE

FC<- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totH", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), particleNo = FALSE,ncol=4)

FC

PL<- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totH", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), particleNo = FALSE, ncol=4)

PL

TG<- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "totH", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), particleNo = FALSE, ncol=4)

TG

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# 
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsBusselton_HDL.svg"))
# combined_plot
# dev.off()

```








<!-- ## HDLs -->
<!-- H1_3 vs H4 concentration -->
<!-- ```{r} -->
<!-- tdf$totH1_3TG <- rowSums(tdf[, c("H1TG", "H2TG", "H3TG")])  -->
<!-- tdf$totH1_3FC <- rowSums(tdf[, c("H1FC", "H2FC", "H3FC")]) -->
<!-- tdf$totH1_3CE <- rowSums(tdf[, c("H1CE", "H2CE", "H3CE")]) -->
<!-- tdf$totH1_3PL <- rowSums(tdf[, c("H1PL", "H2PL", "H3PL")]) -->

<!-- tdf$totH4TG <- tdf$H4TG -->
<!-- tdf$totH4FC <- tdf$H4FC -->
<!-- tdf$totH4CE <- tdf$H4CE -->
<!-- tdf$totH4PL <- tdf$H4PL -->

<!-- ``` -->


# Fig3. L1_3 v L4_6 Bar charts
# Adjusted for PN 
## Busselton
```{r}
generate_split_bar_charts <- function(data, variable, selected_comb = NULL, particleNo = TRUE, ncol = 6, nrow = 1, page = 1) {
    # Modify the grep pattern to handle variables starting with prop_totL
    if (particleNo) {
        vars <- grep(pattern = paste0("^", variable, ".*[^BNH]"), x = names(data), value = TRUE)
    } else {
        vars <- grep(pattern = paste0("^", variable), x = names(data), value = TRUE)
    }

    if (length(vars) == 0) {
        stop("No matching variables found")
    }

    if (!all(c("cohort", "comb", vars) %in% names(data))) {
        stop("Required columns are missing in the data")
    }

    df <- data[, c("cohort", "comb", vars)]
    dF <- tidyr::pivot_longer(df, cols = vars, names_to = "name", values_to = "value")

    dF <- dF %>%
        dplyr::mutate(lipo_class = sub(".*(TG|PL|CE|FC).*", "\\1", name)) %>%
        dplyr::mutate(lipo_type = ifelse(grepl("prop_totL1_3", name), "prop_totL1_3", "prop_totL4_6"))

    dF <- dF %>%
        dplyr::group_by(cohort, comb, lipo_class, lipo_type, name) %>%
        dplyr::summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")

    df_complete <- tidyr::complete(dF, cohort, comb, lipo_class, lipo_type, name, fill = list(avg = 0))

    df_normalized <- df_complete %>%
        dplyr::group_by(cohort, lipo_class, comb) %>%  # Now grouping by cohort, lipo_class, and comb
        # dplyr::mutate(normalized_avg = avg / sum(avg, na.rm = TRUE))
      dplyr::mutate(normalized_avg = avg , na.rm = TRUE)

    if (!is.null(selected_comb)) {
        df_normalized <- df_normalized %>% dplyr::filter(comb %in% selected_comb)
    }

    # Filter for a specific lipo_class
    df_normalized <- df_normalized %>% dplyr::filter(lipo_class == "CE")

    # Define the desired order for fill_group (this now only affects the bar colors, not grouping)
    desired_order <- c("prop_totL1_3 Hw_NDM", "prop_totL1_3 Ob_NDM", "prop_totL1_3 Hw_DM", "prop_totL1_3 Ob_DM",
                       "prop_totL4_6 Hw_NDM", "prop_totL4_6 Ob_NDM", "prop_totL4_6 Hw_DM", "prop_totL4_6 Ob_DM")

    df_normalized <- df_normalized %>%
        ungroup() %>%
        mutate(fill_group = factor(paste(lipo_type, comb, sep = " "), levels = desired_order))

    # Define colors and patterns
    comb_colors <- c("prop_totL1_3" = "skyblue",
                     "prop_totL4_6" = "orange")

    # Create the bar chart with stacked bars
    bar_chart <- ggplot(df_normalized, aes(x = comb, y = normalized_avg, fill = lipo_type)) +
        geom_bar(stat = "identity", position = "stack", width = 0.8, color = "black") +  # Stack bars for prop_totL1_3 and prop_totL4_6
       geom_text(aes(label = ifelse(normalized_avg > 0.01, paste0(round(normalized_avg * 100, 2), "%"), "")), 
              position = position_stack(vjust = 0.5), color = "black", size = 3) +
        scale_fill_manual(values = comb_colors) +
        theme_minimal() +
        theme(panel.grid.major = element_blank(),
              legend.position = "right",
              strip.placement = "outside",
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              strip.text = element_text(size = 10),
              axis.text.x = element_text(hjust = 1, angle = 45),
              axis.ticks.x = element_blank(),
              strip.background = element_rect(fill = "white", color = "white", linewidth = 0),
              panel.spacing = element_blank(),
              panel.border = element_rect(color = "white", fill = NA, linewidth = 0)) +
        ggforce::facet_wrap_paginate(cohort ~ lipo_class, nrow = 1, ncol = 1, page = page) +
        labs(x = "BMI Category (comb)", y = "Proportion", fill = "Lipo Type")

    return(bar_chart)
}

```

### Stacked bar graphs
```{r}
CE <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "prop_totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

CE

FC <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "prop_totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

FC


PL <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "prop_totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

PL


TG <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Busselton"), variable = "prop_totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

TG


# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# 
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsBus_PL_adj_stacked.svg"))
# PL
# dev.off()

```

### Significance test 
#### Between LDLs
```{r}
library(FSA)  # For Dunn's test

kruskal_dunn_lipid_results <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  pivot_longer(cols = starts_with("prop_totL"), names_to = "variable", values_to = "value") %>%  # Adjust column selection to 'prop_totL'
  group_by(variable) %>%
  summarise(
    kruskal_pval = kruskal.test(value ~ comb)$p.value,
    dunn_test = list(
      if (kruskal.test(value ~ comb)$p.value < 0.05) {
        dunnTest(value ~ comb, method = "bonferroni")$res
      } else {
        NA
      }
    )
  )

# Unnest the Dunn's test results to make it tidy
tidy_dunn_results <- kruskal_dunn_lipid_results %>%
  dplyr::filter(!is.na(dunn_test)) %>%  # Remove rows where Dunn's test wasn't performed
  unnest(dunn_test) %>%                 # Unnest the Dunn test results
  select(variable, Comparison, Z, P.unadj, P.adj)  # Keep relevant columns

# View the tidy results
print(tidy_dunn_results)

```


#### Within LDLs
```{r}
library(FSA)  # For Dunn's test

# Perform Kruskal-Wallis test followed by Dunn's test for each lipid variable
kruskal_dunn_lipid_results <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  pivot_longer(cols = starts_with("totL"), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(
    kruskal_pval = kruskal.test(value ~ comb)$p.value,
    dunn_test = list(
      if(kruskal.test(value ~ comb)$p.value < 0.05) {
        dunnTest(value ~ comb, method = "bonferroni")$res
      } else {
        NA
      }
    )
  )

# Unnest the Dunn's test results to make it tidy
tidy_dunn_results <- kruskal_dunn_lipid_results %>%
  dplyr::filter(!is.na(dunn_test)) %>%  # Remove rows where Dunn's test wasn't performed
  unnest(dunn_test) %>%          # Unnest the Dunn test results
  select(variable, Comparison, Z, P.unadj, P.adj)  # Keep relevant columns

# # View the tidy results
print(tidy_dunn_results)
# 
# # Export the results to a CSV file
# write.csv(tidy_dunn_results, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Bus_kruskal_dunn_indivlipid_results.csv", row.names = FALSE)

```


#### Between and within LDLs but within comb
```{r}
library(dplyr)
library(tidyr)
library(FSA)  # For Dunn's test

# Filter the data and pivot it to compare L1_3 and L4_6
kruskal_dunn_lipid_results <- tdf %>%
  dplyr::filter(cohort == "Busselton" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  # Pivoting totL1_3 and totL4_6 columns to longer format
  pivot_longer(cols = c(totL1_3CE, totL4_6CE, totL1_3TG, totL4_6TG, 
                        totL1_3FC, totL4_6FC, totL1_3PL, totL4_6PL), 
               names_to = c("total_group", "lipid_class"), 
               names_pattern = "tot(L1_3|L4_6)(.*)", 
               values_to = "value") %>%
  # Group by comb (group) and lipid class (CE, TG, FC, PL)
  group_by(comb, lipid_class) %>%
  summarise(
    # Perform Kruskal-Wallis test if there are enough groups to compare
    kruskal_pval = if (length(unique(total_group)) > 1) {
      kruskal.test(value ~ total_group)$p.value
    } else {
      NA  # Not enough groups for Kruskal-Wallis test
    },
    # Perform Dunn's test if Kruskal-Wallis is significant
    dunn_test = list(
      if (!is.na(kruskal_pval) && kruskal_pval < 0.05) {
        dunnTest(value ~ total_group, method = "bonferroni")$res
      } else {
        NA  # Skip Dunn's test if Kruskal-Wallis is not significant or cannot be performed
      }
    ),
    .groups = 'drop'
  )

# Unnest the Dunn test results for easier viewing
kruskal_dunn_lipid_results_unnested <- kruskal_dunn_lipid_results %>%
  unnest(dunn_test)

# View the results
print(kruskal_dunn_lipid_results_unnested)




```


```{r}
generate_pie_chart2 <- function(data, variable, particleNo = TRUE, nrow = 4, ncol = 4, page = 1) {
  # Filter the data based on the selected variable
  if(particleNo == TRUE){
    vars <- grep(pattern = paste0(variable,".*[^BNH]"), 
                 x = names(data), 
                 value = TRUE)
  }
  
  df <- data[, c("sampleID", "cohort", "comb", vars)]

  # Pivot the data longer
  dF <- pivot_longer(data = df, cols = vars)

  # Summarize the data by sampleID
  dF <- group_by(dF, sampleID, name) %>%
    summarise(avg = mean(value), .groups = "drop")
  
  # Ensure all combinations of 'sampleID' and 'name' are present with zero values
  df <- tidyr::complete(dF, sampleID, name, fill = list(avg = 0))

  # Normalize the 'avg' values within each sampleID
  df <- df %>%
    group_by(sampleID) %>%
    mutate(normalized_avg = avg / sum(avg))  
  
  # Create the pie chart for each sampleID
  pie_chart <- ggplot(df, aes(x = "", y = normalized_avg, fill = name)) +
    geom_bar(stat = "identity", width = 1) +  # Create bars with identity stat and width 1
    coord_polar(theta = "y") +  # Convert to polar coordinates
    scale_fill_manual(values = c("red", "green", "blue", "pink")) +  # Customize colors
    theme_void() +  # Remove unnecessary elements
    theme(legend.position = "right", # Position legend
          strip.placement = "outside",
          strip.text = element_text(size = 12),
          strip.text.y = element_text(angle = 90),
          axis.text.y = element_text(hjust = 0),
          strip.background = element_rect(fill = "white", 
                                          color = "white"),
          panel.spacing = unit(0, "lines")) +
    ggforce::facet_wrap_paginate(~ sampleID, nrow = nrow, ncol = ncol, page = page) +
    geom_text(aes(label = round(avg, digits = 2)), 
              position = position_stack(vjust = 0.5)) +
    labs(fill = NULL)
  
  return(pie_chart)
}

```

```{r}
for (page_num in 1:9) {
  pie_chart <- generate_pie_chart2(abemMAU, "totL1_3", particleNo = TRUE, nrow = 4, ncol = 4, page = page_num)
  print(pie_chart)
}
```


```{r}
library(patchwork)


# Assuming 'SampleID' is the column that identifies each sample
sample_ids <- unique(abemMAU$sampleID)

# Set the number of plots per page
plots_per_page <- 9  # e.g., 3x3 grid

# Initialize an empty list to store plots
plot_list <- list()

# Loop through each sample and create a pie chart for each
for (i in seq_along(sample_ids)) {
  
  sample_id <- sample_ids[i]
  
  # Filter the data for the current sample
  sample_data <- abemMAU %>% filter(sampleID == sample_id)
  
  # Create the pie chart
  p <- ggplot(sample_data, aes(x = "", y = totL1_3PL/totL4_6PL, fill = BMI.weight)) +
    geom_bar(width = 1, stat = "identity") +
    coord_polar(theta = "y") +
    labs(title = paste("Sample:", sample_id)) +
    theme_void() +
    theme(legend.position = "none")
  
  plot_list[[length(plot_list) + 1]] <- p
  
  # Every time we hit the `plots_per_page` threshold or the last plot,
  # arrange them on a page and save the page.
  if (i %% plots_per_page == 0 || i == length(sample_ids)) {
    
    # Combine plots into a grid and save them to a file
    combined_plot <- wrap_plots(plot_list, ncol = 3)
    
    # Save the combined plot to a file
    ggsave(filename = paste0("Combined_Plots_1_3PL_Page_", ceiling(i / plots_per_page), ".png"),
           plot = combined_plot, width = 10, height = 10)
    
    # Clear the plot list for the next set of plots
    plot_list <- list()
  }
}



```


## Saudi
```{r, eval=FALSE}
tdf$totL1_3TG <- rowSums(tdf[, c("L1TG%", "L2TG%", "L3TG%")])
tdf$totL1_3FC <- rowSums(tdf[, c("L1FC%", "L2FC%", "L3FC%")])
tdf$totL1_3CE <- rowSums(tdf[, c("L1CE%", "L2CE%", "L3CE%")])
tdf$totL1_3PL <- rowSums(tdf[, c("L1PL%", "L2PL%", "L3PL%")])

tdf$totL4_6TG <- rowSums(tdf[, c("L4TG%", "L5TG%", "L6TG%")])
tdf$totL4_6FC <- rowSums(tdf[, c("L4FC%", "L5FC%", "L6FC%")])
tdf$totL4_6CE <- rowSums(tdf[, c("L4CE%", "L5CE%", "L6CE%")])
tdf$totL4_6PL <- rowSums(tdf[, c("L4PL%", "L5PL%", "L6PL%")])

```

### Stacked bar graphs
```{r}
generate_split_bar_charts <- function(data, variable, selected_comb = NULL, particleNo = TRUE, ncol = 6, nrow = 1, page = 1) {
    # Modify the grep pattern to handle variables starting with prop_totL
    if (particleNo) {
        vars <- grep(pattern = paste0("^", variable, ".*[^BNH]"), x = names(data), value = TRUE)
    } else {
        vars <- grep(pattern = paste0("^", variable), x = names(data), value = TRUE)
    }

    if (length(vars) == 0) {
        stop("No matching variables found")
    }

    if (!all(c("cohort", "comb", vars) %in% names(data))) {
        stop("Required columns are missing in the data")
    }

    df <- data[, c("cohort", "comb", vars)]
    dF <- tidyr::pivot_longer(df, cols = vars, names_to = "name", values_to = "value")

    dF <- dF %>%
        dplyr::mutate(lipo_class = sub(".*(TG|PL|CE|FC).*", "\\1", name)) %>%
        dplyr::mutate(lipo_type = ifelse(grepl("totL1_3", name), "totL1_3", "totL4_6"))

    dF <- dF %>%
        dplyr::group_by(cohort, comb, lipo_class, lipo_type, name) %>%
        dplyr::summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")

    df_complete <- tidyr::complete(dF, cohort, comb, lipo_class, lipo_type, name, fill = list(avg = 0))

    # Normalize the proportions so they sum to 100 within each group
    df_normalized <- df_complete %>%
        dplyr::group_by(cohort, lipo_class, comb) %>%
        dplyr::mutate(total_avg = sum(avg, na.rm = TRUE),
                      normalized_avg = (avg / total_avg) * 100)  # Normalizing to make it a percentage

    if (!is.null(selected_comb)) {
        df_normalized <- df_normalized %>% dplyr::filter(comb %in% selected_comb)
    }

    # Filter for a specific lipo_class
    df_normalized <- df_normalized %>% dplyr::filter(lipo_class == "PL")

    # Define the desired order for fill_group (this now only affects the bar colors, not grouping)
    desired_order <- c("totL1_3 Hw_NDM", "totL1_3 Ob_NDM", "totL1_3 Hw_DM", "totL1_3 Ob_DM",
                       "totL4_6 Hw_NDM", "totL4_6 Ob_NDM", "totL4_6 Hw_DM", "totL4_6 Ob_DM")

    df_normalized <- df_normalized %>%
        ungroup() %>%
        mutate(fill_group = factor(paste(lipo_type, comb, sep = " "), levels = desired_order))

    # Define colors and patterns
    comb_colors <- c("totL1_3" = "skyblue", "totL4_6" = "orange")
    summary(df_normalized$normalized_avg)

    # Create the bar chart with stacked bars
    bar_chart <- ggplot(df_normalized, aes(x = comb, y = normalized_avg, fill = lipo_type)) +
        geom_bar(stat = "identity", position = "stack", width = 0.8, color = "black") +  # Stack bars for prop_totL1_3 and prop_totL4_6
        geom_text(aes(label = ifelse(normalized_avg > 0.01, paste0(round(normalized_avg, 1), "%"), "")),  # Correct percentage label
                  position = position_stack(vjust = 0.5), color = "black", size = 3) +
        scale_fill_manual(values = comb_colors) +
        theme_minimal() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              legend.position = "right",
              strip.placement = "outside",
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              strip.text = element_text(size = 10),
              axis.text.x = element_text(hjust = 1, angle = 45),
              axis.ticks.x = element_blank(),
              strip.background = element_rect(fill = "white", color = "white", linewidth = 0),
              panel.spacing = element_blank(),
              panel.border = element_rect(color = "white", fill = NA, linewidth = 0)) +
        ggforce::facet_wrap_paginate(cohort ~ lipo_class, nrow = 1, ncol = 1, page = page) +
        labs(x = "BMI Category (comb)", y = "Proportion", fill = "Lipo Type")

    return(bar_chart)
}

```


```{r}
CE <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Saudi"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

CE

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsSau_adjCE.svg"))
# CE
# dev.off()

FC <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Saudi"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

FC

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsSau_adjFC.svg"))
# FC
# dev.off()

PL <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Saudi"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

PL

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsSau_adjPL.svg"))
# PL
# dev.off()


TG <- generate_split_bar_charts(data = tdf%>%dplyr::filter(cohort == "Saudi"), variable = "totL", selected_comb =  c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM"), ncol=4)

TG

# pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"
# svglite::svglite(filename = file.path(pathToPlot,"BarChartsSau_adjTG.svg"))
# TG
# dev.off()


```

### Significance test
```{r}
library(FSA)  # For Dunn's test

# Perform Kruskal-Wallis test followed by Dunn's test for each lipid variable
kruskal_dunn_lipid_results <- tdf %>%
  dplyr::filter(cohort == "Saudi" & comb %in% c("Hw_NDM", "Ob_NDM", "Hw_DM", "Ob_DM")) %>%
  pivot_longer(cols = starts_with("totL"), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(
    kruskal_pval = kruskal.test(value ~ comb)$p.value,
    dunn_test = list(
      if(kruskal.test(value ~ comb)$p.value < 0.05) {
        dunnTest(value ~ comb, method = "bonferroni")$res
      } else {
        NA
      }
    )
  )

# Unnest the Dunn's test results to make it tidy
tidy_dunn_results <- kruskal_dunn_lipid_results %>%
  dplyr::filter(!is.na(dunn_test)) %>%  # Remove rows where Dunn's test wasn't performed
  unnest(dunn_test) %>%          # Unnest the Dunn test results
  select(variable, Comparison, Z, P.unadj, P.adj)  # Keep relevant columns

# View the tidy results
print(tidy_dunn_results)

# Export the results to a CSV file
#write.csv(tidy_dunn_results, "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Sau_kruskal_dunn_indivlipid_results.csv", row.names = FALSE)

```


# Fig4. Split corrplot - LDL & HDL - BUS only (Saudi has no Glyc, SPC info)
## LDL reduced corrplot
```{r}
tdf<-cbind(BHA_Lipo%>%dplyr::select(L1CH:L6CH), BHA_SPC%>%dplyr::select(GlycB))

corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))


svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_LDL_Hw_reduced.svg"))
plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()
```


```{r}
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))


plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))


svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_LDL_Ob_reduced.svg"))
plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()
```



## LDL - full corrplot
```{r,fig.width=8,fig.height=8}
tdf<-cbind(BHA_Lipo%>%dplyr::select(L1TG:L6PL), BHA_SPC%>%dplyr::select(GlycB))

corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))

corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))


pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"


svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_LDL_Hw.svg"))
plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()

svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_LDL_Ob.svg"))
plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()
```


## HDL
```{r,fig.width=8,fig.height=8}
tdf<-cbind(BHA_Lipo%>%dplyr::select(H1TG:H4PL), BHA_SPC%>%dplyr::select(GlycB))

corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))

corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))


pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"


svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_HDL_Hw.svg"))
plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()

svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotBUS_HDL_Ob.svg"))
plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Busselton",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()

rm(corList)
```


# SuppMat Split correlation plot
## BHAS BMI(18.5-25.0] vs BMI(30>)
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
table(BHA_Anno$BMI_cat)
BHA_Lipo<-data.frame(BHA_Lipo)
tdf<-BHA_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese BHAS",
             c1Name = "Healthy",
             c2Name = "Obese"))

tdf<-cbind(BHA_Lipo%>%dplyr::select(TPTG:LDAB),BHA_SPC%>%dplyr::select(GlycA, GlycB))
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese BHAS",
             c1Name = "Healthy",
             c2Name = "Obese"))

```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese BHAS",
             c1Name = "Healthy",
             c2Name = "Obese"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese BHAS",
             c1Name = "Healthy",
             c2Name = "Obese"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese BHAS",
             c1Name = "Healthy",
             c2Name = "Obese"))
```


## BHAS BMI(18.5-25.0] NDM vs BMI(18.5-25.0] DM2
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
#table(BHA_Anno$DM, BHA_Anno$BMI_cat)
BHA_Lipo<-data.frame(BHA_Lipo)
tdf<-BHA_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM BHAS",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM BHAS",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM BHAS",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Healthy" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Healthy" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM BHAS",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```


## BHAS BMI(30>) NDM vs BMI(30>) DM2
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
#table(BHA_Anno$DM, BHA_Anno$BMI_cat)
BHA_Lipo<-data.frame(BHA_Lipo)
tdf<-BHA_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM BHAS",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))

tdf<-cbind(BHA_Lipo%>%dplyr::select(TPTG:LDAB), BHA_SPC%>%dplyr::select(GlycA, GlycB))
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "Obese NDM vs Obese DM BHAS",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```


### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM BHAS",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM BHAS",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-BHA_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[BHA_Anno$BMI_cat=="Obese" & BHA_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[BHA_Anno$BMI_cat=="Obese" &  BHA_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM BHAS",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```


## SAUDI BMI(18.5-25.0] vs BMI(30>)
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
table(Dia_Anno$BMI_cat)
tdf<-Dia_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese Saudi",
             c1Name = "Healthy",
             c2Name = "Obese"))
```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese Saudi",
             c1Name = "Healthy",
             c2Name = "Obese"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese Saudi",
             c1Name = "Healthy",
             c2Name = "Obese"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy vs Obese Saudi",
             c1Name = "Healthy",
             c2Name = "Obese"))
```


## SAUDI BMI(18.5-25.0] NDM vs BMI(18.5-25.0] DM2 
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
#table(Dia_Anno$DM, Dia_Anno$BMI_cat)
tdf<-Dia_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM Saudi",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM Saudi",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM Saudi",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Healthy NDM vs Healthy DM Saudi",
             c1Name = "Healthy_NDM",
             c2Name = "Healthy_DM"))

```



## SAUDI BMI(30>) NDM vs BMI(30>) DM2 
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
#table(Dia_Anno$DM, Dia_Anno$BMI_cat)
tdf<-Dia_Lipo%>%dplyr::select(TPTG:LDAB)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM Saudi",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(V1TG:V5PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM Saudi",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(L1TG:L6PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM Saudi",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))
```

# SuppMat - Saudi(no GlycB)
```{r,fig.width=8,fig.height=8}
tdf<-cbind(Dia_Lipo%>%dplyr::select(L1TG:L6PL), Dia_SPC%>%dplyr::select(GlycB))

corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Healthy" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Saudi",
             c1Name = "NDM",
             c2Name = "DM"))

corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese" &  Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Saudi",
             c1Name = "NDM",
             c2Name = "DM"))


pathToPlot = "/Users/novia/Desktop/Diabetes_Obesity/Busselton/Figures"


svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotSAU_Hw.svg"))
plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "NDM vs DM HealthyWeight Saudi",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()

svglite::svglite(filename = file.path(pathToPlot,"SplitCorrPlotSAU_Ob.svg"))
plotSplitCor(corList = corList,type = c("lower"),
             optns = list(plotTitle = "NDM vs DM Obese Saudi",
             c1Name = "NDM",
             c2Name = "DM"))
dev.off()


```


### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-Dia_Lipo%>%dplyr::select(H1TG:H4PL)
corList<-list(cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="NDM",],method = "spearman"),
              cor(tdf[Dia_Anno$BMI_cat=="Obese" & Dia_Anno$DM=="DM",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Obese NDM vs Obese DM Saudi",
             c1Name = "Obese_NDM",
             c2Name = "Obese_DM"))

```


## BHA vs SAUDI
### TPTG - LDAB
```{r,fig.width=8,fig.height=8}
tdf<-rbind(BHA_Lipo%>%dplyr::select(TPTG:LDAB),
           Dia_Lipo%>%dplyr::select(TPTG:LDAB))

anno<-rbind(BHA_Anno,Dia_Anno)
corList<-list(cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Healthy",
             c1Name = "Busselton",
             c2Name = "Saudi"))

corList<-list(cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi OverWeight",
             c1Name = "Busselton",
             c2Name = "Saudi"))


corList<-list(cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Obese",
             c1Name = "Busselton",
             c2Name = "Saudi"))
```

### V1TG - V5PL
```{r,fig.width=8,fig.height=8}
tdf<-rbind(BHA_Lipo%>%dplyr::select(V1TG:V5PL),
           Dia_Lipo%>%dplyr::select(V1TG:V5PL))

anno<-rbind(BHA_Anno,Dia_Anno)
corList<-list(cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Healthy",
             c1Name = "Busselton",
             c2Name = "Saudi"))

corList<-list(cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi OverWeight",
             c1Name = "Busselton",
             c2Name = "Saudi"))


corList<-list(cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Obese",
             c1Name = "Busselton",
             c2Name = "Saudi"))
```

### L1TG - L6PL
```{r,fig.width=8,fig.height=8}
tdf<-rbind(BHA_Lipo%>%dplyr::select(L1TG:L6PL),
           Dia_Lipo%>%dplyr::select(L1TG:L6PL))

anno<-rbind(BHA_Anno,Dia_Anno)
corList<-list(cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Healthy",
             c1Name = "Busselton",
             c2Name = "Saudi"))

corList<-list(cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi OverWeight",
             c1Name = "Busselton",
             c2Name = "Saudi"))


corList<-list(cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Obese",
             c1Name = "Busselton",
             c2Name = "Saudi"))
```

### H1TG - H4PL
```{r,fig.width=8,fig.height=8}
tdf<-rbind(BHA_Lipo%>%dplyr::select(H1TG:H4PL),
           Dia_Lipo%>%dplyr::select(H1TG:H4PL))

anno<-rbind(BHA_Anno,Dia_Anno)
corList<-list(cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Healthy" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Healthy",
             c1Name = "Busselton",
             c2Name = "Saudi"))

corList<-list(cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="OverWeight" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi OverWeight",
             c1Name = "Busselton",
             c2Name = "Saudi"))


corList<-list(cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="Busselton",],method = "spearman"),
              cor(tdf[anno$BMI_cat=="Obese" & anno$cohort=="DiaObesity",],method = "spearman"))

plotSplitCor(corList = corList,type = c("upper"),
             optns = list(plotTitle = "Busselton vs Saudi Obese",
             c1Name = "Busselton",
             c2Name = "Saudi"))
```



# Ratio Pie charts
## L1_3 vs L4_6PN
```{r}
tdf$totL1_3PN <- rowSums(tdf[, c("L1PN", "L2PN", "L3PN")])
tdf$totL4_6PN <- rowSums(tdf[, c("L4PN", "L5PN", "L6PN")])
tdf$L1_3L4_6PN <- tdf$totL1_3PN / tdf$totL4_6PN
```

Pie-chart for ONLY PN 
```{r}
generate_pie_chartPN <- function(data, variable1 = "totL1_3PN", variable2 = "totL4_6PN", ncol = 3, nrow = 4, page = 1) {
  
  # Ensure the required variables are present in the data
  if (!all(c("cohort", "comb", variable1, variable2) %in% names(data))) {
    stop("Required columns are missing in the data")
  }
  
  # Select only the necessary columns
  df <- data[, c("cohort", "comb", variable1, variable2)]
  
  # Pivot the data longer
  dF <- pivot_longer(data = df, cols = c(variable1, variable2), names_to = "name", values_to = "value")
  
  # Summarize the data by cohort, comb, and name
  dF <- dF %>%
    group_by(cohort, comb, name) %>%
    summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")
  
  # Ensure all combinations of 'cohort' and 'name' are present with zero values
  df_complete <- tidyr::complete(dF, cohort, comb, name, fill = list(avg = 0))
  
  # Normalize the 'avg' values within each cohort and comb
  df_normalized <- df_complete %>%
    group_by(cohort, comb) %>%
    mutate(normalized_avg = avg / sum(avg, na.rm = TRUE))  
  
  # Create the pie chart for each cohort and comb
  pie_chart <- ggplot(df_normalized, aes(x = "", y = normalized_avg, fill = name)) +
    geom_bar(stat = "identity", width = 1) +  # Create bars with identity stat and width 1
    coord_polar(theta = "y") +  # Convert to polar coordinates
    scale_fill_manual(values = c("orchid2", "turquoise3")) +  # Customize colors for the two variables
    theme_void() +  # Remove unnecessary elements
    theme(legend.position = "right", # Position legend
          strip.placement = "outside",
          strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = 90),
          axis.text.y = element_text(hjust = 0),
          strip.background = element_rect(fill = "white", color = "white"),
          panel.spacing = unit(0, "lines")) +
    ggforce::facet_wrap_paginate(cohort ~ comb, nrow = nrow, ncol = ncol, page = page) +
    geom_text(aes(label = scales::percent(normalized_avg, accuracy = 1)), 
              position = position_stack(vjust = 0.5), size = 3) +
    labs(fill = NULL)
  
  return(pie_chart)
}


```

```{r}
# Call the modified function
generate_pie_chartPN(tdf, variable1 = "totL1_3PN", variable2 = "totL4_6PN")

```


## H1_3 vs H4
```{r}
tdf$totH1_3TG <- rowSums(tdf[, c("H1TG", "H2TG", "H3TG")])
tdf$totH1_3FC <- rowSums(tdf[, c("H1FC", "H2FC", "H3FC")])
tdf$totH1_3CE <- rowSums(tdf[, c("H1CE", "H2CE", "H3CE")])
tdf$totH1_3PL <- rowSums(tdf[, c("H1PL", "H2PL", "H3PL")])

# tdf$H1_3H4TG <- tdf$totH1_3TG / tdf$H4TG
# tdf$H1_3H4FC <- tdf$totH1_3FC / tdf$H4FC
# tdf$H1_3H4CE <- tdf$totH1_3CE / tdf$H4CE
# tdf$H1_3H4PL <- tdf$totH1_3PL / tdf$H4PL

# adding a very small value to HDL4 as lots of them are 0 and pie-chart won't compute. 
tdf$H1_3H4TG <- tdf$totH1_3TG / (tdf$H4TG + 0.01)
tdf$H1_3H4FC <- tdf$totH1_3FC / (tdf$H4FC + 0.01)
tdf$H1_3H4CE <- tdf$totH1_3CE / (tdf$H4CE + 0.01)
tdf$H1_3H4PL <- tdf$totH1_3PL / (tdf$H4PL + 0.01)
```


```{r}
generate_pie_chartH <- function(data, variable, particleNo = TRUE, ncol = 3, nrow = 4, page = 1) {
 # Define the prefix for H1_3H4 variables
  prefix <- "H1_3H4"
  
  # Filter the data based on the selected prefix
  vars <- grep(pattern = paste0("^", prefix), x = names(data), value = TRUE)
  
  # Check if 'vars' is empty
  if (length(vars) == 0) {
    stop("No matching variables found")
  }
  
  # Ensure 'cohort', 'comb', and 'vars' are present in the data
  if (!all(c("cohort", "comb", vars) %in% names(data))) {
    stop("Required columns are missing in the data")
  }
  
  df <- data[, c("cohort", "comb", vars)]

  # Pivot the data longer
  dF <- pivot_longer(data = df, cols = vars, names_to = "name", values_to = "value")

  # Summarize the data by cohort and name
  dF <- dF %>%
    group_by(cohort, comb, name) %>%
    summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")
  
  # Ensure all combinations of 'cohort' and 'name' are present with zero values
  df_complete <- tidyr::complete(dF, cohort, comb, name, fill = list(avg = 0))

  # Normalize the 'avg' values within each cohort and comb
  df_normalized <- df_complete %>%
    group_by(cohort, comb) %>%
    mutate(normalized_avg = avg / sum(avg, na.rm = TRUE)) %>%
    drop_na(normalized_avg)  # Remove rows with NA values in normalized_avg
  
  # Create the pie chart for each cohort and comb
  pie_chart <- ggplot(df_normalized, aes(x = "", y = normalized_avg, fill = name)) +
    geom_bar(stat = "identity", width = 1) +  # Create bars with identity stat and width 1
    coord_polar(theta = "y") +  # Convert to polar coordinates
    scale_fill_manual(values = c("red", "green", "blue", "pink", "magenta")) +  # Customize colors
    theme_void() +  # Remove unnecessary elements
    theme(legend.position = "right", # Position legend
          strip.placement = "outside",
          strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = 90),
          axis.text.y = element_text(hjust = 0),
          strip.background = element_rect(fill = "white", color = "white"),
          panel.spacing = unit(0, "lines")) +
    ggforce::facet_wrap_paginate(cohort ~ comb, nrow = nrow, ncol = ncol, page = page) +
    geom_text(aes(label = scales::percent(normalized_avg, accuracy = 1)), 
              position = position_stack(vjust = 0.5), size = 3) +
    labs(fill = NULL)
  
  return(pie_chart)
}

```

```{r}
generate_pie_chartH(tdf, "H1_3H4")
```

## H1_3 v H4A1
```{r}
tdf$H1_3A1 <- rowSums(tdf[, c("H1A1", "H2A1", "H3A1")])

```


Pie-chart for ONLY A1 (substitute for PN in HDLs)
```{r}
generate_pie_chartA1 <- function(data, variable1 = "H1_3A1", variable2 = "H4A1", ncol = 3, nrow = 4, page = 1) {
  
  # Ensure the required variables are present in the data
  if (!all(c("cohort", "comb", variable1, variable2) %in% names(data))) {
    stop("Required columns are missing in the data")
  }
  
  # Select only the necessary columns
  df <- data[, c("cohort", "comb", variable1, variable2)]
  
  # Pivot the data longer
  dF <- pivot_longer(data = df, cols = c(variable1, variable2), names_to = "name", values_to = "value")
  
  # Summarize the data by cohort, comb, and name
  dF <- dF %>%
    group_by(cohort, comb, name) %>%
    summarise(avg = mean(value, na.rm = TRUE), .groups = "drop")
  
  # Ensure all combinations of 'cohort' and 'name' are present with zero values
  df_complete <- tidyr::complete(dF, cohort, comb, name, fill = list(avg = 0))
  
  # Normalize the 'avg' values within each cohort and comb
  df_normalized <- df_complete %>%
    group_by(cohort, comb) %>%
    mutate(normalized_avg = avg / sum(avg, na.rm = TRUE))  
  
  # Create the pie chart for each cohort and comb
  pie_chart <- ggplot(df_normalized, aes(x = "", y = normalized_avg, fill = name)) +
    geom_bar(stat = "identity", width = 1) +  # Create bars with identity stat and width 1
    coord_polar(theta = "y") +  # Convert to polar coordinates
    scale_fill_manual(values = c("orchid2", "turquoise3")) +  # Customize colors for the two variables
    theme_void() +  # Remove unnecessary elements
    theme(legend.position = "right", # Position legend
          strip.placement = "outside",
          strip.text = element_text(size = 10),
          strip.text.y = element_text(angle = 90),
          axis.text.y = element_text(hjust = 0),
          strip.background = element_rect(fill = "white", color = "white"),
          panel.spacing = unit(0, "lines")) +
    ggforce::facet_wrap_paginate(cohort ~ comb, nrow = nrow, ncol = ncol, page = page) +
    geom_text(aes(label = scales::percent(normalized_avg, accuracy = 1)), 
              position = position_stack(vjust = 0.5), size = 3) +
    labs(fill = NULL)
  
  return(pie_chart)
}


```

```{r}
# Call the modified function
generate_pie_chartA1(tdf, variable1 = "H1_3A1", variable2 = "H4A1")

```


# Subfraction Pie Chart
## Busselton cohort Only 
```{r}
### Group by DM or NDM
#lipoPieChart(BHA_Lipo,group = BHA_Anno$BMI_cat)

```

### Group by DM or NDM, subgroup by BMI cat - BETTER grouping. This is the one I use. 
```{r}

lipoPieChart(BHA_Lipo,cohort = BHA_Anno$DM,group = BHA_Anno$BMI_cat)

```


## Saudi cohort Only 
### Group by DM or NDM, subgroup by BMI cat - BETTER grouping. This is the one I use. 
```{r}

lipoPieChart(Dia_Lipo,cohort = Dia_Anno$DM,group = Dia_Anno$BMI_cat)

```